<!DOCTYPE html>
<html lang="en">
<head>
    
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- SEO Meta Tags -->
<meta name="description" content="Your description">
<meta name="author" content="Your name">

<!-- OG Meta Tags to improve the way the post looks when you share the page on Facebook, Twitter, LinkedIn -->
<meta property="og:site_name" content="" /> <!-- website name -->
<meta property="og:site" content="" /> <!-- website link -->
<meta property="og:title" content="" /> <!-- title shown in the actual shared post -->
<meta property="og:description" content="" /> <!-- description shown in the actual shared post -->
<meta property="og:image" content="" /> <!-- image link, make sure it's jpg -->
<meta property="og:url" content="" /> <!-- where do you want your post to link to -->
<meta name="twitter:card" content="summary_large_image"> <!-- to have large image post format in Twitter -->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta name="description" content="Building a Service Manager for Blazoir Components" >
<meta name="author" content="Shaun Curtis" >



<title>The Component Service Manager</title>


<!-- Custom fonts for this template-->
<link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet">

<!-- Custom styles for this template-->
<link href="/assets/css/sb-admin-2.css" rel="stylesheet" type="text/css">
<link href="/assets/css/site.css" rel="stylesheet" type="text/css">

<!-- Favicon  -->
<link rel="icon" href="/assets/images/favicon.png">


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
    <link rel="stylesheet" href="/assets/css/article.css" type="text/css">
</head>
<body id="page-top">
    <!--topbar-->
    <div id="topbar">
        
<!-- Topbar -->
<nav class="navbar navbar-expand navbar-light topbar mb-4 static-top">
    
<ul class="navbar-nav" >
<li class="nav-item" >
<a class="nav-link " href="/index.html" role="button"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Index</span>
</a>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="9462ba61-512e-4138-9a8c-04db57c82d8e" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Articles</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="9462ba61-512e-4138-9a8c-04db57c82d8e" >
<a class="dropdown-item" href="/articles/A-Flexible-App.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Creating a Dynamic Blazor App Component
</a>
<a class="dropdown-item" href="/articles/Async-Programming-in-DotNetCore.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Async Programming In Dotnetcore
</a>
<a class="dropdown-item" href="/articles/Blazor-AllinOne.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor All In One - Multi SPA Hosting
</a>
<a class="dropdown-item" href="/articles/Blazor-Async-Programming.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Async Programming
</a>
<a class="dropdown-item" href="/articles/Blazor-Brick-By-Brick.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Brick By Brick
</a>
<a class="dropdown-item" href="/articles/Blazor-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Components
</a>
<a class="dropdown-item" href="/articles/Blazor-CSS.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor CSS
</a>
<a class="dropdown-item" href="/articles/Blazor-DataList-Control.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Datalist Control
</a>
<a class="dropdown-item" href="/articles/Blazor-Form-Validation.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Form Validation
</a>
<a class="dropdown-item" href="/articles/Building-Blazor-List-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Blazor List Components and the Notification Pattern
</a>
<a class="dropdown-item" href="/articles/Building-Edit-Forms.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Edit Forms
</a>
<a class="dropdown-item" href="/articles/EditFormState.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor EditFormState Control
</a>
<a class="dropdown-item" href="/articles/Hydra.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Hydra
</a>
<a class="dropdown-item" href="/articles/Inline-Dialog.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor Inline Dialog Control
</a>
<a class="dropdown-item" href="/articles/Modal-Dialog.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Modal Dialog
</a>
<a class="dropdown-item" href="/articles/Policy-Based-Authorization.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Policy Base Authorization in Blazor
</a>
<a class="dropdown-item" href="/articles/ValidationFormState.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Validation Control
</a>
<a class="dropdown-item" href="/articles/XML-XSD-Serialization.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
XML XSD Serialization
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="79f58d39-1006-47a8-8d16-ac84a3d57c05" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Blazor Database Apps</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="79f58d39-1006-47a8-8d16-ac84a3d57c05" >
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-1.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 1
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 2
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-3.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 3
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-4.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 4
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-5.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 5
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-6.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 6
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/index.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building a Database Application in Blazor
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="3109c31b-24fd-4f24-bafb-14e7a5b81ea9" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Building Blazor Applications</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="3109c31b-24fd-4f24-bafb-14e7a5b81ea9" >
<a class="dropdown-item" href="/Building-Blazor-Applications/Blazor-Async-UI-Events.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Async UI Events
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Blazor-Bootstrap-Toaster.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Bootstrap Toaster
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Blazor-Services.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Services
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Building-A-Blazor-AutoComplete-Control.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Blazor Autocomplete Control
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Building-Wrapper-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Wrapper Components
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Component-Service-Manager.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Component Service Manager
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/DBContexts-In-Transient-Services.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Dbcontexts In Transient Services
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/DynamicCss.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Dynamic Stylesheets
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/For-ForEach-in-Blazor.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
For Foreach In Blazor
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Leaner-Meaner-Greener-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Leaner Meaner Greener Components
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Notification-Service-Pattern.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Notification Service Pattern
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Rethinking-The-Repository-Pattern.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Rethinking The Repository Pattern
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/The-Blazor-WASM-Hosted-Project.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor WASM Hosted Project
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Whats-Wrong-with-my-Component-Design.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Whats Wrong With My Component Design
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/The-Blazor-Component" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Blazor Applications\The Blazor Component
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="a857b38f-3bcf-41d6-b4e2-43e79a295638" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Design</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="a857b38f-3bcf-41d6-b4e2-43e79a295638" >
<a class="dropdown-item" href="/Design/Clean-Design-In-Blazor.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Clean Design Principles in Blazor Applications
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Clean Design Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-Solution-Structure.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Solution Structure in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-DataServices.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Data Services in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-UI.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The UI in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-Solution-Setup.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Solution Setup in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-Testing.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Testing in the Clean Design Blazor Template
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="ca2a1f59-7c98-431f-abc5-7b69badbd3c2" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Modern C#</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="ca2a1f59-7c98-431f-abc5-7b69badbd3c2" >
<a class="dropdown-item" href="/Modern-Coding-Patterns/Nullable-And-VS-2022.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Nullable And VS 2022
</a>
</div>
</li>
</ul>

    <div class="ms-5 me-5 ml-auto">
        <h1>Cold Elm Coders</h1>
    </div>
</nav>


    </div>
    <!--End topbar-->
    <!--Sidebar-->
    <div id="sidebar">
        
<div class="article-info p-2" Published: 23-12-2022 >
<div>Published: 23-12-2022</div>
<div>Last Updated: 23-12-2022</div>
<div>Author: Shaun Curtis</div>
</div>

        
<h4 class="p-2">Table of Contents</h4>
<ul class="TOC" >
<li class="TOC-item TOC-item-0" >
<a class="TOC-link" href="#">Top</a>
<ul class="TOC TOC-0" >
<li class="TOC-item TOC-item-1" >
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#introduction">Introduction</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#repo">Repo</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#component-design">Component Design</a>
<ul class="TOC TOC-2" >
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#a-di-service">A DI Service</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#a-cascaded-object">A Cascaded Object</a>
</li>
</ul>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#owningcomponentbase">OwningComponentBase</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#the-componentservicemanager">The ComponentServiceManager</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#the-detail">The Detail</a>
<ul class="TOC TOC-2" >
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#componentservice">ComponentService</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#componentservicemanager">ComponentServiceManager</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#componentservicemanagercascade">ComponentServiceManagerCascade</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
    <!--End Sidebar-->
    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <div id="article">
                    <!-- Article -->
                    
<!-- Header -->
<header class="ex-header-article">
    <div class="container">
        <div class="row pt-3 pb-3 border-bottom">
            <div class="col">
                
<h1>The Component Service Manager</h1>
<div>Building a Service Manager for Blazoir Components</div>

            </div> <!-- end of col -->
        </div> <!-- end of row -->
    </div> <!-- end of container -->
</header> <!-- end of ex-header -->
<!-- end of header -->


                    
<!-- Article Container -->
<div class="ex-basic-1 pt-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                

        <h2 id="introduction">Introduction</h2>
<p>This article covers the basic design of components that interact with data, normally through a data pipeline.  It discusses the various approaches to solving the shared data problem and describes a coding pattern to solve it.</p>
<h2 id="repo">Repo</h2>
<p>The repo and latest version of this article is here <a href="https://github.com/ShaunCurtis/Blazr.ComponentServiceManager">Blazr.ComponentServiceManager</a>.</p>
<h2 id="component-design">Component Design</h2>
<p>Apply good design practices to components, and you separate out the data management function from the display function.  A component such as <code>FetchData</code> in the demo project &quot;Fetches(Manages) the data AND displays it in a table&quot;.  There's an <strong>AND</strong> in there which is a very good indicator that <code>FetchData</code> has multiple concerns/responsibilities.  Apply the <em>Single Responsibilty Principle</em> and you have two classes:</p>
<ol>
<li><code>WeatherForcastListForm</code> - a component that displays a list of WeatherForecasts</li>
<li><code>WeatherForecastListDataManager</code> - an object that interfaces with the data pipeline to get a list of WeatherForecasts.</li>
</ol>
<p>We already have <code>WeatherForecastListForm</code>.  How do we construct <code>WeatherForecastListDataManager</code>?</p>
<p>Our choices:</p>
<h3 id="a-di-service">A DI Service</h3>
<p>Configure <code>WeatherForecastListDataManager</code> as a service.  <code>WeatherForecastDataService</code> can now be defined as an argument in the constructor and the DI container will automatically inject the relevant instance into our class.</p>
<p>Which service scope to use?</p>
<ol>
<li>
<p><strong>Scoped</strong>.  The design problem with using scoped is a mismatch between the service scope and the component scope.  So when you return to <code>WeatherForcastListForm</code>, <code>WeatherForecastListDataManager</code> may already contain a loaded dataset.  You need to manually refresh it every time.</p>
</li>
<li>
<p><strong>Transient</strong>.  This seems the best option.  However, there are many situations where you can't use a transient service: the object implements <code>IDisposable/IAsyncDisposable</code> and/or sub-components within the form need access to the same instance.</p>
</li>
</ol>
<h3 id="a-cascaded-object">A Cascaded Object</h3>
<p>Create a stand alone object instance and cascade it if sub-components need access to the instance.  This is the principle used by the Blazor <code>EditForm/EditContext</code>.   Unfortunately, there are issues and side effects.</p>
<ol>
<li>
<p>You are cascading an object.  The renderer can't detect changes in it, so re-renders all child components that use it every time it renders the parwnt.  It triggers <em>Render Cascades</em>.  With small render trees these are not perceptible.  However, you are burning a lot of CPU time doing nothing.</p>
</li>
<li>
<p>How do you &quot;inject&quot; other services into your object instance without manually loading them:  you defeat the objective of DI.</p>
</li>
</ol>
<h2 id="owningcomponentbase">OwningComponentBase</h2>
<p><code>OwningComponentBase</code> was designed for the purpose: provide component level scoped services.  <strong>BUT</strong>, it comes with a lot of baggage and some serious problems inherant in building a separate services container for the component.  No one seems to talk about it anymore.</p>
<p>The issues:</p>
<ol>
<li>You create a fully functional Scoped Service Container for just one service.</li>
<li>Consider the case where the service you are defining in <code>OwningComponentBase</code> has dependencies on other Scoped Services, AuthenticationService to pick a good example.  When your service is instantiated in the new container, new instances of the scoped dependancies are also created in the new container.  They are <em>Scoped</em> and it is a <em>Scoped</em> container.  Your service has a new instance of the <code>AuthenticationService</code>.  It's empty.  The instance you want is in the <code>SPA</code> scoped container, but that's not what you got.  There's no way that I know other than to do a lot of manual reconfiguring to solve this problem.</li>
</ol>
<p>In my view point 2 makes it unfit for purpose.  It took me a lot of time to work out why my component wasn't authorized.  <code>OwningComponentBase</code> got garbage collected!</p>
<h2 id="the-componentservicemanager">The ComponentServiceManager</h2>
<p>My solution is to use a service Manager, registered as a DI Service.  It manages DI created objects that are unique to each root component.</p>
<p>I'll demonstrate it in action first, then explain the code in detail.</p>
<p>My demo component data object is <code>TimeService</code>: a class with a single timestamp text string, an update method and an event raised when the timestamp is changed.</p>
<p>Register the Manager and the Component Context object in DI as scoped services:</p>
<pre><code class="language-csharp">builder.Services.AddScoped&lt;ComponentServiceManager&gt;();
builder.Services.AddScoped&lt;TimeService&gt;();
</code></pre>
<p>In the root component (I'm using <code>Index.razor</code> here) the component:</p>
<ol>
<li>Injects the <code>ComponentServiceManager</code>.</li>
<li>Creates a component Guid.</li>
<li>Gets the service instance from the Manager.</li>
<li>Wires up an event handler to the <code>TimeChanged</code> event on <code>TimeService</code></li>
<li>Implements <code>IDisposable</code> to remove it.</li>
</ol>
<p>In the Razor markup it:</p>
<ol>
<li>Wraps everything in a <code>ComponentServiceManagerCascade</code> component.</li>
<li>Sets the servie type on <code>ComponentServiceManagerCascade</code></li>
<li>Sets it's <code>ComponentId</code>.</li>
<li>Cascades the <code>TimeService</code> instance for <code>CostlyTimeStamp</code> to capture.</li>
</ol>
<pre><code class="language-csharp">@page <span class="hljs-string">&quot;/&quot;</span>
@implements IDisposable
&lt;PageTitle&gt;Index&lt;/PageTitle&gt;
&lt;ComponentServiceManagerCascade TService=<span class="hljs-string">&quot;TimeService&quot;</span> ComponentId=<span class="hljs-string">&quot;this.ComponentId&quot;</span>&gt;
    &lt;CascadingValue Value=<span class="hljs-string">&quot;this.timeService&quot;</span>&gt;

        &lt;h1&gt;Hello, world!&lt;/h1&gt;

        Welcome to your <span class="hljs-keyword">new</span> app.

        &lt;CostlyTimeStamp /&gt;

        &lt;TimeStamp /&gt;

        &lt;AdvancedTimeStamp /&gt;

        &lt;div&gt;
            &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;m-2 p-2&quot;</span>&gt;
                @timeService?.Message
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;m-2&quot;</span>&gt;
            &lt;button <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span> @onclick=Clicked&gt;Update&lt;/button&gt;
        &lt;/div&gt;

    &lt;/CascadingValue&gt;
&lt;/ComponentServiceManagerCascade&gt;

@code {
    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> ComponentServiceManager Manager { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">default</span>!;

    <span class="hljs-keyword">private</span> TimeService? timeService;
    <span class="hljs-keyword">private</span> Guid ComponentId = Guid.NewGuid();

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInitialized</span>()</span>
    {
        timeService = Manager.GetOrCreateService&lt;TimeService&gt;(ComponentId);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timeService <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">this</span>.timeService.TimeChanged += OnChanged;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timeService <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">this</span>.timeService.TimeChanged -= OnChanged;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnChanged</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? sender, EventArgs e</span>)</span>
        =&gt; <span class="hljs-keyword">this</span>.InvokeAsync(<span class="hljs-keyword">this</span>.StateHasChanged);

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Clicked</span>()</span>
      =&gt; timeService?.UpdateTime();
}
</code></pre>
<p>There are three <code>TimeStamp</code> components to demonstrate different effects.</p>
<ol>
<li><code>TimeStamp</code> captures the cascaded <code>ComponentId</code> but doesn't implement an event handler to update the UI when the Timestamp changes.</li>
<li><code>AdvancedTimeStamp</code> captures the cascaded <code>ComponentId</code> and implements an event handler to update the UI when the Timestamp changes.</li>
<li><code>CostlyTimeStamp</code> demonstrates the traditional approach, capturing the cascaded service object.  It doesn't implement an event handler to update the UI when the Timestamp changes.</li>
</ol>
<p><code>TimeStamp</code> and <code>AdvancedTimeStamp</code> inject the <code>ComponentServiceManager</code> and capture the cascaded <code>ComponentId</code> parameter.  They get the <code>TimeService</code> instance from the Manager.</p>
<p>The markup section displays the time stamp, a timestamp when <code>SetParametersAsync</code> was last called and provides a button to update the service.</p>
<p>This is <code>AdvancedTimeStampadvance</code>.</p>
<pre><code class="language-csharp">@implements IDisposable

&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;bg-light p-2 m-2&quot;</span>&gt;

    &lt;h3&gt;Advanced TimeStamp Component&lt;/h3&gt;

    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;m-2&quot;</span>&gt;
        &lt;button <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;btn btn-primary&quot;</span> @onclick=Clicked&gt;Update Timestamp&lt;/button&gt;
    &lt;/div&gt;

    &lt;div&gt;
        @(timeService?.Message ?? <span class="hljs-string">&quot;No message set.&quot;</span>)
    &lt;/div&gt;

    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;mt-2 bg-dark text-white&quot;</span>&gt;
        Parameters Set at at @this.ParametersChangedTimeStamp
    &lt;/div&gt;

&lt;/div&gt;

@code {
    [<span class="hljs-meta">CascadingParameter(Name = <span class="hljs-string">&quot;ComponentId&quot;</span>)</span>] <span class="hljs-keyword">private</span> Guid ComponentId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> ComponentServiceManager Manager { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">default</span>!;

    <span class="hljs-keyword">private</span> TimeService? timeService;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">string</span> ParametersChangedTimeStamp = <span class="hljs-string">&quot;Not Set&quot;</span>;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInitialized</span>()</span>
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.ComponentId != Guid.Empty)
            timeService = Manager.GetService&lt;TimeService&gt;(ComponentId);

        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timeService <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
            timeService.TimeChanged += <span class="hljs-keyword">this</span>.OnUpdate;
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnParametersSet</span>()</span>
    {
        Debug.WriteLine(<span class="hljs-string">&quot;AdvancedTimeStamp - Parameter Change&quot;</span>);
        <span class="hljs-keyword">this</span>.ParametersChangedTimeStamp = DateTime.Now.ToLongTimeString();
        <span class="hljs-keyword">base</span>.OnParametersSet();
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnUpdate</span>(<span class="hljs-params"><span class="hljs-built_in">object</span>? sender, EventArgs e</span>)</span>
        =&gt; InvokeAsync(<span class="hljs-keyword">this</span>.StateHasChanged);

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Clicked</span>()</span>
      =&gt; timeService?.UpdateTime();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timeService <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
            timeService.TimeChanged -= <span class="hljs-keyword">this</span>.OnUpdate;
    }
}
</code></pre>
<p>If you run this code:</p>
<p>Clicking the button on the root component causes <code>CostlyTimeStamp</code> to Render (and update) while <code>AdvancedTimeStamp</code> just updates.  <code>TimeStamp</code> only updates if it's own button is clicked.</p>
<p><code>CostlyTimeStamp</code> always updates because the root component calls <code>StateHasChanged</code> whenever a change event occurs and that cascades down because it's parameter is an object.  <code>TimeStamp</code> on the other hand doesn't render because <code>ComponentId</code> is a primitive type and the renderer can detect whether or not it has changed.</p>
<h2 id="the-detail">The Detail</h2>
<h3 id="componentservice">ComponentService</h3>
<p>A record to represent the component service.</p>
<pre><code class="language-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">ComponentService</span>(<span class="hljs-params">Guid ComponentId, <span class="hljs-built_in">object</span> ServiceInstance</span>)</span>;
</code></pre>
<h3 id="componentservicemanager">ComponentServiceManager</h3>
<p>The class:</p>
<ol>
<li>Implements both <code>IDisposable</code> and <code>IAsyncDisposable</code> because it needs to dispose objects that may implement either.</li>
<li>Defines the <code>IServiceProvider</code> in it's constructor.</li>
<li>Creates an internal list of registered service objects.</li>
<li>Creates <code>InstanceId</code> as a unique identifier used in debugging.</li>
<li><code>asyncdisposedValue</code> and <code>disposedValue</code> provide disposal control.</li>
<li><code>FindComponentService</code> defines the search Linq query for the service list.</li>
</ol>
<pre><code class="language-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ComponentServiceManager</span> : <span class="hljs-title">IDisposable</span>, <span class="hljs-title">IAsyncDisposable</span>
{
    <span class="hljs-keyword">private</span> IServiceProvider _serviceProvider;
    <span class="hljs-keyword">private</span> List&lt;ComponentService&gt; _componentServices = <span class="hljs-keyword">new</span> List&lt;ComponentService&gt;();
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> asyncdisposedValue;
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">bool</span> disposedValue;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> Guid InstanceId = Guid.NewGuid();

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ComponentServiceManager</span>(<span class="hljs-params">IServiceProvider serviceProvider</span>)</span>
    {
        Debug.WriteLine(<span class="hljs-string">$&quot;ComponentServiceManager - instance <span class="hljs-subst">{InstanceId}</span> created&quot;</span>);
        _serviceProvider = serviceProvider;
    }

    <span class="hljs-keyword">private</span> ComponentService? FindComponentService&lt;TService&gt;(Guid componentId)
        =&gt; _componentServices.SingleOrDefault(item =&gt; item.ComponentId == componentId &amp;&amp; item.ServiceInstance <span class="hljs-keyword">is</span> TService);
</code></pre>
<p><code>GetOrCreateService</code> checks if there's a service already registered against the Guid.  It creates a new instance using <code>ActivatorUtilities</code>.  This gets a new instance of the service, injecting the necessary dependancies from the service container and hands it over.  It ignores <code>IDisposable/IAsyncDisposable</code> i.e. it doesn't retain a reference to the instance to dispose it later.  It's basically a Transient provider, without the retained link to run disposal: disposal is your responsibility.</p>
<pre><code class="language-csharp">    <span class="hljs-keyword">public</span> TService? GetOrCreateService&lt;TService&gt;(Guid componentId)
    {
        <span class="hljs-keyword">var</span> result = getOrCreateService&lt;TService&gt;(componentId);

        <span class="hljs-keyword">return</span> result <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
            ? <span class="hljs-literal">default</span>(TService)
            : (TService)result;
    }

    <span class="hljs-keyword">private</span> TService? getOrCreateService&lt;TService&gt;(Guid componentId)
    {
        <span class="hljs-keyword">var</span> service = <span class="hljs-keyword">this</span>.FindComponentService&lt;TService&gt;(componentId);
        <span class="hljs-keyword">if</span> (service <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> (TService)service.ServiceInstance;

        <span class="hljs-keyword">var</span> newService = ActivatorUtilities.CreateInstance&lt;TService&gt;(_serviceProvider);

        <span class="hljs-keyword">if</span> (newService <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">default</span>(TService);

        _componentServices.Add(<span class="hljs-keyword">new</span> ComponentService(componentId, newService));

        <span class="hljs-keyword">return</span> newService;
    }
</code></pre>
<p><code>GetService</code> just gets the reigistered service if it exists from the internal collection.</p>
<pre><code class="language-csharp">    <span class="hljs-keyword">public</span> TService? GetService&lt;TService&gt;(Guid componentId)
    {
        <span class="hljs-keyword">var</span> result = getService&lt;TService&gt;(componentId);

        <span class="hljs-keyword">return</span> result <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
            ? <span class="hljs-literal">default</span>(TService)
            : (TService)result;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">bool</span> <span class="hljs-title">TryGetService</span>&lt;<span class="hljs-title">TService</span>&gt;(<span class="hljs-params">Guid componentId, [NotNullWhen(<span class="hljs-literal">true</span></span>)] <span class="hljs-keyword">out</span> TService? <span class="hljs-keyword">value</span>)</span>
    {
        <span class="hljs-keyword">var</span> result = getService&lt;TService&gt;(componentId);
        <span class="hljs-keyword">value</span> = result <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>
            ? <span class="hljs-literal">default</span>(TService)
            : result;


        <span class="hljs-keyword">return</span> result <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>;
    }

    <span class="hljs-keyword">private</span> TService? getService&lt;TService&gt;(Guid componentId)
    {
        <span class="hljs-keyword">var</span> service = <span class="hljs-keyword">this</span>.FindComponentService&lt;TService&gt;(componentId);

        <span class="hljs-keyword">if</span> (service <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> (TService)service.ServiceInstance;

        <span class="hljs-keyword">return</span> <span class="hljs-literal">default</span>(TService);
    }
</code></pre>
<p><code>RemoveService</code> disposes the registered object if necessary and then removes it from the internal collection.</p>
<pre><code class="language-csharp">
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title">ValueTask</span>&lt;<span class="hljs-title">bool</span>&gt; <span class="hljs-title">RemoveService</span>&lt;<span class="hljs-title">TService</span>&gt;(<span class="hljs-params">Guid componentId</span>)</span>
    {
        <span class="hljs-keyword">var</span> componentService = <span class="hljs-keyword">this</span>.FindComponentService&lt;TService&gt;(componentId);

        <span class="hljs-keyword">if</span> (componentService <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">if</span> (componentService.ServiceInstance <span class="hljs-keyword">is</span> IDisposable disposable)
            disposable.Dispose();

        <span class="hljs-keyword">if</span> (componentService.ServiceInstance <span class="hljs-keyword">is</span> IAsyncDisposable asyncDisposable)
            <span class="hljs-keyword">await</span> asyncDisposable.DisposeAsync();

        _componentServices.Remove(componentService);

        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
</code></pre>
<p><code>Dispose</code> and <code>DisposeAsync</code> are called when the service is disposed.  They dispose all the remaining objects in the service collection.</p>
<pre><code class="language-csharp">    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-built_in">bool</span> disposing</span>)</span>
    {
        <span class="hljs-keyword">if</span> (disposedValue || !disposing)
        {
            disposedValue = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">return</span>;
        }

        Debug.WriteLine(<span class="hljs-string">$&quot;ComponentServiceManager - instance <span class="hljs-subst">{InstanceId}</span> disposed&quot;</span>);

        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> componentService <span class="hljs-keyword">in</span> _componentServices)
        {
            <span class="hljs-keyword">if</span> (componentService.ServiceInstance <span class="hljs-keyword">is</span> IDisposable disposable)
                disposable.Dispose();
        }

        disposedValue = <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>()</span>
    {
        Dispose(disposing: <span class="hljs-literal">true</span>);
        GC.SuppressFinalize(<span class="hljs-keyword">this</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> ValueTask <span class="hljs-title">DisposeAsync</span>()</span>
    {
        <span class="hljs-keyword">if</span> (asyncdisposedValue)
            <span class="hljs-keyword">return</span>;

        Debug.WriteLine(<span class="hljs-string">$&quot;ComponentServiceManager - instance <span class="hljs-subst">{InstanceId}</span> async disposed&quot;</span>);

        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> componentService <span class="hljs-keyword">in</span> _componentServices)
        {
            <span class="hljs-keyword">if</span> (componentService.ServiceInstance <span class="hljs-keyword">is</span> IAsyncDisposable asyncDisposable)
                <span class="hljs-keyword">await</span> asyncDisposable.DisposeAsync();
        }
    }
}
</code></pre>
<h3 id="componentservicemanagercascade">ComponentServiceManagerCascade</h3>
<p><code>ComponentServiceManagerCascade</code> provides a wrapper to implement all the functionality necessary to properly manage the service creation and disposal.</p>
<p><code>TService</code> defines the shared service object.  <code>ComponentId</code> either generates or is passed a Guid that will be used to uniquely identify the component context.  The component implements <code>IAsyncDisposable</code> to dispose of the service instance when the component is disposed.</p>
<pre><code class="language-csharp">@implements IAsyncDisposable
@typeparam TService

&lt;CascadingValue Name=<span class="hljs-string">&quot;ComponentId&quot;</span> Value=<span class="hljs-string">&quot;this.ComponentId&quot;</span>&gt;
@this.ChildContent
&lt;/CascadingValue&gt;

@code {
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> RenderFragment? ChildContent { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> Guid ComponentId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = Guid.NewGuid();
    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> ComponentServiceManager Manager { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">default</span>!;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInitialized</span>()</span>
        =&gt; Manager.GetOrCreateService&lt;TService&gt;(ComponentId);

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> ValueTask <span class="hljs-title">DisposeAsync</span>()</span>
        =&gt; <span class="hljs-keyword">await</span> Manager.RemoveService&lt;TService&gt;(ComponentId);
}
</code></pre>

        <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    

            </div>
        </div>
    </div>
</div>
<!-- end of Article Container -->


                </div>
                <!-- End of Main Content -->
            </div>
            <!-- Footer -->
            
<!-- Copyright -->
<footer class="sticky-footer bg-white">
    <div class="container my-auto">
        <div class="copyright text-center my-auto">
            
<span>Copyright &copy; Cold Elm Coders - 2022</span>

        </div>
    </div>
</footer>
<!-- end of copyright -->


            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
        
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>


    </div>
    <!-- End of Page Wrapper -->
    <!-- Scripts -->
    
<!-- Scripts -->
<!-- Bootstrap core JavaScript-->
<script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/assets/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/assets/js/sb-admin-2.min.js"></script>


</body>
</html>
