<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Async Programming in DotNetCore | Cold Elm Coders</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.757cca11.css" as="style"><link rel="preload" href="/assets/js/app.e7504274.js" as="script"><link rel="preload" href="/assets/js/3.f3d70fce.js" as="script"><link rel="preload" href="/assets/js/43.86ac5d2f.js" as="script"><link rel="prefetch" href="/assets/js/1.dd2e798d.js"><link rel="prefetch" href="/assets/js/10.62cd9054.js"><link rel="prefetch" href="/assets/js/11.7ef2f0cc.js"><link rel="prefetch" href="/assets/js/12.571448aa.js"><link rel="prefetch" href="/assets/js/13.e5a600e9.js"><link rel="prefetch" href="/assets/js/14.4ed01dd2.js"><link rel="prefetch" href="/assets/js/15.d0a813d8.js"><link rel="prefetch" href="/assets/js/16.3d701298.js"><link rel="prefetch" href="/assets/js/17.dd96adea.js"><link rel="prefetch" href="/assets/js/18.f6955aa8.js"><link rel="prefetch" href="/assets/js/19.bb1f166c.js"><link rel="prefetch" href="/assets/js/20.440b537e.js"><link rel="prefetch" href="/assets/js/21.1e192f13.js"><link rel="prefetch" href="/assets/js/22.0f3db856.js"><link rel="prefetch" href="/assets/js/23.9a2edb75.js"><link rel="prefetch" href="/assets/js/24.3d8317a7.js"><link rel="prefetch" href="/assets/js/25.e6e973f9.js"><link rel="prefetch" href="/assets/js/26.2f4dce51.js"><link rel="prefetch" href="/assets/js/27.eddfbfe3.js"><link rel="prefetch" href="/assets/js/28.1a753628.js"><link rel="prefetch" href="/assets/js/29.dd0c2751.js"><link rel="prefetch" href="/assets/js/30.049ba17e.js"><link rel="prefetch" href="/assets/js/31.ec7a699c.js"><link rel="prefetch" href="/assets/js/32.128041a3.js"><link rel="prefetch" href="/assets/js/33.90a80a82.js"><link rel="prefetch" href="/assets/js/34.640d5210.js"><link rel="prefetch" href="/assets/js/35.dd6a5277.js"><link rel="prefetch" href="/assets/js/36.af0fb7fb.js"><link rel="prefetch" href="/assets/js/37.6282d3d3.js"><link rel="prefetch" href="/assets/js/38.09c22a9c.js"><link rel="prefetch" href="/assets/js/39.34118569.js"><link rel="prefetch" href="/assets/js/4.004aaf89.js"><link rel="prefetch" href="/assets/js/40.42fb5da5.js"><link rel="prefetch" href="/assets/js/41.d1ac92f4.js"><link rel="prefetch" href="/assets/js/42.046bbbbf.js"><link rel="prefetch" href="/assets/js/44.1393eed1.js"><link rel="prefetch" href="/assets/js/45.a4121f00.js"><link rel="prefetch" href="/assets/js/46.f78d075f.js"><link rel="prefetch" href="/assets/js/47.02e428da.js"><link rel="prefetch" href="/assets/js/48.3f9d12a6.js"><link rel="prefetch" href="/assets/js/49.bb9c3fab.js"><link rel="prefetch" href="/assets/js/5.8a61fa12.js"><link rel="prefetch" href="/assets/js/50.ebb028fd.js"><link rel="prefetch" href="/assets/js/51.a2b343de.js"><link rel="prefetch" href="/assets/js/52.2a464137.js"><link rel="prefetch" href="/assets/js/53.54a07d54.js"><link rel="prefetch" href="/assets/js/54.72acf66d.js"><link rel="prefetch" href="/assets/js/55.6168cc1a.js"><link rel="prefetch" href="/assets/js/56.0653a59a.js"><link rel="prefetch" href="/assets/js/57.df56ec02.js"><link rel="prefetch" href="/assets/js/58.fc8f11bc.js"><link rel="prefetch" href="/assets/js/59.158abf7b.js"><link rel="prefetch" href="/assets/js/6.1fda51af.js"><link rel="prefetch" href="/assets/js/60.10f7e3a6.js"><link rel="prefetch" href="/assets/js/61.844ecd3b.js"><link rel="prefetch" href="/assets/js/62.da039f8c.js"><link rel="prefetch" href="/assets/js/63.f2fe69a7.js"><link rel="prefetch" href="/assets/js/64.b9085bd9.js"><link rel="prefetch" href="/assets/js/65.6c182c91.js"><link rel="prefetch" href="/assets/js/66.e0d48b84.js"><link rel="prefetch" href="/assets/js/7.eca4725c.js"><link rel="prefetch" href="/assets/js/8.2504867c.js"><link rel="prefetch" href="/assets/js/9.64046c51.js">
    <link rel="stylesheet" href="/assets/css/0.styles.757cca11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Cold Elm Coders</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/ArchivedArticles/" class="nav-link">
  Old Articles
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/articles/" class="nav-link router-link-active">
  Articles
</a></div><div class="nav-item"><a href="/posts/" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/ArchivedArticles/" class="nav-link">
  Old Articles
</a></div><div class="nav-item"><a href="/Building-a-Database-Application-in-Blazor/" class="nav-link">
  Database Application
</a></div><div class="nav-item"><a href="https://cec-blazor-examples.azurewebsites.net/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Demo Site
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>My Articles</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/articles/" aria-current="page" class="sidebar-link">Articles</a></li><li><a href="/articles/A-Flexible-App.html" class="sidebar-link">Adding Dynamic Routing, Layouts and RouteViews to the Blazor App Component</a></li><li><a href="/articles/Async-Programming-in-DotNetCore.html" aria-current="page" class="active sidebar-link">Async Programming in DotNetCore</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/articles/Async-Programming-in-DotNetCore.html#code-repository" class="sidebar-link">Code Repository</a></li><li class="sidebar-sub-header"><a href="/articles/Async-Programming-in-DotNetCore.html#library-classes" class="sidebar-link">Library Classes</a></li><li class="sidebar-sub-header"><a href="/articles/Async-Programming-in-DotNetCore.html#getting-started" class="sidebar-link">Getting Started</a></li><li class="sidebar-sub-header"><a href="/articles/Async-Programming-in-DotNetCore.html#more-complexity" class="sidebar-link">More Complexity</a></li><li class="sidebar-sub-header"><a href="/articles/Async-Programming-in-DotNetCore.html#conclusions-and-wrap-up" class="sidebar-link">Conclusions and Wrap Up.</a></li></ul></li><li><a href="/articles/Blazor-AllinOne.html" class="sidebar-link">Blazor AllinOne - Multi SPA Hosting</a></li><li><a href="/articles/Blazor-CSS.html" class="sidebar-link">CSS in Blazor</a></li><li><a href="/articles/Blazor-Components.html" class="sidebar-link">A Deep Dive into Blazor Components</a></li><li><a href="/articles/Blazor-DataList-Control.html" class="sidebar-link">A Blazor DataList Control</a></li><li><a href="/articles/BlazorAsyncProgramming.html" class="sidebar-link">Async Programming in Blazor</a></li><li><a href="/articles/Building-Edit-Forms.html" class="sidebar-link">Building Blazor Edit Forms</a></li><li><a href="/articles/EditFormState.html" class="sidebar-link">The Blazor EditFormState Control</a></li><li><a href="/articles/Hydra Full Article.html" class="sidebar-link">Blazor Hydra - Multi SPA Hosting</a></li><li><a href="/articles/Inline-Dialog.html" class="sidebar-link">The Blazor Inline Dialog Control</a></li><li><a href="/articles/Modal-Dialog.html" class="sidebar-link">A Blazor Modal Dialog</a></li><li><a href="/articles/ValidationFormState.html" class="sidebar-link">A Blazor Validation Control</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="a-practical-examination-of-async-programming-in-dotnetcore"><a href="#a-practical-examination-of-async-programming-in-dotnetcore" class="header-anchor">#</a> A Practical Examination of Async Programming in DotNetCore</h1> <p>Date: 2021-02-06</p> <p>My first article on this subject provided an overview of async programming in DotNetCore and explained some of the key concepts.  You'll find the article <a href="https://www.codeproject.com/Articles/5276310/Understanding-and-Using-Async-Programming-in-DotNe" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  This article takes a practical approach to demonstrating some of of those key concepts, and introducing more complex coding patterns.  The article is based around a DotNetCore console application.</p> <p>You'll need a DotNetCore compatible development environment, normally either either Visual Studio or Visual Code, and a copy of the Repo associated with this project to run the code.</p> <blockquote><p><strong>DISCLAIMER</strong> - The code is <strong>Experimental</strong>, not <strong>Production</strong>.  Designed to be concise with minimal error trapping and handling to keep it easy to read and understand. Classes are kept simple for the same reason.</p></blockquote> <h2 id="code-repository"><a href="#code-repository" class="header-anchor">#</a> Code Repository</h2> <p>The code in available in a GitHub Repo <a href="https://github.com/ShaunCurtis/Async-Demo" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.  The code for this project is in <em>Async-Demo</em>.  Ignore any other projects - they are for a further Async Programming article.</p> <h2 id="library-classes"><a href="#library-classes" class="header-anchor">#</a> Library Classes</h2> <p>Before we start your need to be aware of two helper classses</p> <ol><li><code>LongRunningTasks</code> - emulates work.
<ol><li><code>RunLongProcessorTaskAsync</code> and <code>RunLongProcessorTask</code> use prime number calculations to emulate a processor heavy task.</li> <li><code>RunYieldingLongProcessorTaskAsync</code> is a version that yields every 100 calculations.</li> <li><code>RunLongIOTaskAsync</code> uses <code>Task.Delay</code> to emulate a slow I/O operations.</li></ol></li> <li><code>UILogger</code> provides an abstraction layer for logging information to the UI.  You pass a delegate <code>Action</code> to the methods.  <code>UILogger</code> builds the message, and then calls the <code>Action</code> to actually write it to wherever the <code>Action</code> is configured to write to. In our case <code>LogToConsole</code> in <code>Program</code>,  which runs <code>Console.WriteLine</code>.  It could just as easily write to a text file.</li></ol> <h2 id="getting-started"><a href="#getting-started" class="header-anchor">#</a> Getting Started</h2> <p>Our first challenge is the switch from sync to async.</p> <p>Make sure you're running the correct framework and latest language version. (C# 7.1 onwards supports a Task based <code>Main</code>).</p> <div class="language-xml extra-class"><pre class="language-xml"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>OutputType</span><span class="token punctuation">&gt;</span></span>Exe<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>OutputType</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>TargetFramework</span><span class="token punctuation">&gt;</span></span>net5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>TargetFramework</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>LangVersion</span><span class="token punctuation">&gt;</span></span>latest<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>LangVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>RootNamespace</span><span class="token punctuation">&gt;</span></span>Async_Demo<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>RootNamespace</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>PropertyGroup</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>Pre #7.1, <code>Main</code> could only run synchronously, and you needed a &quot;NONO&quot;, using <code>Wait</code>, to prevent <code>Main</code> dropping out the bottom and closing the program. Post #7.1, declare <code>Main</code> to return a <code>Task</code>.</p> <p>The <code>async</code> <code>Main</code> pattern is shown below.  Declaring <code>async</code> depends on whether on not there's an <code>await</code> in the code</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// With await</span>
<span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// code</span>
    <span class="token comment">// await somewhere in here</span>
<span class="token punctuation">}</span>

<span class="token comment">// No awaits</span>
<span class="token keyword">static</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// code</span>
    <span class="token comment">// no awaits</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Note:</p> <ol><li>If you use the <code>async</code> keyword but don't have an <code>await</code>, the compiler warns, but then compiles anyway, treating the method as synchronous code.</li> <li>You can't declare a method as <code>async</code> and return a <code>Task</code>.  You simply return the correct value and the compiler will do all the donkey work.</li></ol> <p>So let's run some code. Our first run:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> watch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Stopwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogThreadType</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> millisecs <span class="token operator">=</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunLongProcessorTask</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Main ==&gt; Completed in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"> watch<span class="token punctuation">.</span>ElapsedMilliseconds</span><span class="token punctuation">}</span></span><span class="token string"> milliseconds&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The Task ran <em>synchronously</em> as expected. A bunch of synchronous code inside a <code>Task</code>. No yielding.</p> <div class="language- extra-class"><pre class="language-text"><code>[11:35:32][Main Thread][Main] &gt;  running on Application Thread
[11:35:32][Main Thread][LongRunningTasks] &gt; ProcessorTask started
[11:35:36][Main Thread][LongRunningTasks] &gt; ProcessorTask completed in 3399 millisecs
[11:35:36][Main Thread][Main] &gt; Main ==&gt; Completed in 3523 milliseconds
Press any key to close this window . . .
</code></pre></div><p>Our second run:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> watch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Stopwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogThreadType</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> millisecs <span class="token operator">=</span> <span class="token keyword">await</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunLongProcessorTaskAsync</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> LogToConsole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Yielded to Main&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Main ==&gt; Completed in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"> watch<span class="token punctuation">.</span>ElapsedMilliseconds</span><span class="token punctuation">}</span></span><span class="token string"> milliseconds&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The Task ran <em>synchronously</em> - no yielding.  Logical because there was no reason to yield. <code>RunLongProcessorTaskAsync</code> is a synchronous bunch of code inside a Task - calculating prime numbers - so it ran to completion.  The <code>await</code> is redundant, it may be a <code>Task</code> but it doesn't yield, so never gives up the thread until complete.</p> <div class="language- extra-class"><pre class="language-text"><code>[11:42:43][Main Thread][Main] &gt;  running on Application Thread
[11:42:43][Main Thread][LongRunningTasks] &gt; ProcessorTask started
[11:42:46][Main Thread][LongRunningTasks] &gt; ProcessorTask completed in 3434 millisecs
[11:42:46][Main Thread][Main] &gt; Yielded
[11:42:46][Main Thread][Main] &gt; Main ==&gt; Completed in 3593 milliseconds
</code></pre></div><p>Our third run:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> watch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Stopwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogThreadType</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> millisecs <span class="token operator">=</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunYieldingLongProcessorTaskAsync</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> LogToConsole<span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Yielded to Main&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Main ==&gt; Completed in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"> watch<span class="token punctuation">.</span>ElapsedMilliseconds</span><span class="token punctuation">}</span></span><span class="token string"> milliseconds&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Before we look at the result, let's look at the difference between <code>RunLongProcessorTaskAsync</code> and <code>RunYieldingLongProcessorTaskAsync</code>.  We've added a <code>Task.Yield()</code> to yield control every 100 primes.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isPrime<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    counter<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">// only present in Yielding version</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The long running task didn't complete. <code>RunYieldingLongProcessorTaskAsync</code> yielded back to <code>Main</code> after the first 100 primes had been calculated - a little short of 173 millisecs - and <code>Main</code> ran to completion during the yield.</p> <div class="language- extra-class"><pre class="language-text"><code>[12:13:56][Main Thread][Main] &gt;  running on Application Thread
[12:13:56][Main Thread][LongRunningTasks] &gt; ProcessorTask started
[12:13:57][Main Thread][Main] &gt; Yielded to Main
[12:13:57][Main Thread][Main] &gt; Main ==&gt; Completed in 173 milliseconds
</code></pre></div><p>If we update <code>Main</code> to <code>await</code> the long processor task</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token class-name"><span class="token keyword">var</span></span> millisecs <span class="token operator">=</span> <span class="token keyword">await</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunYieldingLongProcessorTaskAsync</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> LogToConsole<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>It runs to completion.  Although it yields, we <code>await</code> on the <code>RunYieldingLongProcessorTaskAsync</code> <code>Task</code> to complete, before moving on in <code>Main</code>.  There's another important point to note here.  Look at which thread the long running task ran on, and compare it to previous runs.  It jumped to a new thread <code>[LongRunningTasks Thread]</code> after starting on [Main Thread].</p> <div class="language- extra-class"><pre class="language-text"><code>[12:45:10][Main Thread:1][Main] &gt;  running on Application Thread
[12:45:11][Main Thread:1][LongRunningTasks] &gt; ProcessorTask started
[12:45:14][LongRunningTasks Thread:7][LongRunningTasks] &gt; ProcessorTask completed in 3892 millisecs
[12:45:14][LongRunningTasks Thread:7][Main] &gt; Yielded to Main
[12:45:14][LongRunningTasks Thread:7][Main] &gt; Main ==&gt; Completed in 4037 milliseconds
</code></pre></div><p>Add a quick <code>Console.Write</code> in <code>RunYieldingLongProcessorTaskAsync</code> to see which thread each yielded iteration runs on - writing the <code>ManagedThreadId</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>counter<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;Thread ID:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Thread<span class="token punctuation">.</span>CurrentThread<span class="token punctuation">.</span>ManagedThreadId</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The result is shown below.  Notice the regular thread jumping.  Yield creates a new continuation <code>Task</code>, and schedules it to run asynchronously.  On the first <code>Task.Yield</code> the application thread scheduler passes the new <code>Task</code> to the application pool, and for then on the application pool Scheduler makes decisions on where to run Tasks.</p> <blockquote><p><code>Task.Yield()</code>, to quote Microsoft &quot;Creates an awaitable task that asynchronously yields back to the current context when awaited.&quot; I translate that to mean it's syntactic sugar for yielding control up the tree and creating a continuation <code>Task</code> that gets posted back to the Scheduler to run when it schedules it. To quote further &quot;A context that, when awaited, will asynchronously transition back into the current context at the time of the await.&quot;  In other words, it doesn't <code>await</code> unless you tell it to.  Hit the first yield in the continuation and processing trucks on through to the code below <code>Task.Yield()</code>.  I've tested it.</p></blockquote> <div class="language- extra-class"><pre class="language-text"><code>[12:38:16][Main Thread:1][Main] &gt;  running on Application Thread
[12:38:16][Main Thread:1][LongRunningTasks] &gt; ProcessorTask started
Thread ID:1
Thread ID:4
Thread ID:4
Thread ID:6
Thread ID:6
Thread ID:7
</code></pre></div><p>Finally, change over to the <code>RunLongIOTaskAsync</code> long running task.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>    <span class="token class-name"><span class="token keyword">var</span></span> millisecs <span class="token operator">=</span> <span class="token keyword">await</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunLongIOTaskAsync</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> LogToConsole<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If you don't <code>await</code>, the same as before:</p> <div class="language- extra-class"><pre class="language-text"><code>[14:26:46][Main Thread:1][Main] &gt;  running on Application Thread
[14:26:47][Main Thread:1][LongRunningTasks] &gt; IOTask started
[14:26:47][Main Thread:1][Main] &gt; Yielded to Main
[14:26:47][Main Thread:1][Main] &gt; Main ==&gt; Completed in 322 milliseconds
</code></pre></div><p>And if you <code>await</code> it runs to completion, again with the thread switch.</p> <div class="language- extra-class"><pre class="language-text"><code>[14:27:16][Main Thread:1][Main] &gt;  running on Application Thread
[14:27:16][Main Thread:1][LongRunningTasks] &gt; IOTask started
[14:27:21][LongRunningTasks Thread:4][LongRunningTasks] &gt; IOTask completed in 5092 millisecs
[14:27:21][LongRunningTasks Thread:4][Main] &gt; Yielded to Main
[14:27:21][LongRunningTasks Thread:4][Main] &gt; Main ==&gt; Completed in 5274 milliseconds

</code></pre></div><h2 id="more-complexity"><a href="#more-complexity" class="header-anchor">#</a> More Complexity</h2> <p>Ok, now to move closer to reality and code doing something.</p> <h3 id="jobrunner"><a href="#jobrunner" class="header-anchor">#</a> JobRunner</h3> <p><code>JobRunner</code> is a simple class to run and control asynchronous jobs.  For our purposes, it runs one of the long running tasks to simulate work, but you can use the basic pattern for real world situations.</p> <p>It's self-evident what most of the code does, but I'll introduce <code>TaskCompletionSource</code>.</p> <blockquote><p>To quote MS &quot;Represents the producer side of a Task&lt;TResult&gt; unbound to a delegate, providing access to the consumer side through the Task property.&quot;  You get a <code>Task</code> exposed by <code>TaskCompletionSource.Task</code> that you control through the <code>TaskCompletionSource</code> instance - in other words, a manually controlled <code>Task</code> uncoupled from the method.</p></blockquote> <p>The <code>Task</code> that represents the state of the <code>JobRunner</code> is exposed as the <code>JobTask</code> property.  If the underlying <code>TaskCompletionSource</code> isn't set it returns a simple <code>Task.CompletedTask</code> object, otherwise it returns the <code>Task</code> of <code>JobTaskController</code>.  The <code>Run</code> method uses the async event pattern - we need a block of code that runs asynchronously, yielding control with <code>await</code>.  <code>Run</code> controls the <code>Task</code> state, but the <code>Task</code> itself is independant of <code>Run</code>.  <code>IsRunning</code> ensures you can't start the job once it's running.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">class</span> <span class="token class-name">JobRunner</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">JobType</span> <span class="token punctuation">{</span> IO<span class="token punctuation">,</span> Processor<span class="token punctuation">,</span> YieldingProcessor <span class="token punctuation">}</span> 

    <span class="token keyword">public</span> <span class="token function">JobRunner</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> secs<span class="token punctuation">,</span> <span class="token class-name">JobType</span> type <span class="token operator">=</span> JobType<span class="token punctuation">.</span>IO<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Seconds <span class="token operator">=</span> secs<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>Type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> Seconds <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">private</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">JobType</span> Type <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name"><span class="token keyword">bool</span></span> IsRunning<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> JobTask <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>JobTaskController <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token punctuation">?</span> Task<span class="token punctuation">.</span>CompletedTask <span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>JobTaskController<span class="token punctuation">.</span>Task<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token return-type class-name">TaskCompletionSource</span> JobTaskController <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>IsRunning<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>IsRunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>JobTaskController <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TaskCompletionSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>Type<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">case</span> JobType<span class="token punctuation">.</span>Processor<span class="token punctuation">:</span>
                    <span class="token keyword">await</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunLongProcessorTaskAsync</span><span class="token punctuation">(</span>Seconds<span class="token punctuation">,</span> Program<span class="token punctuation">.</span>LogToConsole<span class="token punctuation">,</span> Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                    
                <span class="token keyword">case</span> JobType<span class="token punctuation">.</span>YieldingProcessor<span class="token punctuation">:</span>
                    <span class="token keyword">await</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunYieldingLongProcessorTaskAsync</span><span class="token punctuation">(</span>Seconds<span class="token punctuation">,</span> Program<span class="token punctuation">.</span>LogToConsole<span class="token punctuation">,</span> Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>

                <span class="token keyword">default</span><span class="token punctuation">:</span>
                    <span class="token keyword">await</span> LongRunningTasks<span class="token punctuation">.</span><span class="token function">RunLongIOTaskAsync</span><span class="token punctuation">(</span>Seconds<span class="token punctuation">,</span> Program<span class="token punctuation">.</span>LogToConsole<span class="token punctuation">,</span> Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">this</span><span class="token punctuation">.</span>JobTaskController<span class="token punctuation">.</span><span class="token function">TrySetResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>IsRunning <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="jobscheduler"><a href="#jobscheduler" class="header-anchor">#</a> JobScheduler</h3> <p><code>JobScheduler</code> is the method used to actually schedule the jobs.  It's separated from <code>Main</code> to demonstrate some key behaviours of async programming.</p> <ol><li><code>Stopwatch</code> provides timing.</li> <li>Creates four different <em>IO</em> jobs.</li> <li>Starts the four jobs.</li> <li>Uses <code>Task.WhenAll</code> to wait on certain tasks before continuing.  Note the <code>Task</code>s are the <code>JobTask</code>s exposed by the <code>JobRunnner</code> instances.</li></ol> <blockquote><p><code>WhenAll</code> is one of several static <code>Task</code> methods.  <code>WhenAll</code> creates a single <code>Task</code> which <code>awaits</code> all the Tasks in the submitted array.  It's status will change to <em>Complete</em> when all the Tasks complete.  <code>WhenAny</code> is similar, but will be set to <em>Complete</em> when any are complete.  They could be named <em>AwaitAll</em> and <em>AwaitAny</em>.  <code>WaitAll</code> and <code>WaitAny</code> are blocking versions and similar to <code>Wait</code>.  Not sure about the reasons for the slightly confusing naming conversion - I'm sure there was one.</p></blockquote> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">JobScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> watch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Stopwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> name <span class="token operator">=</span> <span class="token string">&quot;Job Scheduler&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> quickjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Quick Job&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> veryslowjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Very Slow Job&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> slowjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Slow Job&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> veryquickjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Very Quick Job&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    quickjob<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    veryslowjob<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    slowjob<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    veryquickjob<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;All Jobs Scheduled&quot;</span></span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> quickjob<span class="token punctuation">.</span>JobTask<span class="token punctuation">,</span> veryquickjob<span class="token punctuation">.</span>JobTask <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Quick Jobs completed in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">watch<span class="token punctuation">.</span>ElapsedMilliseconds</span><span class="token punctuation">}</span></span><span class="token string"> milliseconds&quot;</span></span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Task<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{</span> slowjob<span class="token punctuation">.</span>JobTask<span class="token punctuation">,</span> quickjob<span class="token punctuation">.</span>JobTask<span class="token punctuation">,</span> veryquickjob<span class="token punctuation">.</span>JobTask<span class="token punctuation">,</span> veryslowjob<span class="token punctuation">.</span>JobTask <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;All Jobs completed in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">watch<span class="token punctuation">.</span>ElapsedMilliseconds</span><span class="token punctuation">}</span></span><span class="token string"> milliseconds&quot;</span></span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We now need to make some changes to <code>Main</code>:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> watch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Stopwatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogThreadType</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> task <span class="token operator">=</span> <span class="token function">JobScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Job Scheduler yielded to Main&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> task<span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;final yield to Main&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watch<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    UILogger<span class="token punctuation">.</span><span class="token function">LogToUI</span><span class="token punctuation">(</span>LogToConsole<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$&quot;Main ==&gt; Completed in </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp"> watch<span class="token punctuation">.</span>ElapsedMilliseconds</span><span class="token punctuation">}</span></span><span class="token string"> milliseconds&quot;</span></span><span class="token punctuation">,</span> <span class="token string">&quot;Main&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//return Task.CompletedTask;</span>
<span class="token punctuation">}</span>

</code></pre></div><p>When you run this you get the output below.  The interesting bits to note are:</p> <ol><li>Each of the jobs start, and then yield at their first await, passing control back to the caller - in this case <code>JobSchedular</code>.</li> <li><code>JobScheduler</code> runs to it's first <code>await</code> and yields back to <code>Main</code>.</li> <li>When the first two jobs finish their <code>JobTask</code> is set to complete and <code>JobScheduler</code> continues to the next <code>await</code>.</li> <li><code>JobScheduler</code> completes in a little over the time needed to run the longest Job.</li></ol> <div class="language- extra-class"><pre class="language-text"><code>[16:58:52][Main Thread:1][Main] &gt;  running on Application Thread
[16:58:52][Main Thread:1][LongRunningTasks] &gt; Quick Job started
[16:58:52][Main Thread:1][LongRunningTasks] &gt; Very Slow Job started
[16:58:52][Main Thread:1][LongRunningTasks] &gt; Slow Job started
[16:58:52][Main Thread:1][LongRunningTasks] &gt; Very Quick Job started
[16:58:52][Main Thread:1][Job Scheduler] &gt; All Jobs Scheduled
[16:58:52][Main Thread:1][Main] &gt; Job Scheduler yielded to Main
[16:58:54][LongRunningTasks Thread:4][LongRunningTasks] &gt; Very Quick Job completed in 2022 millisecs
[16:58:55][LongRunningTasks Thread:4][LongRunningTasks] &gt; Quick Job completed in 3073 millisecs
[16:58:55][LongRunningTasks Thread:4][Job Scheduler] &gt; Quick Jobs completed in 3090 milliseconds
[16:58:57][LongRunningTasks Thread:4][LongRunningTasks] &gt; Slow Job completed in 5003 millisecs
[16:58:59][LongRunningTasks Thread:6][LongRunningTasks] &gt; Very Slow Job completed in 7014 millisecs
[16:58:59][LongRunningTasks Thread:6][Job Scheduler] &gt; All Jobs completed in 7111 milliseconds
[16:58:59][LongRunningTasks Thread:6][Main] &gt; final yield to Main
[16:58:59][LongRunningTasks Thread:6][Main] &gt; Main ==&gt; Completed in 7262 milliseconds
</code></pre></div><p>Now change the job type over to <code>Processor</code> as below:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> quickjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Quick Job&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>Processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> veryslowjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Very Slow Job&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>Processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> slowjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Slow Job&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>Processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> veryquickjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Very Quick Job&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>Processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>When you run this, you'll see everything is run sequentially on the <code>Main Thread</code>.  At first you think why?  We have more than one thread available and the Scheduler has demonstrated it's ability to switch tasks between threads. Why isn't it switching?</p> <p>The answer is very simple.  Once we initialise the JobRunnner object we run them in to the Scheduler one at a time.  As the code we run is sequential - calculating primes without breaks - we don't execute the next line of code (feeding in the second job) until the first job completes.</p> <div class="language- extra-class"><pre class="language-text"><code>[17:59:48][Main Thread:1][Main] &gt;  running on Application Thread
[17:59:48][Main Thread:1][LongRunningTasks] &gt; Quick Job started
[17:59:53][Main Thread:1][LongRunningTasks] &gt; Quick Job completed in 4355 millisecs
[17:59:53][Main Thread:1][LongRunningTasks] &gt; Very Slow Job started
[17:59:59][Main Thread:1][LongRunningTasks] &gt; Very Slow Job completed in 6057 millisecs
[17:59:59][Main Thread:1][LongRunningTasks] &gt; Slow Job started
[18:00:03][Main Thread:1][LongRunningTasks] &gt; Slow Job completed in 4209 millisecs
[18:00:03][Main Thread:1][LongRunningTasks] &gt; Very Quick Job started
[18:00:05][Main Thread:1][LongRunningTasks] &gt; Very Quick Job completed in 1737 millisecs
[18:00:05][Main Thread:1][Job Scheduler] &gt; All Jobs Scheduled
[18:00:05][Main Thread:1][Job Scheduler] &gt; Quick Jobs completed in 16441 milliseconds
[18:00:05][Main Thread:1][Job Scheduler] &gt; All Jobs completed in 16441 milliseconds
[18:00:05][Main Thread:1][Main] &gt; Job Scheduler yielded to Main
[18:00:05][Main Thread:1][Main] &gt; final yield to Main
[18:00:05][Main Thread:1][Main] &gt; Main ==&gt; Completed in 16591 milliseconds
</code></pre></div><p>Now, change the jobs over to run <code>YieldingProcessor</code>.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name"><span class="token keyword">var</span></span> quickjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Quick Job&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>YieldingProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> veryslowjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Very Slow Job&quot;</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>YieldingProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> slowjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Slow Job&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>YieldingProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> veryquickjob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">JobRunner</span><span class="token punctuation">(</span><span class="token string">&quot;Very Quick Job&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> JobRunner<span class="token punctuation">.</span>JobType<span class="token punctuation">.</span>YieldingProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>The result is very different.  The time taken will depend on the number of processor cores and threads on your computer.  You can see all the jobs start quickly and completion in 11 seconds, with the slowest job taking 9 seconds.  The key difference here is that the processor long running job yields regularly.  This gives the Scheduler a chance to divy out out the work to other threads.</p> <p>Yielding Processor code</p> <div class="language- extra-class"><pre class="language-text"><code>[17:50:12][Main Thread:1][Main] &gt;  running on Application Thread
[17:50:12][Main Thread:1][LongRunningTasks] &gt; Quick Job started
[17:50:12][Main Thread:1][LongRunningTasks] &gt; Very Slow Job started
[17:50:12][Main Thread:1][LongRunningTasks] &gt; Slow Job started
[17:50:12][Main Thread:1][LongRunningTasks] &gt; Very Quick Job started
[17:50:12][Main Thread:1][Job Scheduler] &gt; All Jobs Scheduled
[17:50:12][Main Thread:1][Main] &gt; Job Scheduler yielded to Main
[17:50:16][LongRunningTasks Thread:7][LongRunningTasks] &gt; Very Quick Job completed in 4131 millisecs
[17:50:18][LongRunningTasks Thread:7][LongRunningTasks] &gt; Quick Job completed in 6063 millisecs
[17:50:18][LongRunningTasks Thread:7][Job Scheduler] &gt; Quick Jobs completed in 6158 milliseconds
[17:50:21][LongRunningTasks Thread:6][LongRunningTasks] &gt; Slow Job completed in 9240 millisecs
[17:50:23][LongRunningTasks Thread:9][LongRunningTasks] &gt; Very Slow Job completed in 11313 millisecs
[17:50:23][LongRunningTasks Thread:9][Job Scheduler] &gt; All Jobs completed in 11411 milliseconds
[17:50:23][LongRunningTasks Thread:9][Main] &gt; final yield to Main
[17:50:23][LongRunningTasks Thread:9][Main] &gt; Main ==&gt; Completed in 11534 milliseconds
</code></pre></div><h2 id="conclusions-and-wrap-up"><a href="#conclusions-and-wrap-up" class="header-anchor">#</a> Conclusions and Wrap Up.</h2> <p>Hopefully helpful/informative?  Some of the key points that I've learned in my voyage down the async road, and are demonstrated here are:</p> <ol><li><strong>Async and Await All The Way</strong>. Don't mix synchronous and asynchronous methods.  Start at the bottom - the data or process interface - and code async all the way up though the data and business/logic layers to the UI.</li> <li>You can't run asynchronously if you don't yield. You've got to give the task schedulers a chance!  Wrapping a few synchronous routines in <code>Task</code> is talking-the-talk not walking-the-walk.</li> <li>Fire and forget <code>void</code> return methods need to yield to pass control back to the caller.  They are no different to Task returning methods in their behaviour. They just don't return a Task for you to await or monitor progress.</li> <li>If you're writing processor intensive activities - modelling, big numbercrunching,..  make sure to make them async with plenty of yielding at appropriate places.</li> <li>ONLY use <code>Task.Run</code> in the UI, right up at the top of the call stack.  NEVER EVER use it in libraries.  And don't use it at all unless you have a solid reason.</li> <li>Use logging and breakpoints on <code>awaits</code> to see when you hit them.  How quickly your code falls back to the outside <code>await</code> is a  very good indicator of responsiveness.  Take out your outside <code>await</code> and see how quickly you drop out the bottom!</li> <li>You may have noticed no <code>ContinueWith</code>.  I don't often use it.  Normally a simple <code>await</code> followed by continuation code achieves the same result.  I've read commentary that it's heavier on processing, because it creates a new task whereas await/continuation reuses the same <code>Task</code>.  I haven't delved deeply enough into the code yet to check.</li> <li>Always use <em>Async</em> and <em>Await</em>, don't get fancy.</li> <li>If your library provides both async and sync calls, code them separately.  &quot;Code it once&quot; best practice doesn't apply here.  NEVER call one from the other if you don't want to shoot yourself in the foot at some point!</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/articles/A-Flexible-App.html" class="prev">
        Adding Dynamic Routing, Layouts and RouteViews to the Blazor App Component
      </a></span> <span class="next"><a href="/articles/Blazor-AllinOne.html">
        Blazor AllinOne - Multi SPA Hosting
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.e7504274.js" defer></script><script src="/assets/js/3.f3d70fce.js" defer></script><script src="/assets/js/43.86ac5d2f.js" defer></script>
  </body>
</html>
