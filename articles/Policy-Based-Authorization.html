<!DOCTYPE html>
<html lang="en">
<head>
    
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- SEO Meta Tags -->
<meta name="description" content="Your description">
<meta name="author" content="Your name">

<!-- OG Meta Tags to improve the way the post looks when you share the page on Facebook, Twitter, LinkedIn -->
<meta property="og:site_name" content="" /> <!-- website name -->
<meta property="og:site" content="" /> <!-- website link -->
<meta property="og:title" content="" /> <!-- title shown in the actual shared post -->
<meta property="og:description" content="" /> <!-- description shown in the actual shared post -->
<meta property="og:image" content="" /> <!-- image link, make sure it's jpg -->
<meta property="og:url" content="" /> <!-- where do you want your post to link to -->
<meta name="twitter:card" content="summary_large_image"> <!-- to have large image post format in Twitter -->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta name="description" content="This article describes how to implement policy based authentication in blazor Applications." >
<meta name="author" content="Shaun Curtis" >



<title>Policy Base Authorization in Blazor</title>


<!-- Custom fonts for this template-->
<link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet">

<!-- Custom styles for this template-->
<link href="/assets/css/sb-admin-2.css" rel="stylesheet" type="text/css">
<link href="/assets/css/site.css" rel="stylesheet" type="text/css">

<!-- Favicon  -->
<link rel="icon" href="/assets/images/favicon.png">


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
    <link rel="stylesheet" href="/assets/css/article.css" type="text/css">
</head>
<body id="page-top">
    <!--topbar-->
    <div id="topbar">
        
<!-- Topbar -->
<nav class="navbar navbar-expand navbar-light topbar mb-4 static-top">
    
<ul class="navbar-nav" >
<li class="nav-item" >
<a class="nav-link " href="/index.html" role="button"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Index</span>
</a>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="11ea885e-4175-489a-9dd3-7cfaef3541ba" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Articles</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="11ea885e-4175-489a-9dd3-7cfaef3541ba" >
<a class="dropdown-item" href="/articles/A-Flexible-App.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Creating a Dynamic Blazor App Component
</a>
<a class="dropdown-item" href="/articles/Async-Programming-in-DotNetCore.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Async Programming In Dotnetcore
</a>
<a class="dropdown-item" href="/articles/Blazor-AllinOne.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor All In One - Multi SPA Hosting
</a>
<a class="dropdown-item" href="/articles/Blazor-Async-Programming.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Async Programming
</a>
<a class="dropdown-item" href="/articles/Blazor-Brick-By-Brick.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Brick By Brick
</a>
<a class="dropdown-item" href="/articles/Blazor-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Components
</a>
<a class="dropdown-item" href="/articles/Blazor-CSS.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor CSS
</a>
<a class="dropdown-item" href="/articles/Blazor-DataList-Control.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Datalist Control
</a>
<a class="dropdown-item" href="/articles/Blazor-Form-Validation.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Form Validation
</a>
<a class="dropdown-item" href="/articles/Building-Blazor-List-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Blazor List Components and the Notification Pattern
</a>
<a class="dropdown-item" href="/articles/Building-Edit-Forms.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Edit Forms
</a>
<a class="dropdown-item" href="/articles/EditFormState.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor EditFormState Control
</a>
<a class="dropdown-item" href="/articles/Hydra.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Hydra
</a>
<a class="dropdown-item" href="/articles/Inline-Dialog.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor Inline Dialog Control
</a>
<a class="dropdown-item" href="/articles/Modal-Dialog.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Modal Dialog
</a>
<a class="dropdown-item" href="/articles/Policy-Based-Authorization.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Policy Base Authorization in Blazor
</a>
<a class="dropdown-item" href="/articles/ValidationFormState.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Validation Control
</a>
<a class="dropdown-item" href="/articles/XML-XSD-Serialization.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
XML XSD Serialization
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="1823a271-7d56-4035-9ce2-331b76873357" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Blazor Database Apps</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="1823a271-7d56-4035-9ce2-331b76873357" >
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-1.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 1
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 2
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-3.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 3
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-4.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 4
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-5.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 5
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-6.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 6
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/index.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building a Database Application in Blazor
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="65270138-c77a-4334-9c1e-ddb6c20d7a72" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Building Blazor Applications</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="65270138-c77a-4334-9c1e-ddb6c20d7a72" >
<a class="dropdown-item" href="/Building-Blazor-Applications/Blazor-Async-UI-Events.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Async UI Events
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Blazor-Bootstrap-Toaster.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Bootstrap Toaster
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Blazor-Services.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Services
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Building-A-Blazor-AutoComplete-Control.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Blazor Autocomplete Control
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Building-Wrapper-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Wrapper Components
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/DBContexts-In-Transient-Services.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Dbcontexts In Transient Services
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/DynamicCss.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Dynamic Stylesheets
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/For-ForEach-in-Blazor.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
For Foreach In Blazor
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Leaner-Meaner-Greener-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Leaner Meaner Greener Components
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Notification-Service-Pattern.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Notification Service Pattern
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Rethinking-The-Repository-Pattern.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Rethinking The Repository Pattern
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/The-Blazor-WASM-Hosted-Project.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor WASM Hosted Project
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/Whats-Wrong-with-my-Component-Design.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Whats Wrong With My Component Design
</a>
<a class="dropdown-item" href="/Building-Blazor-Applications/The-Blazor-Component" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Blazor Applications\The Blazor Component
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="33b707ed-9fcf-413b-8cf6-47f103cee8e5" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Design</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="33b707ed-9fcf-413b-8cf6-47f103cee8e5" >
<a class="dropdown-item" href="/Design/Clean-Design-In-Blazor.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Clean Design Principles in Blazor Applications
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Clean Design Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-Solution-Structure.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Solution Structure in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-DataServices.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Data Services in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-UI.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The UI in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-Solution-Setup.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Solution Setup in the Clean Design Blazor Template
</a>
<a class="dropdown-item" href="/Design/Clean-Design-Blazor-Template-Testing.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Testing in the Clean Design Blazor Template
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="31987f83-ee8e-4f6b-83cd-2172ee42e82e" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Modern C#</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="31987f83-ee8e-4f6b-83cd-2172ee42e82e" >
<a class="dropdown-item" href="/Modern-Coding-Patterns/Nullable-And-VS-2022.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Nullable And VS 2022
</a>
</div>
</li>
</ul>

    <div class="ms-5 me-5 ml-auto">
        <h1>Cold Elm Coders</h1>
    </div>
</nav>


    </div>
    <!--End topbar-->
    <!--Sidebar-->
    <div id="sidebar">
        
<div class="article-info p-2" Published: 29-01-2022 >
<div>Published: 29-01-2022</div>
<div>Last Updated: 29-01-2022</div>
<div>Author: Shaun Curtis</div>
</div>

        
<h4 class="p-2">Table of Contents</h4>
<ul class="TOC" >
<li class="TOC-item TOC-item-0" >
<a class="TOC-link" href="#">Top</a>
<ul class="TOC TOC-0" >
<li class="TOC-item TOC-item-1" >
<a class="TOC-link" href="#introduction">Introduction</a>
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#repository-and-demonstrator">Repository and Demonstrator</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authentication-and-ownership">Authentication and Ownership</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authorization">Authorization</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authorization-button">Authorization Button</a>
<ul class="TOC TOC-2" >
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#policies">Policies</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#authorization-requrements">Authorization Requrements</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#authorization-handlers">Authorization Handlers</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#so-how-does-a-policy-work">So how does a policy work?</a>
</li>
</ul>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#service-based-authorization">Service based Authorization</a>
</li>
</ul>
</li>
<li class="TOC-item TOC-item-1" >
<a class="TOC-link" href="#appendix">Appendix</a>
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authentication">Authentication</a>
<ul class="TOC TOC-2" >
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#test-identities">Test Identities</a>
</li>
</ul>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#weather-forecast-ownership">Weather Forecast Ownership</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
    <!--End Sidebar-->
    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <div id="article">
                    <!-- Article -->
                    
<!-- Header -->
<header class="ex-header-article">
    <div class="container">
        <div class="row pt-3 pb-3 border-bottom">
            <div class="col">
                
<h1>Policy Base Authorization in Blazor</h1>
<div>This article describes how to implement policy based authentication in blazor Applications.</div>

            </div> <!-- end of col -->
        </div> <!-- end of row -->
    </div> <!-- end of container -->
</header> <!-- end of ex-header -->
<!-- end of header -->


                    
<!-- Article Container -->
<div class="ex-basic-1 pt-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                

        <h1 id="introduction">Introduction</h1>
<p>Many applications require more granular and complex authorization that the canned examples in many demos.  This article shows:</p>
<ol>
<li>How use and manage policy based authorization in an application.</li>
<li>How to build and manage policies in static classes.</li>
<li>How to build complex resource based policy classes to authorize an identity against.</li>
</ol>
<h2 id="repository-and-demonstrator">Repository and Demonstrator</h2>
<p>The project associated with this article is available <a href="https://github.com/ShaunCurtis/Blazr.Demo.Authorization">here on Github</a>.  The project is based on my <a href="https://github.com/ShaunCurtis/Blazr.Demo">Blazr.Demo</a> project template that implements basic clean design principles.</p>
<h2 id="authentication-and-ownership">Authentication and Ownership</h2>
<p>Discussing Authorization is a little like putting the cart before the horse.  To authorize we need an authenticated identity.</p>
<p>For this article we use a very simple authenticator.</p>
<ol>
<li><code>VerySimpleAuthenticationProvider</code> returns a standard <code>IndentityPrincipal</code> instance with a Guid security Id and a role.</li>
<li><code>UserDisplay</code> is the equivalent to a log in page.  It's a simple select in the top <code>NavBar</code> that makes changing identity simple and quick.</li>
</ol>
<p>The record set we use is the classic weather forecast.  I've added an <code>OwnerId</code> to the record so we can allow record owners to edit and delete their own records.</p>
<p>The code for the authenticator, component and weather forecast record is in the bottom of this article.</p>
<p>The image below shows the Identity select and the <code>FetchData</code> page for the user &quot;Visitor-2&quot;.</p>
<p><img src="\articles\assets\Policy-Based-Authentication\App-View.png" alt="App View"></p>
<h2 id="authorization">Authorization</h2>
<p>Before delving into the detail, let's look at the end result.</p>
<ol>
<li>An anonymous user can view the list, but that's all.</li>
</ol>
<p><img src="\articles\assets\Policy-Based-Authentication\Anonymous.png" alt="App View"></p>
<ol start="2">
<li>Users can edit or view any record, but not delete one.</li>
</ol>
<p><img src="\articles\assets\Policy-Based-Authentication\User.png" alt="App View"></p>
<ol start="3">
<li>Admins you can Edit/View/Delete all records.</li>
</ol>
<p><img src="\articles\assets\Policy-Based-Authentication\Admin.png" alt="App View"></p>
<ol start="4">
<li>Visitors can view all the records, but only Edit/Delete your own.</li>
</ol>
<p><img src="\articles\assets\Policy-Based-Authentication\Visitor.png" alt="App View"></p>
<ol start="5">
<li>Applying authorization to a backend service.  We may show the &quot;Add Record&quot; to the identity, but the service applies a <code>User/Admin</code> only policy. So a visitor can click the &quot;Add Record&quot; button , but the backend refuses to add the record.  In the demo I show a simple message.</li>
</ol>
<p><img src="\articles\assets\Policy-Based-Authentication\Visitor-Add.png" alt="App View"></p>
<h2 id="authorization-button">Authorization Button</h2>
<p>In the UI we normally click buttons to do things.  I've built an <code>AuthorizeButton</code> component to encapsulate this.  There are two versions:</p>
<ol>
<li><code>AuthorizeButton</code> requires a policy.  This is the Add button at the top of the page.  We're just encapsulating specific <code>AuthorizeView</code> code into the button context.</li>
</ol>
<pre><code class="language-html"><div><span class="hljs-tag">&lt;<span class="hljs-name">AuthorizeButton</span> <span class="hljs-attr">Policy</span>=<span class="hljs-string">@AppPolicies.IsVisitor</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-success&quot;</span> @<span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;AddRecord&quot;</span>&gt;</span>Add Record<span class="hljs-tag">&lt;/<span class="hljs-name">AuthorizeButton</span>&gt;</span>
</div></code></pre>
<ol start="2">
<li><code>AuthorizeRecordButton</code> requires a policy and an <code>AppAuthFields</code> object built from a specific record.  This is the Edit button that appears in each row and uses the row record to populate the <code>AppAuthFields</code> instance.</li>
</ol>
<pre><code class="language-html"><div><span class="hljs-tag">&lt;<span class="hljs-name">AuthorizeRecordButton</span> <span class="hljs-attr">Policy</span>=<span class="hljs-string">@AppPolicies.IsEditorPolicy</span> <span class="hljs-attr">AuthFields</span>=<span class="hljs-string">&quot;this.GetAuthFields(forecast)&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;button&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn-sm btn-primary&quot;</span> <span class="hljs-attr">ClickEvent</span>=<span class="hljs-string">&quot;() =&gt; this.EditRecord(forecast.Id)&quot;</span>&gt;</span>Edit<span class="hljs-tag">&lt;/<span class="hljs-name">AuthorizeRecordButton</span>&gt;</span>
</div></code></pre>
<p><code>AppAuthFields</code> provides a generic method to pass specific information into the authorization process.  We can add more fields to it as required.  We'll see how it works later.</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">AppAuthFields</span>
{
    <span class="hljs-keyword">public</span> Guid OwnerId { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
}
</div></code></pre>
<p><code>AuthorizeButton</code> looks like this.  Much of the code is pretty standard component fare, so I'll concentrate on just the authorization bit.</p>
<p><code>OnInitialized</code> checks to ensure we have a <code>AuthTask</code> cascade i.e. we have the upstream authentication and authorization configured.  If not then it throws an exception.</p>
<p><code>BuildRenderTree</code> calls <code>CheckPolicy()</code> to check if it should render the button.</p>
<p><code>CheckPolicy</code> gets the authentication state and then calls <code>AuthorizeAsync</code> on the injected <code>IAuthorizationService</code>, passing in the <code>IdentityPrincipal</code> of the logging in identity, a null for the resource object (we'll come to resource objects shortly), and the policy name to apply.  If the result is <code>success</code>, it displays the button.</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizeButton</span> : <span class="hljs-title">ComponentBase</span>
{
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> Show { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">true</span>;
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> Disabled { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-literal">false</span>;
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Policy { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = String.Empty;
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> RenderFragment? ChildContent { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> EventCallback&lt;MouseEventArgs&gt; ClickEvent { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [<span class="hljs-meta">Parameter(CaptureUnmatchedValues = true)</span>] <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">IDictionary</span>&lt;<span class="hljs-title">string</span>, <span class="hljs-title">object</span>&gt; SplatterAttributes</span> { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">object</span>&gt;();
    [<span class="hljs-meta">CascadingParameter</span>] <span class="hljs-keyword">public</span> Task&lt;AuthenticationState&gt;? AuthTask { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">protected</span> IAuthorizationService? _authorizationService { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">protected</span> IAuthorizationService AuthorizationService =&gt; _authorizationService!;

    <span class="hljs-keyword">protected</span> CSSBuilder CssClass = <span class="hljs-keyword">new</span> CSSBuilder(<span class="hljs-string">&quot;btn me-1&quot;</span>);

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnInitialized</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">if</span> (AuthTask <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Exception(<span class="hljs-string">$&quot;<span class="hljs-subst">{<span class="hljs-keyword">this</span>.GetType().FullName}</span> must have access to cascading Paramater <span class="hljs-subst">{<span class="hljs-keyword">nameof</span>(AuthTask)}</span>&quot;</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">BuildRenderTree</span>(<span class="hljs-params">RenderTreeBuilder builder</span>)</span>
    {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.Show &amp;&amp; <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.CheckPolicy())
        {
            CssClass.AddClassFromAttributes(SplatterAttributes);
            builder.OpenElement(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;button&quot;</span>);
            builder.AddMultipleAttributes(<span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.SplatterAttributes);
            builder.AddAttribute(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;class&quot;</span>, CssClass.Build());

            <span class="hljs-keyword">if</span> (Disabled)
                builder.AddAttribute(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;disabled&quot;</span>);

            <span class="hljs-keyword">if</span> (ClickEvent.HasDelegate)
                builder.AddAttribute(<span class="hljs-number">5</span>, <span class="hljs-string">&quot;onclick&quot;</span>, EventCallback.Factory.Create&lt;MouseEventArgs&gt;(<span class="hljs-keyword">this</span>, ClickEvent));

            builder.AddContent(<span class="hljs-number">6</span>, ChildContent);
            builder.CloseElement();
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">bool</span>&gt; <span class="hljs-title">CheckPolicy</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">var</span> state = <span class="hljs-keyword">await</span> AuthTask!;
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.AuthorizationService.AuthorizeAsync(state.User, <span class="hljs-literal">null</span>, Policy);
        <span class="hljs-keyword">return</span> result.Succeeded;
    }
}

</div></code></pre>
<p><code>AuthorizeRecordButton</code> extends <code>AuthorizeButton</code>.  It passes an <code>AppAuthFields</code> obect to <code>AuthorizeAsync</code> as the resource object.  We'll see how the <code>AuthorizationService</code> uses this shortly.</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AuthorizeRecordButton</span> : <span class="hljs-title">AuthorizeButton</span>
{
    [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> <span class="hljs-keyword">object</span>? AuthFields { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">bool</span>&gt; <span class="hljs-title">CheckPolicy</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">var</span> state = <span class="hljs-keyword">await</span> AuthTask!;
        <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.AuthorizationService.AuthorizeAsync(state.User, AuthFields, Policy);
        <span class="hljs-keyword">return</span> result.Succeeded;
    }
}
</div></code></pre>
<h3 id="policies">Policies</h3>
<p>It's important to understand the difference between a policy name and a policy object.  The Authorization service holds a map of policy names to policy objects.  When we provide a &quot;policy&quot; to an authorization component or call <code>AuthorizeAsync</code> on the <code>IAuthorizationService</code> we are providing the policy name.  It maps and uses the policy object associated with the policy name. The map is defined when the authorization services are set up in the application services collection in <code>Program</code>/<code>StartUp</code>.</p>
<p>Policy objects are defined as instances of the <code>AuthorizationPolicy</code> class and built using an <code>AuthorizationPolicyBuilder</code> instance.</p>
<p>The application defines a static <code>AppPolicies</code> class to hold and manage all the policy code.</p>
<ol>
<li>Defines a set of nomenclature constants for role and policy string names.</li>
<li>Builds out a set of policy objects using the <code>AuthorizationPolicyBuilder</code>.</li>
<li>Defines a dictionary of policy names to policy objects to load into <code>AuthorizationService</code>.</li>
<li>Defines an <code>IServiceCollection</code> extension method to add all the <code>IAuthorizationHandlers</code> required by the policies.</li>
</ol>
<p>The constants:</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StandardPolicies</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> AdminRole = <span class="hljs-string">&quot;AdminRole&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> UserRole = <span class="hljs-string">&quot;UserRole&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> VisitorRole = <span class="hljs-string">&quot;VisitorRole&quot;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> IsEditorPolicy = <span class="hljs-string">&quot;IsEditorPolicy&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> IsViewerPolicy = <span class="hljs-string">&quot;IsViewerPolicy&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> IsManagerPolicy = <span class="hljs-string">&quot;IsManagerPolicy&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> IsAdminPolicy = <span class="hljs-string">&quot;IsAdminPolicy&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> IsUserPolicy = <span class="hljs-string">&quot;IsUserPolicy&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> IsVisitor = <span class="hljs-string">&quot;IsVisitor&quot;</span>;
</div></code></pre>
<p>The basic Admin/User/Visitor site basded policy objects that check an identity is logged in and in one or more roles.</p>
<p>Note that for user to pass a policy they must satisfy all the requirements (an AND in logic terms).</p>
<pre><code class="language-csharp"><div>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthorizationPolicy IsAdminAuthorizationPolicy
        =&gt; <span class="hljs-keyword">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .RequireRole(AdminRole)
        .Build();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthorizationPolicy IsUserAuthorizationPolicy
        =&gt; <span class="hljs-keyword">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .RequireRole(AdminRole, UserRole)
        .Build();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthorizationPolicy IsVisitorAuthorizationPolicy
        =&gt; <span class="hljs-keyword">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .RequireRole(AdminRole, UserRole, VisitorRole)
        .Build();

</div></code></pre>
<p>The record based policies.  These use requirements, defined in an <code>IAuthorizationRequirement</code> list.  We'll look at  <code>RecordEditorAuthorizationRequirement</code> and <code>RecordManagerAuthorizationRequirement</code> shortly.</p>
<pre><code class="language-csharp"><div>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthorizationPolicy IsEditorAuthorizationPolicy
        =&gt; <span class="hljs-keyword">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .AddRequirements(<span class="hljs-keyword">new</span> RecordEditorAuthorizationRequirement())
        .Build();
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthorizationPolicy IsManagerAuthorizationPolicy
        =&gt; <span class="hljs-keyword">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .AddRequirements(<span class="hljs-keyword">new</span> RecordManagerAuthorizationRequirement())
        .Build();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> AuthorizationPolicy IsViewerAuthorizationPolicy
        =&gt; <span class="hljs-keyword">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .Build();
</div></code></pre>
<p>The <code>Policies</code> dictionary provides a convenient mechanism for defining and managing the application policies  <code>AuthorizationService</code> uses.</p>
<pre><code class="language-csharp"><div>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Dictionary&lt;<span class="hljs-keyword">string</span>, AuthorizationPolicy&gt; Policies
    {
        <span class="hljs-keyword">get</span>
        {
            <span class="hljs-keyword">var</span> policies = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">string</span>, AuthorizationPolicy&gt;();

            policies.Add(IsAdminPolicy, IsAdminAuthorizationPolicy);
            policies.Add(IsUserPolicy, IsUserAuthorizationPolicy);
            policies.Add(IsVisitor, IsVisitorAuthorizationPolicy);

            policies.Add(IsManagerPolicy, IsManagerAuthorizationPolicy);
            policies.Add(IsEditorPolicy, IsEditorAuthorizationPolicy);
            policies.Add(IsViewerPolicy, IsViewerAuthorizationPolicy);
            <span class="hljs-keyword">return</span> policies;
        }
    }
</div></code></pre>
<p>Finally an <code>IServiceCollection</code> extension to add the policy handler services.  More on these below.</p>
<pre><code class="language-csharp"><div>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">AddAppPolicyServices</span>(<span class="hljs-params"><span class="hljs-keyword">this</span> IServiceCollection services</span>)</span>
    {
        services.AddSingleton&lt;IAuthorizationHandler, RecordOwnerEditorAuthorizationHandler&gt;();
        services.AddSingleton&lt;IAuthorizationHandler, RecordEditorAuthorizationHandler&gt;();
        services.AddSingleton&lt;IAuthorizationHandler, RecordManagerAuthorizationHandler&gt;();
        services.AddSingleton&lt;IAuthorizationHandler, RecordOwnerManagerAuthorizationHandler&gt;();
    }
</div></code></pre>
<p>Using the <code>AppPolicies</code> class, we can now define our services in <code>Program</code> or an application <code>IServiceCollection</code> extension method like this:</p>
<pre><code class="language-csharp"><div>services.AddScoped&lt;AuthenticationStateProvider, VerySimpleAuthenticationStateProvider&gt;();
services.AddAppPolicyServices();
services.AddAuthorization(config =&gt;
{
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> policy <span class="hljs-keyword">in</span> AppPolicies.Policies)
    {
        config.AddPolicy(policy.Key, policy.Value);
    }
});
</div></code></pre>
<h3 id="authorization-requrements">Authorization Requrements</h3>
<p>Our policy object requirements are defined as classes implementing <code>IAuthorizationRequirement</code>.  <code>IAuthorizationRequirement</code> classes are empty reference classes.  We define two:</p>
<ol>
<li><code>RecordEditorAuthorizationRequirement</code> defines a record editor.</li>
<li><code>RecordManagerAuthorizationRequirement</code> defines a record manager.</li>
</ol>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RecordEditorAuthorizationRequirement</span> : <span class="hljs-title">IAuthorizationRequirement</span> { }
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RecordManagerAuthorizationRequirement</span> : <span class="hljs-title">IAuthorizationRequirement</span> { }
</div></code></pre>
<p>They are used by <code>IAuthorizationHandler</code> classes.</p>
<p>Requirements are assessed by the Policy on a OR logic basis.  An entity only needs satisfy one requirement of a collection to pass authorization.</p>
<h3 id="authorization-handlers">Authorization Handlers</h3>
<p>Authorization Handlers implement <code>IAuthorizationHandlers</code> and inherit from the  <code>AuthorizationHandler</code> base class.  The base class defines two generics:</p>
<ol>
<li><code>TRequirement</code> - The <code>AuthorizationRequirement</code> class that this <code>AuthorizationHandler</code> applies to.</li>
<li><code>TResource</code>, the resource type for the resource we will provide.  This is the <code>resource</code> object passed in <code>AuthorizationService.AuthorizeAsync</code>.  We pass <code>AppAuthFields</code> instances which we populate from a record.</li>
</ol>
<p>There are two mapped to each requirement.  The editor authorization handlers are shown below.</p>
<ol>
<li><code>TRequirement</code> is <code>RecordEditorAuthorizationRequirement</code></li>
<li><code>TResource</code> is <code>AppAuthFields</code>.</li>
<li><code>HandleRequirementAsync</code> is the method called to do the authorization.</li>
</ol>
<p><code>RecordOwnerEditorAuthorizationHandler</code>:</p>
<ol>
<li>Gets the user's Id from the <code>AuthorizationHandlerContext</code>.</li>
<li>Checks the Id against the <code>OwnerId</code> provided in the <code>AppAuthFields</code> instance</li>
<li>Sets success on the provided <code>AuthorizationHandlerContext</code> instance if the Ids match.</li>
</ol>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RecordOwnerEditorAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">RecordEditorAuthorizationRequirement</span>, <span class="hljs-title">AppAuthFields</span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, RecordEditorAuthorizationRequirement requirement, AppAuthFields data</span>)</span>
    {
        <span class="hljs-keyword">var</span> entityId = context.User.GetIdentityId();
        <span class="hljs-keyword">if</span> (entityId != Guid.Empty &amp;&amp; entityId == data.OwnerId)
            context.Succeed(requirement);

        <span class="hljs-keyword">return</span> Task.CompletedTask;
    }
}
</div></code></pre>
<p><code>RecordEditorAuthorizationHandler</code> simply checks if the identity has the correct role.  We apply this check as an Authorization handler because it needs to be an OR.  The identity can be either the owner and/or have a User Role.</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RecordEditorAuthorizationHandler</span> : <span class="hljs-title">AuthorizationHandler</span>&lt;<span class="hljs-title">RecordEditorAuthorizationRequirement</span>, <span class="hljs-title">AppAuthFields</span>&gt;
{
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">HandleRequirementAsync</span>(<span class="hljs-params">AuthorizationHandlerContext context, RecordEditorAuthorizationRequirement requirement, AppAuthFields data</span>)</span>
    {
        <span class="hljs-keyword">if</span> (context.User.IsInRole(AppPolicies.UserRole) || context.User.IsInRole(AppPolicies.AdminRole))
            context.Succeed(requirement);

        <span class="hljs-keyword">return</span> Task.CompletedTask;
    }
}
</div></code></pre>
<p><code>GetIdentityId</code> is an extension method on <code>ClaimsPrincipal</code></p>
<pre><code><code><div>public static Guid GetIdentityId(this ClaimsPrincipal principal)
{
    if (principal is not null)
    {
        var claim = principal.Claims.FirstOrDefault(claim =&gt; claim.Type == ClaimTypes.Sid);
        if (claim is not null &amp;&amp; Guid.TryParse(claim.Value, out Guid id))
            return id;
    }
    return Guid.Empty;
}
</div></code></code></pre>
<h3 id="so-how-does-a-policy-work">So how does a policy work?</h3>
<p>The services container defines a set of IAuthorizationHandlers.  Each is &quot;mapped&quot; by it's <code>TRequirement</code> to a specific requirement class.  A policy defines one or more requirements, and is mapped to a name in the <code>AuthorizationService</code>.</p>
<p>So when we do this:</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.AuthorizationService.AuthorizeAsync(state.User, AuthFields, Policy);
</div></code></pre>
<p>We are telling the authorization service to check the user against the policy with the following <code>AuthFields</code> instance.  The service maps the policy name to an actual policy and calls the policy.  It gets a list of all the <code>IAuthorizationHandler</code> instances in the services container that handle the defined requirement class.  It runs <code>HandleRequirementsAsync</code> on each: the order doesn't matter it's an OR.  It returns on the first success.</p>
<h2 id="service-based-authorization">Service based Authorization</h2>
<p>In the application we use a <code>WeatherForecastViewService</code> to provide the data operations to <code>FetchData</code>.  You can see the full code in the project code.</p>
<p>To apply authorization we need to inject <code>AuthenticationStateProvider</code> and <code>AuthorizationService</code>.</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">private</span> AuthenticationStateProvider AuthenticationStateProvider { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

<span class="hljs-keyword">private</span> IAuthorizationService AuthorizationService { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

<span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Message { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">WeatherForecastViewService</span>(<span class="hljs-params">IWeatherForecastDataBroker weatherForecastDataBroker, AuthenticationStateProvider authenticationState, IAuthorizationService authorizationService</span>)</span>
{ 
    <span class="hljs-keyword">this</span>.weatherForecastDataBroker = weatherForecastDataBroker;
    <span class="hljs-keyword">this</span>.AuthenticationStateProvider = authenticationState;
    <span class="hljs-keyword">this</span>.AuthorizationService = authorizationService;
}
</div></code></pre>
<p>And then use these in our CRUD methods:</p>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> ValueTask <span class="hljs-title">AddRecord</span>(<span class="hljs-params">WeatherForecast record</span>)</span>
{
    <span class="hljs-keyword">this</span>.Message = <span class="hljs-keyword">string</span>.Empty;
    <span class="hljs-keyword">var</span> authstate = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.AuthenticationStateProvider.GetAuthenticationStateAsync();
    <span class="hljs-keyword">var</span> result = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.AuthorizationService.AuthorizeAsync(authstate.User, <span class="hljs-literal">null</span>, AppPolicies.IsUserPolicy);
    <span class="hljs-keyword">if</span> (result.Succeeded)
    {
        <span class="hljs-keyword">await</span> weatherForecastDataBroker!.AddForecastAsync(<span class="hljs-keyword">record</span>);
        <span class="hljs-keyword">await</span> GetForecastsAsync();
    }
    <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">this</span>.Message = <span class="hljs-string">&quot;That Ain&#x27;t Allowed!&quot;</span>;
}
</div></code></pre>
<h1 id="appendix">Appendix</h1>
<h2 id="authentication">Authentication</h2>
<p>This article uses a very simple authentication provider that allows quick switching of the authentication context.  There's no passwords involved!</p>
<h3 id="test-identities">Test Identities</h3>
<p>Step one is to provide some test identities.</p>
<p>First a class for our identities:</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title">TestIdentity</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Name { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;
    <span class="hljs-keyword">public</span> Guid Id { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = Guid.Empty;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Role { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; } = <span class="hljs-keyword">string</span>.Empty;

    <span class="hljs-keyword">public</span> Claim[] Claims
        =&gt; <span class="hljs-keyword">new</span>[]{
            <span class="hljs-keyword">new</span> Claim(ClaimTypes.Sid, <span class="hljs-keyword">this</span>.Id.ToString()),
            <span class="hljs-keyword">new</span> Claim(ClaimTypes.Name, <span class="hljs-keyword">this</span>.Name),
            <span class="hljs-keyword">new</span> Claim(ClaimTypes.Role, <span class="hljs-keyword">this</span>.Role)
    };
}
</div></code></pre>
<p>The identities are held in a static class used throughout the application.</p>
<ol>
<li>The primary method is <code>GetIdentity</code>.  Pass in a user name and get back a <code>ClaimsIdentity</code> object.</li>
<li>The Guids used are simple made up ones: easy to reproduce in test weather records.</li>
<li>A role is set for each identity.</li>
</ol>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TestIdentities</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">string</span> Provider = <span class="hljs-string">&quot;Dumb Provider&quot;</span>;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ClaimsIdentity <span class="hljs-title">GetIdentity</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> userName</span>)</span>
    {
        <span class="hljs-keyword">var</span> identity = identities.FirstOrDefault(item =&gt; item.Name.Equals(userName, StringComparison.OrdinalIgnoreCase));
        <span class="hljs-keyword">if</span> (identity == <span class="hljs-literal">null</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ClaimsIdentity();

        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ClaimsIdentity(identity.Claims, Provider);
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">TestIdentity</span>&gt; identities</span> = <span class="hljs-keyword">new</span> List&lt;TestIdentity&gt;()
        {
            Visitor1Identity, 
            Visitor2Identity, 
            User1Identity, 
            User2Identity, 
            Admin1Identity, 
            Admin2Identity
        };

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;<span class="hljs-keyword">string</span>&gt; <span class="hljs-title">GetTestIdentities</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> List&lt;<span class="hljs-keyword">string</span>&gt; { <span class="hljs-string">&quot;None&quot;</span> };
        list.AddRange(identities.Select(identity =&gt; identity.Name!).ToList());
        <span class="hljs-keyword">return</span> list;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Dictionary&lt;Guid, <span class="hljs-keyword">string</span>&gt; <span class="hljs-title">TestIdentitiesDictionary</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> Dictionary&lt;Guid, <span class="hljs-keyword">string</span>&gt;();
        identities.ForEach(identity =&gt; list.Add(identity.Id, identity.Name));
        <span class="hljs-keyword">return</span> list;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TestIdentity User1Identity
        =&gt; <span class="hljs-keyword">new</span> TestIdentity
        {
            Id = <span class="hljs-keyword">new</span> Guid(<span class="hljs-string">&quot;10000000-0000-0000-0000-100000000001&quot;</span>),
            Name = <span class="hljs-string">&quot;User-1&quot;</span>,
            Role = <span class="hljs-string">&quot;UserRole&quot;</span>
        };

\\ .... more identities

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> TestIdentity Admin2Identity
        =&gt; <span class="hljs-keyword">new</span> TestIdentity
        {
            Id = <span class="hljs-keyword">new</span> Guid(<span class="hljs-string">&quot;10000000-0000-0000-0000-300000000002&quot;</span>),
            Name = <span class="hljs-string">&quot;Admin-2&quot;</span>,
            Role = <span class="hljs-string">&quot;AdminRole&quot;</span>
        };
}
</div></code></pre>
<p>The <code>AuthenticationStateProvider</code> looks like this.  <code>ChangeIdentityAsync</code> switches users based on the provided user name.</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">VerySimpleAuthenticationStateProvider</span> : <span class="hljs-title">AuthenticationStateProvider</span>
{
    ClaimsPrincipal? _user;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">override</span> Task&lt;AuthenticationState&gt; <span class="hljs-title">GetAuthenticationStateAsync</span>(<span class="hljs-params"></span>)</span>
        =&gt; Task.FromResult(<span class="hljs-keyword">new</span> AuthenticationState(_user ?? <span class="hljs-keyword">new</span> ClaimsPrincipal()));

    <span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;AuthenticationState&gt; <span class="hljs-title">ChangeIdentityAsync</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> username</span>)</span>
    {
        _user = <span class="hljs-keyword">new</span> ClaimsPrincipal(TestIdentities.GetIdentity(username));
        <span class="hljs-keyword">var</span> task = <span class="hljs-keyword">this</span>.GetAuthenticationStateAsync();
        <span class="hljs-keyword">this</span>.NotifyAuthenticationStateChanged(task);
        <span class="hljs-keyword">return</span> task;
    }
}
</div></code></pre>
<p>Finally the &quot;Log In Page&quot;.  In this case it's a simple select component in the top bar.  The select pulls the list of users from <code>TestIdentities</code> and calls <code>ChangeIdentityAsync</code> on the Authentication State Provider to switch users.</p>
<pre><code class="language-csharp"><div>@implements IDisposable
@namespace Blazr.Demo.Authorization.UI

&lt;span <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;me-2&quot;</span>&gt;Change User:&lt;/span&gt;
&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;w-25&quot;</span>&gt;
    &lt;<span class="hljs-keyword">select</span> id=<span class="hljs-string">&quot;userselect&quot;</span> <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> @onchange=<span class="hljs-string">&quot;ChangeUser&quot;</span>&gt;
        @foreach (<span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> <span class="hljs-keyword">in</span> TestIdentities.GetTestIdentities())
        {
            @if (<span class="hljs-keyword">value</span> == _currentUserName)
            {
                 &lt;option <span class="hljs-keyword">value</span>=<span class="hljs-string">&quot;@value&quot;</span> selected&gt;@value&lt;/option&gt;
            }
            <span class="hljs-keyword">else</span>
            {
                &lt;option <span class="hljs-keyword">value</span>=<span class="hljs-string">&quot;@value&quot;</span>&gt;@value&lt;/option&gt;
            }
        }
    &lt;/<span class="hljs-keyword">select</span>&gt;
&lt;/div&gt;
&lt;span <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;text-nowrap ms-3&quot;</span>&gt;
    &lt;AuthorizeView&gt;
        &lt;Authorized&gt;
            Hello, @(<span class="hljs-keyword">this</span>.user.Identity?.Name ?? <span class="hljs-keyword">string</span>.Empty)
        &lt;/Authorized&gt;
        &lt;NotAuthorized&gt;
            Not Logged In
        &lt;/NotAuthorized&gt;
    &lt;/AuthorizeView&gt;
&lt;/span&gt;

@code {
    [<span class="hljs-meta">CascadingParameter</span>] <span class="hljs-keyword">private</span> Task&lt;AuthenticationState&gt;? authTask { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> Task&lt;AuthenticationState&gt; AuthTask =&gt; authTask!;

    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> AuthenticationStateProvider? authState { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    <span class="hljs-keyword">private</span> VerySimpleAuthenticationStateProvider AuthState =&gt; (VerySimpleAuthenticationStateProvider)authState!;

    <span class="hljs-keyword">private</span> ClaimsPrincipal user = <span class="hljs-keyword">new</span> ClaimsPrincipal();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">string</span> _currentUserName = <span class="hljs-string">&quot;None&quot;</span>;

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnInitializedAsync</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">var</span> authState = <span class="hljs-keyword">await</span> AuthTask;
        <span class="hljs-keyword">this</span>.user = authState.User;
        AuthState.AuthenticationStateChanged += <span class="hljs-keyword">this</span>.OnUserChanged;
    }

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">ChangeUser</span>(<span class="hljs-params">ChangeEventArgs e</span>)</span>
        =&gt;  <span class="hljs-keyword">await</span> AuthState.ChangeIdentityAsync(e.Value?.ToString() ?? <span class="hljs-keyword">string</span>.Empty);

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnUserChanged</span>(<span class="hljs-params">Task&lt;AuthenticationState&gt; state</span>)</span>
        =&gt; <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.GetUser(state);

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">GetUser</span>(<span class="hljs-params">Task&lt;AuthenticationState&gt; state</span>)</span>
    {
        <span class="hljs-keyword">var</span> authState = <span class="hljs-keyword">await</span> state;
        <span class="hljs-keyword">this</span>.user = authState.User;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"></span>)</span>
        =&gt; AuthState.AuthenticationStateChanged -= <span class="hljs-keyword">this</span>.OnUserChanged;
    }
</div></code></pre>
<p>The component is used in <code>MainLayout</code>.</p>
<pre><code class="language-csharp"><div>@namespace Blazr.Demo.Authorization.UI
@inherits LayoutComponentBase

&lt;PageTitle&gt;Blazr.Demo&lt;/PageTitle&gt;

&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;page&quot;</span>&gt;
    &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;sidebar&quot;</span>&gt;
        &lt;NavMenu /&gt;
    &lt;/div&gt;

    &lt;main&gt;
        &lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;top-row px-4&quot;</span>&gt;
            &lt;UserBar /&gt;
            &lt;a href=<span class="hljs-string">&quot;https://docs.microsoft.com/aspnet/&quot;</span> target=<span class="hljs-string">&quot;_blank&quot;</span>&gt;About&lt;/a&gt;
        &lt;/div&gt;

        &lt;article <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;content px-4&quot;</span>&gt;
            @Body
        &lt;/article&gt;
    &lt;/main&gt;
&lt;/div&gt;
</div></code></pre>
<p>The control in action.</p>
<p><img src="\articles\assets\Policy-Based-Authentication\User-Select.png" alt="User Select"></p>
<h2 id="weather-forecast-ownership">Weather Forecast Ownership</h2>
<p>The <code>OwnerID</code> field is added to<code>WeatherForecast</code> and populated with either the <code>Visitor-1</code> or <code>Visitor-2</code> Guid.</p>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> List&lt;WeatherForecast&gt; <span class="hljs-title">CreateTestForecasts</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> count</span>)</span>
{
    <span class="hljs-keyword">var</span> list = <span class="hljs-keyword">new</span> List&lt;WeatherForecast&gt;();
    <span class="hljs-keyword">var</span> rng = <span class="hljs-keyword">new</span> Random();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">1</span>; i &lt;= count; i++)
    {
        <span class="hljs-keyword">var</span> c = rng.Next(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>);
        list.Add(<span class="hljs-keyword">new</span> WeatherForecast
        {
            Id = Guid.NewGuid(),
            OwnerId = <span class="hljs-keyword">new</span> Guid(<span class="hljs-string">$&quot;10000000-0000-0000-0000-20000000000<span class="hljs-subst">{c}</span>&quot;</span>),
            Date = DateTime.Now.AddDays(i),
            TemperatureC = rng.Next(<span class="hljs-number">-20</span>, <span class="hljs-number">55</span>),
            Summary = Summaries[rng.Next(Summaries.Length)]
        });
    }
    <span class="hljs-keyword">return</span> list;
}
</div></code></pre>

    

            </div>
        </div>
    </div>
</div>
<!-- end of Article Container -->


                </div>
                <!-- End of Main Content -->
            </div>
            <!-- Footer -->
            
<!-- Copyright -->
<footer class="sticky-footer bg-white">
    <div class="container my-auto">
        <div class="copyright text-center my-auto">
            
<span>Copyright &copy; Cold Elm Coders - 2022</span>

        </div>
    </div>
</footer>
<!-- end of copyright -->


            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
        
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>


    </div>
    <!-- End of Page Wrapper -->
    <!-- Scripts -->
    
<!-- Scripts -->
<!-- Bootstrap core JavaScript-->
<script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/assets/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/assets/js/sb-admin-2.min.js"></script>


</body>
</html>
