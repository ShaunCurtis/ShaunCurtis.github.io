<!DOCTYPE html>
<html lang="en">
<head>
    
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<!-- SEO Meta Tags -->
<meta name="description" content="Your description">
<meta name="author" content="Your name">

<!-- OG Meta Tags to improve the way the post looks when you share the page on Facebook, Twitter, LinkedIn -->
<meta property="og:site_name" content="" /> <!-- website name -->
<meta property="og:site" content="" /> <!-- website link -->
<meta property="og:title" content="" /> <!-- title shown in the actual shared post -->
<meta property="og:description" content="" /> <!-- description shown in the actual shared post -->
<meta property="og:image" content="" /> <!-- image link, make sure it's jpg -->
<meta property="og:url" content="" /> <!-- where do you want your post to link to -->
<meta name="twitter:card" content="summary_large_image"> <!-- to have large image post format in Twitter -->

<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


<meta name="description" content="How to build Blazor Edit Forms that manage state." >
<meta name="author" content="Shaun Curtis" >



<title>Managing Form Edit State in Blazor</title>


<!-- Custom fonts for this template-->
<link href="/assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
      rel="stylesheet">

<!-- Custom styles for this template-->
<link href="/assets/css/sb-admin-2.css" rel="stylesheet" type="text/css">
<link href="/assets/css/site.css" rel="stylesheet" type="text/css">

<!-- Favicon  -->
<link rel="icon" href="/assets/images/favicon.png">


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
    <link rel="stylesheet" href="/assets/css/article.css" type="text/css">
</head>
<body id="page-top">
    <!--topbar-->
    <div id="topbar">
        
<!-- Topbar -->
<nav class="navbar navbar-expand navbar-light topbar mb-4 static-top">
    
<ul class="navbar-nav" >
<li class="nav-item" >
<a class="nav-link " href="/index.html" role="button"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Index</span>
</a>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="c56afa46-4bd8-4e53-b18c-224e0df0924b" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Articles</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="c56afa46-4bd8-4e53-b18c-224e0df0924b" >
<a class="dropdown-item" href="/articles/A-Flexible-app.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Flexible App
</a>
<a class="dropdown-item" href="/articles/Async-Programming-in-DotNetCore.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Async Programming In Dotnetcore
</a>
<a class="dropdown-item" href="/articles/Blazor-AllinOne.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor All In One - Multi SPA Hosting
</a>
<a class="dropdown-item" href="/articles/Blazor-Async-Programming.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Async Programming
</a>
<a class="dropdown-item" href="/articles/Blazor-Components.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Components
</a>
<a class="dropdown-item" href="/articles/Blazor-CSS.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor CSS
</a>
<a class="dropdown-item" href="/articles/Blazor-DataList-Control.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Datalist Control
</a>
<a class="dropdown-item" href="/articles/Blazor-Form-Validation.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Form Validation
</a>
<a class="dropdown-item" href="/articles/BlazorAsyncProgramming.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazorasyncprogramming
</a>
<a class="dropdown-item" href="/articles/Building-Edit-Forms.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building Edit Forms
</a>
<a class="dropdown-item" href="/articles/EditFormState.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor EditFormState Control
</a>
<a class="dropdown-item" href="/articles/Hydra.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Hydra
</a>
<a class="dropdown-item" href="/articles/Inline-Dialog.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
The Blazor Inline Dialog Control
</a>
<a class="dropdown-item" href="/articles/Modal-Dialog.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Modal Dialog
</a>
<a class="dropdown-item" href="/articles/ValidationFormState.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
A Blazor Validation Control
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="16bdbd63-55cc-4967-829f-0bab791daf00" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Blazor Database Application</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="16bdbd63-55cc-4967-829f-0bab791daf00" >
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-1.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 1
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-2.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 2
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-3.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 3
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-4.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 4
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-5.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 5
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/Building-a-Database-Application-in-Blazor-Part-6.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building A Database Application In Blazor Part 6
</a>
<a class="dropdown-item" href="/Building-a-Database-Application-in-Blazor/index.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Building a Database Application in Blazor
</a>
</div>
</li>
<li class="nav-item dropdown no-arrow mx-1" >
<a class="nav-link dropdown-toggle" href="#" id="5b8f20d1-c0d1-474f-8dbc-125113088917" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"  >
<span class="mr-2 d-none d-lg-inline text-gray-100">Posts</span>
</a>
<div class=" dropdown-list dropdown-menu shadow animated--grow-in" aria-labelledby="5b8f20d1-c0d1-474f-8dbc-125113088917" >
<a class="dropdown-item" href="/posts/Blazor-Async-UI-Events.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Async UI Events
</a>
<a class="dropdown-item" href="/posts/DBContexts-In-Transient-Services.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Dbcontexts In Transient Services
</a>
<a class="dropdown-item" href="/posts/DynamicCss.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Blazor Dynamic Stylesheets
</a>
<a class="dropdown-item" href="/posts/For-ForEach-in-Blazor.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
For Foreach In Blazor
</a>
<a class="dropdown-item" href="/posts/Notification-Service-Pattern.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
Notification Service Pattern
</a>
<a class="dropdown-item" href="/posts/XML-XSD-Serialization.html" >
<i class="fas fa-file-alt fa-sm fa-fw mr-2 text-gray-600"></i>
XML XSD Serialization
</a>
</div>
</li>
</ul>

    <div class="ms-5 me-5 ml-auto">
        <h1>Cold Elm Coders</h1>
    </div>
</nav>


    </div>
    <!--End topbar-->
    <!--Sidebar-->
    <div id="sidebar">
        
<div class="article-info p-2" Published: 02-08-2021 >
<div>Published: 02-08-2021</div>
<div>Last Updated: 02-08-2021</div>
<div>Author: Shaun Curtis</div>
</div>

        
<h4 class="p-2">Table of Contents</h4>
<ul class="TOC" >
<li class="TOC-item TOC-item-0" >
<a class="TOC-link" href="#">Top</a>
<ul class="TOC TOC-0" >
<li class="TOC-item TOC-item-1" >
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#code-repository-and-demo-site">Code Repository and Demo Site</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#form-exits">Form Exits</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#form-edit-state">Form Edit State</a>
<ul class="TOC TOC-2" >
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#editstateservice">EditStateService</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#editformstate">EditFormState</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#extra-site-navigation">Extra Site Navigation</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#intra-site-navigation">Intra Site Navigation</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#routeviewmanager">RouteViewManager</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#adding-the-css">Adding the Css</a>
</li>
</ul>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#implementing-a-solution">Implementing a Solution</a>
<ul class="TOC TOC-2" >
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#solution">Solution</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#blazreditformsserver">Blazr.EditForms.Server</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#weatherforecasteditor">WeatherForecastEditor</a>
</li>
<li class="TOC-item TOC-item-3" >
<a class="TOC-link" href="#add-edit-state-control">Add Edit State Control</a>
</li>
</ul>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#using-the-inline-dialog">Using the Inline Dialog</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#the-solution-in-action">The Solution in Action</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>

    </div>
    <!--End Sidebar-->
    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <div id="article">
                    <!-- Article -->
                    
<!-- Header -->
<header class="ex-header-article">
    <div class="container">
        <div class="row pt-3 pb-3 border-bottom">
            <div class="col">
                
<h1>Managing Form Edit State in Blazor</h1>
<div>How to build Blazor Edit Forms that manage state.</div>

            </div> <!-- end of col -->
        </div> <!-- end of row -->
    </div> <!-- end of container -->
</header> <!-- end of ex-header -->
<!-- end of header -->


                    
<!-- Article Container -->
<div class="ex-basic-1 pt-4">
    <div class="container">
        <div class="row">
            <div class="col-12">
                

        <p>To set the context of this article, there have been many discussions, articles and proposals since Blazor was first released on how to handle edit forms. Specifically how to stop, or at least warn, the user when leaving a dirty form. The problem is not specific to Blazor: all Single Page Applications and Web Sites face the same challenges.</p>
<p>In a classic web form, every navigation is a get or a post back to the server. We can use the Browser <code>window.beforeunload</code> event to warn a user that they have unsaved data on the page. Not great, but at least something - we'll be using it later. This technique falls flat in SPAs. What looks to the outsider like a navigation event isn't. The NavigationManager intercepts any navigation attempt from the page, triggers its own LocationChanged event and sinks the request. The Router, wired into this event, does its wizardry, and loads the new component set into the page. No real browser navigation takes place, so there's nothing for the browser's beforeunload event to catch.</p>
<p>It's up to the programmer to write code that stops a user moving away from a dirty form. That's easier said than done when your application depends on the URL navigation pretext. Toolbars, navigation side bars and many buttons submit URLs to navigate around the application. Think of the out-of-the-box Blazor template. There's all the links in the left navigation, about in the top bar.</p>
<p>Personally, I have a serious issue with the whole routing charade: an SPA is an application, not a website, but I think I must be a minority of one! This article is for the majority.</p>
<p>All Blazor edit state solutions I've come across were cludges in one way or another, I've created more that one myself. What the community hoped for were changes in NetCore 5, specifically some extra functionality in NavigationManager to cancel or block navigation requests. That didn't happen: I don't think there was team concensus on the right solution, so we're back to square one.</p>
<p>What I cover in this article is my latest approach to the problem. It's not perfect, but I don't think we will ever get a near perfect solution until we get some new browser standards allowing a switch to SPA mode and control over toolbar navigation.</p>
<p>Our goal is to hit the user in one of two ways if they try and exit a dirty form.  There are no side doors!</p>
<p><img src="\articles\assets\Edit-Forms\Dirty-Exit.png" alt="Dirty Editor"></p>
<p><img src="\articles\assets\edit-forms\Dirty-App-Exit.png" alt="Dirty Editor"></p>
<h2 id="code-repository-and-demo-site">Code Repository and Demo Site</h2>
<p>The repository for the article is <a href="https://github.com/ShaunCurtis/Blazr.EditForms">here</a>.</p>
<p>You can see the code in this article in action on my Blazr Database demo site is here - <a href="https://cec-blazor-database.azurewebsites.net/">https://cec-blazor-database.azurewebsites.net/</a>.  There are straight, inline and modal dialog versions.</p>
<h2 id="form-exits">Form Exits</h2>
<p>There are three (controlled) ways a user can exit a form:</p>
<ol>
<li><strong>Intra Form Navigation</strong> - Clicking on an Exit button within the form.</li>
<li><strong>Intra Application Navigation</strong> - Clicking on a link in a navigation bar outside the form, clicking on the forward or back buttons on the browser.</li>
<li><strong>Extra Application Navigation</strong> - entering a new Url in the address bar, clicking on a favourite, closing the browser Tab or application.</li>
</ol>
<p>We have no control over killing the browser - say a reboot or system crash - so don't consider that here.</p>
<h2 id="form-edit-state">Form Edit State</h2>
<p>Before we can intelligently control edit form exits we need to know thwe state of the form - is the data in the form different from the record?  Out-of-the-box Blazor has no mechanisms to do this.  There is a very simplistic attempt at it in <code>EditContext</code>, but it's not fit-for-purpose.   We need an edit state manager.</p>
<p>This implementation uses two primary classes.</p>
<ol>
<li><code>EditStateService</code> - is a scoped service that holds the state of the current edit form during the SPA session.</li>
<li><code>EditFormState</code> - is a component that interacts with the <code>EditContext</code> within a form.  It stores the initial <code>Model</code> values in a <code>EditFieldCollection</code>, receives updates from the <code>EditContext</code> and updates the <code>EditStateService</code> as changes take place.</li>
</ol>
<h3 id="editstateservice">EditStateService</h3>
<p><code>EditStateService</code> is a scoped service state container that tracks the edit state of a form.  It has a set of methods to set and update state, and two events.</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">using</span> System;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Blazr.EditForms</span>
{
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;summary&gt;</span></span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> Service Class for managing Form Edit State</span>
    <span class="hljs-comment"><span class="hljs-doctag">///</span> <span class="hljs-doctag">&lt;/summary&gt;</span></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EditStateService</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> _isDirty;

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsDirty =&gt; _isDirty &amp;&amp; !<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(<span class="hljs-keyword">this</span>.Data) &amp;&amp; !<span class="hljs-keyword">string</span>.IsNullOrWhiteSpace(<span class="hljs-keyword">this</span>.Data);
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> Data { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> EditFormUrl { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> ShowEditForm =&gt; (!String.IsNullOrWhiteSpace(EditFormUrl)) &amp;&amp; IsDirty;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> DoFormReload { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> EventHandler RecordSaved;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">event</span> EventHandler&lt;EditStateEventArgs&gt; EditStateChanged;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetEditState</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> data, <span class="hljs-keyword">string</span> formUrl</span>)</span>
        {
            <span class="hljs-keyword">this</span>.Data = data;
            <span class="hljs-keyword">this</span>.EditFormUrl = formUrl;
            <span class="hljs-keyword">this</span>._isDirty = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearEditState</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">this</span>.Data = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">this</span>._isDirty = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.EditFormUrl = <span class="hljs-keyword">string</span>.Empty;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ResetEditState</span>(<span class="hljs-params"></span>)</span>
        {
            <span class="hljs-keyword">this</span>.Data = <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">this</span>._isDirty = <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">this</span>.EditFormUrl = <span class="hljs-keyword">string</span>.Empty;
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NotifyRecordSaved</span>(<span class="hljs-params"></span>)</span>
        {
            RecordSaved?.Invoke(<span class="hljs-keyword">this</span>, EventArgs.Empty);
            EditStateChanged?.Invoke(<span class="hljs-keyword">this</span>, EditStateEventArgs.NewArgs(<span class="hljs-literal">false</span>));
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NotifyRecordExit</span>(<span class="hljs-params"></span>)</span>
            =&gt; <span class="hljs-keyword">this</span>.NotifyRecordSaved();

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NotifyEditStateChanged</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> dirtyState</span>)</span>
            =&gt; EditStateChanged?.Invoke(<span class="hljs-keyword">this</span>, EditStateEventArgs.NewArgs(dirtyState));
    }
}
</div></code></pre>
<h4 id="editstateeventargs">EditStateEventArgs</h4>
<pre><code class="language-csharp"><div><span class="hljs-keyword">using</span> System;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Blazr.EditForms</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EditStateEventArgs</span> : <span class="hljs-title">EventArgs</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsDirty { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> EditStateEventArgs <span class="hljs-title">NewArgs</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> dirtyState</span>)</span>
            =&gt; <span class="hljs-keyword">new</span> EditStateEventArgs { IsDirty = dirtyState };
    }
}
</div></code></pre>
<h3 id="editformstate">EditFormState</h3>
<p><code>EditFormState</code> is a UI control with no UI output.  It's placed within an <code>EditForm</code> and captures the cascaded <code>EditContext</code>, and the <code>EditStateService</code> through dependency injection.  It exposes an <code>EditStateChanged</code> event and an <code>IsDirty</code> property.</p>
<p><code>EditFormState</code> reads all the write properties from the <code>EditContext</code> and saves them to an <code>EditFields</code> collection.</p>
<h5 id="editfield">EditField</h5>
<p><code>EditField</code> looks like this.  All but <code>EditedValue</code> are <code>init</code> record type properties.</p>
<pre><code class="language-csharp"><div>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EditField</span>
    {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">string</span> FieldName { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
        <span class="hljs-keyword">public</span> Guid GUID { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">object</span> Value { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">object</span> EditedValue { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">object</span> Model { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">init</span>; }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsDirty
        {
            <span class="hljs-keyword">get</span>
            {
                <span class="hljs-keyword">if</span> (Value != <span class="hljs-literal">null</span> &amp;&amp; EditedValue != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> !Value.Equals(EditedValue);
                <span class="hljs-keyword">if</span> (Value <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span> &amp;&amp; EditedValue <span class="hljs-keyword">is</span> <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">EditField</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> model, <span class="hljs-keyword">string</span> fieldName, <span class="hljs-keyword">object</span> <span class="hljs-keyword">value</span></span>)</span>
        {
            <span class="hljs-keyword">this</span>.Model = model;
            <span class="hljs-keyword">this</span>.FieldName = fieldName;
            <span class="hljs-keyword">this</span>.Value = <span class="hljs-keyword">value</span>;
            <span class="hljs-keyword">this</span>.EditedValue = <span class="hljs-keyword">value</span>;
            <span class="hljs-keyword">this</span>.GUID = Guid.NewGuid();
        }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Reset</span>(<span class="hljs-params"></span>)</span>
            =&gt; <span class="hljs-keyword">this</span>.EditedValue = <span class="hljs-keyword">this</span>.Value;
    }
</div></code></pre>
<h5 id="editfieldcollection">EditFieldCollection</h5>
<p><code>EditFieldCollection</code> implements <code>IEnumerable</code>.  It provides:</p>
<ol>
<li>An <code>IsDirty</code> property which checks the state of all the <code>EditFields</code> in the collection.</li>
<li>A set of getters and setters for adding and setting the edit state.</li>
</ol>
<pre><code class="language-csharp"><div>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EditFieldCollection</span> : <span class="hljs-title">IEnumerable</span>
    {
        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">List</span>&lt;<span class="hljs-title">EditField</span>&gt; _items</span> = <span class="hljs-keyword">new</span> List&lt;EditField&gt;();
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> Count =&gt; _items.Count;
        <span class="hljs-keyword">public</span> Action&lt;<span class="hljs-keyword">bool</span>&gt; FieldValueChanged;
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">bool</span> IsDirty =&gt; _items.Any(item =&gt; item.IsDirty);

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Clear</span>(<span class="hljs-params"></span>)</span>
            =&gt; _items.Clear();

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ResetValues</span>(<span class="hljs-params"></span>)</span>
            =&gt; _items.ForEach(item =&gt; item.Reset());
..... lots of getters and setters and IEnumerator implementation code
</div></code></pre>
<h4 id="editformstate-1">EditFormState</h4>
<p><code>EditFormState</code> Properties/Fields</p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">EditFormState</span> : <span class="hljs-title">ComponentBase</span>, <span class="hljs-title">IDisposable</span>
{
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> disposedValue;
    <span class="hljs-keyword">private</span> EditFieldCollection EditFields = <span class="hljs-keyword">new</span> EditFieldCollection();

    [<span class="hljs-meta">CascadingParameter</span>] <span class="hljs-keyword">public</span> EditContext EditContext { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> EditStateService EditStateService { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> IJSRuntime _js { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> NavigationManager NavManager { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

</div></code></pre>
<p>When <code>EditFormState</code> initilaises it:</p>
<ol>
<li>Loads the <code>EditFields</code> from <code>EditContext.Model</code>.</li>
<li>Checks the <code>EditStateService</code> and if it's dirty gets and deserializes <code>Data</code>.</li>
<li>Sets the <code>EditedValue</code> for each <code>EditField</code> to the deserialized <code>Data</code> value.</li>
<li>Applies the saved <code>Data</code> values back to the <code>EditContext.Model</code>.</li>
<li>Hooks up <code>FieldChanged</code> to <code>OnFieldChanged</code> on <code>EditContext</code> to receive user edits.</li>
<li>Hooks up <code>OnSave</code> to <code>RecordSaved</code> on <code>EditStateService</code> to know when to reset.</li>
</ol>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> Task <span class="hljs-title">OnInitializedAsync</span>(<span class="hljs-params"></span>)</span>
{
    Debug.Assert(<span class="hljs-keyword">this</span>.EditContext != <span class="hljs-literal">null</span>);

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.EditContext != <span class="hljs-literal">null</span>)
    {
        <span class="hljs-comment">// Populates the EditField Collection</span>
        <span class="hljs-keyword">this</span>.LoadEditState();
        <span class="hljs-comment">// Wires up to the EditContext OnFieldChanged event</span>
        <span class="hljs-keyword">this</span>.EditContext.OnFieldChanged += <span class="hljs-keyword">this</span>.FieldChanged;
        <span class="hljs-keyword">this</span>.EditStateService.RecordSaved += <span class="hljs-keyword">this</span>.OnSave;
    }
    <span class="hljs-keyword">return</span> Task.CompletedTask;
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadEditState</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">this</span>.GetEditFields();
    <span class="hljs-keyword">if</span> (EditStateService.IsDirty)
        SetEditState();
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">GetEditFields</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">this</span>.EditContext.Model;
    <span class="hljs-keyword">this</span>.EditFields.Clear();
    <span class="hljs-keyword">if</span> (model <span class="hljs-keyword">is</span> not <span class="hljs-literal">null</span>)
    {
        <span class="hljs-keyword">var</span> props = model.GetType().GetProperties();
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> prop <span class="hljs-keyword">in</span> props)
        {
            <span class="hljs-keyword">if</span> (prop.CanWrite)
            {
                <span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> = prop.GetValue(model);
                EditFields.AddField(model, prop.Name, <span class="hljs-keyword">value</span>);
            }
        }
    }
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetEditState</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">var</span> recordtype = <span class="hljs-keyword">this</span>.EditContext.Model.GetType();
    <span class="hljs-keyword">object</span> data = JsonSerializer.Deserialize(EditStateService.Data, recordtype);
    <span class="hljs-keyword">if</span> (data <span class="hljs-keyword">is</span> not <span class="hljs-literal">null</span>)
    {
        <span class="hljs-keyword">var</span> props = data.GetType().GetProperties();
        <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> property <span class="hljs-keyword">in</span> props)
        {
            <span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> = property.GetValue(data);
            EditFields.SetField(property.Name, <span class="hljs-keyword">value</span>);
        }
        <span class="hljs-keyword">this</span>.SetModelToEditState();
        <span class="hljs-keyword">if</span> (EditFields.IsDirty)
            <span class="hljs-keyword">this</span>.NotifyEditStateChanged();
    }
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetModelToEditState</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">var</span> model = <span class="hljs-keyword">this</span>.EditContext.Model;
    <span class="hljs-keyword">var</span> props = model.GetType().GetProperties();
    <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> property <span class="hljs-keyword">in</span> props)
    {
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> = EditFields.GetEditValue(property.Name);
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">value</span> <span class="hljs-keyword">is</span> not <span class="hljs-literal">null</span> &amp;&amp; property.CanWrite)
            property.SetValue(model, <span class="hljs-keyword">value</span>);
    }
}
</div></code></pre>
<p><code>FieldChanged</code> is triggered by the user changing a value in the form. It:</p>
<ol>
<li>Reads the current <code>IsDirty</code>.</li>
<li>Gets the property and new value from the <code>FieldChangedEventArgs</code>.</li>
<li>Sets the <code>EditField</code> in the <code>EditFieldCollection</code>.</li>
<li>Checks if the Edit State has changed and if so invokes the <code>EditStateChanged</code> event.</li>
<li>Updates the <code>EditStateService</code> edit state.  Either updates it if the edit state is dirty or clears it if the edit state is clean.</li>
<li>Sets/resets the <code>PageExitCheck</code> if there is a edit state change - more later.</li>
</ol>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">FieldChanged</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, FieldChangedEventArgs e</span>)</span>
{
    <span class="hljs-keyword">var</span> wasDirty = EditFields?.IsDirty ?? <span class="hljs-literal">false</span>;
    <span class="hljs-comment">// Get the PropertyInfo object for the model property</span>
    <span class="hljs-comment">// Uses reflection to get property and value</span>
    <span class="hljs-keyword">var</span> prop = e.FieldIdentifier.Model.GetType().GetProperty(e.FieldIdentifier.FieldName);
    <span class="hljs-keyword">if</span> (prop != <span class="hljs-literal">null</span>)
    {
        <span class="hljs-comment">// Get the value for the property</span>
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">value</span> = prop.GetValue(e.FieldIdentifier.Model);
        <span class="hljs-comment">// Sets the edit value in the EditField</span>
        EditFields.SetField(e.FieldIdentifier.FieldName, <span class="hljs-keyword">value</span>);
        <span class="hljs-comment">// Invokes EditStateChanged if changed</span>
        <span class="hljs-keyword">var</span> isStateChange = (EditFields?.IsDirty ?? <span class="hljs-literal">false</span>) != wasDirty;
        <span class="hljs-keyword">var</span> isDirty = EditFields?.IsDirty ?? <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">if</span> (isStateChange)
            <span class="hljs-keyword">this</span>.NotifyEditStateChanged();
        <span class="hljs-keyword">if</span> (isDirty)
            <span class="hljs-keyword">this</span>.SaveEditState(isStateChange);
        <span class="hljs-keyword">else</span>
            <span class="hljs-keyword">this</span>.ClearEditState();
    }
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SaveEditState</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> isStateChange</span>)</span>
{
    <span class="hljs-keyword">if</span> (isStateChange)
        <span class="hljs-keyword">this</span>.SetPageExitCheck(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> jsonData = JsonSerializer.Serialize(<span class="hljs-keyword">this</span>.EditContext.Model);
    EditStateService.SetEditState(jsonData, NavManager.Uri);
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearEditState</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">this</span>.SetPageExitCheck(<span class="hljs-literal">false</span>);
    EditStateService.ClearEditState();
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetPageExitCheck</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> action</span>)</span>
    =&gt; _js.InvokeAsync&lt;<span class="hljs-keyword">bool</span>&gt;(<span class="hljs-string">&quot;blazr_setEditorExitCheck&quot;</span>, action);
</div></code></pre>
<ol>
<li><code>OnSave</code> clears the current edit state and reloads <code>EditFields</code> from the update <code>model</code>.</li>
<li><code>NotifyEditStateChanged</code> notifies <code>EditStateService</code> that the edit state has changed.  This raises the <code>EditStateChanged</code> event.</li>
<li><code>Dispose</code> tidies up.</li>
</ol>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnSave</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EventArgs e</span>)</span>
{
    <span class="hljs-keyword">this</span>.ClearEditState();
    <span class="hljs-keyword">this</span>.LoadEditState();
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">NotifyEditStateChanged</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">var</span> isDirty = EditFields?.IsDirty ?? <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">this</span>.EditStateService.NotifyEditStateChanged(isDirty);
}

<span class="hljs-comment">// IDisposable Implementation</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">virtual</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> disposing</span>)</span>
{
    <span class="hljs-keyword">if</span> (!disposedValue)
    {
        <span class="hljs-keyword">if</span> (disposing)
        {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.EditContext != <span class="hljs-literal">null</span>)
                <span class="hljs-keyword">this</span>.EditContext.OnFieldChanged -= <span class="hljs-keyword">this</span>.FieldChanged;
        }
        <span class="hljs-keyword">this</span>.EditStateService.RecordSaved -= <span class="hljs-keyword">this</span>.OnSave;
        disposedValue = <span class="hljs-literal">true</span>;
    }
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-comment">// Do not change this code. Put cleanup code in &#x27;Dispose(bool disposing)&#x27; method</span>
    Dispose(disposing: <span class="hljs-literal">true</span>);
    GC.SuppressFinalize(<span class="hljs-keyword">this</span>);
}
</div></code></pre>
<h3 id="extra-site-navigation">Extra Site Navigation</h3>
<p>This occurs when the user tries to leave the site - closing the browser tab, or clicking on a favourite.  There is no way to stop this directly in Blazor - there's no raised event to link into.  However, the browser does have an event <code>beforeunload</code>.  You don't have much control over it, but you can tell the browser to ask the user if they wish to exit the page.</p>
<p><em>site.js</em> defines two functions for adding/removing the event from the browser <code>window</code> object.</p>
<pre><code class="language-js"><div><span class="hljs-built_in">window</span>.blazr_setEditorExitCheck = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">show</span>) </span>{
    <span class="hljs-keyword">if</span> (show) {
        <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">&quot;beforeunload&quot;</span>, blazr_showExitDialog);
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">&quot;beforeunload&quot;</span>, blazr_showExitDialog);
    }
}

<span class="hljs-built_in">window</span>.blazr_showExitDialog = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
    event.preventDefault();
    event.returnValue = <span class="hljs-string">&quot;There are unsaved changes on this page.  Do you want to leave?&quot;</span>;
}
</div></code></pre>
<p>This can then be called from Blazor:</p>
<pre><code class="language-csharp"><div>[<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> IJSRuntime _js { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetPageExitCheck</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> action</span>)</span>
    =&gt; _js.InvokeAsync&lt;<span class="hljs-keyword">bool</span>&gt;(<span class="hljs-string">&quot;blazr_setEditorExitCheck&quot;</span>, action);

</div></code></pre>
<p><code>SetPageExitCheck</code> is used in setting and clearing the edit state in <code>EditFormState</code></p>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SaveEditState</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> isStateChange</span>)</span>
{
    <span class="hljs-keyword">if</span> (isStateChange)
        <span class="hljs-keyword">this</span>.SetPageExitCheck(<span class="hljs-literal">true</span>);
    <span class="hljs-keyword">var</span> jsonData = JsonSerializer.Serialize(<span class="hljs-keyword">this</span>.EditContext.Model);
    EditStateService.SetEditState(jsonData, NavManager.Uri);
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ClearEditState</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">this</span>.SetPageExitCheck(<span class="hljs-literal">false</span>);
    EditStateService.ClearEditState();
}
</div></code></pre>
<p>and in <code>WeatherEditor</code> to clear the edit state on exitting the form.</p>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Exit</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">this</span>.EditStateService.ResetEditState();
    <span class="hljs-keyword">this</span>.SetPageExitCheck(<span class="hljs-literal">false</span>);
    NavManager.NavigateTo(<span class="hljs-string">&quot;/fetchdata&quot;</span>);
}
</div></code></pre>
<h3 id="intra-site-navigation">Intra Site Navigation</h3>
<p>Intra site navigation is handled by the <code>Router</code> defined in <code>App</code>.  The actual rendering is handled by <code>RouteView</code>.  This is a simpler component to modify than the router.  Our revised process for <code>RouteView</code> looks like this:</p>
<p><img src="\articles\assets\edit-forms\RouteViewManager.png" alt="RouteViewManager"></p>
<h3 id="routeviewmanager">RouteViewManager</h3>
<p><code>RouteViewManager</code> is based on <code>RouteView</code>.  Most of the code is lifted directly from that component.  There's no Razor code, the Html is build directly using <code>RenderFragments</code> and <code>RenderTreeBuilder</code></p>
<pre><code class="language-csharp"><div><span class="hljs-keyword">using</span> Microsoft.AspNetCore.Components;
<span class="hljs-keyword">using</span> Microsoft.AspNetCore.Components.Web;
<span class="hljs-keyword">using</span> Microsoft.JSInterop;
<span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Collections.Generic;
<span class="hljs-keyword">using</span> System.Reflection;
<span class="hljs-keyword">using</span> System.Threading.Tasks;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">Blazr.EditForms</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">RouteViewManager</span> : <span class="hljs-title">IComponent</span>
    {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> _RenderEventQueued;
        <span class="hljs-keyword">private</span> RenderHandle _renderHandle;

        [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> EditStateService EditStateService { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> IJSRuntime _js { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [<span class="hljs-meta">Inject</span>] <span class="hljs-keyword">private</span> NavigationManager NavManager { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> RouteData RouteData { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        [<span class="hljs-meta">Parameter</span>] <span class="hljs-keyword">public</span> Type DefaultLayout { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Attach</span>(<span class="hljs-params">RenderHandle renderHandle</span>)</span>
            =&gt; _renderHandle = renderHandle;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">SetParametersAsync</span>(<span class="hljs-params">ParameterView parameters</span>)</span>
        {
            <span class="hljs-comment">// Sets the component parameters</span>
            parameters.SetParameterProperties(<span class="hljs-keyword">this</span>);

            <span class="hljs-comment">// Check if we have either RouteData or ViewData</span>
            <span class="hljs-keyword">if</span> (RouteData == <span class="hljs-literal">null</span>)
            {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> InvalidOperationException(<span class="hljs-string">$&quot;The <span class="hljs-subst">{<span class="hljs-keyword">nameof</span>(RouteView)}</span> component requires a non-null value for the parameter <span class="hljs-subst">{<span class="hljs-keyword">nameof</span>(RouteData)}</span>.&quot;</span>);
            }
            <span class="hljs-comment">// Render the component</span>
            <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.RenderAsync();
        }

        <span class="hljs-keyword">private</span> RenderFragment _renderDelegate =&gt; builder =&gt;
        {
            _RenderEventQueued = <span class="hljs-literal">false</span>;
            <span class="hljs-comment">// Adds cascadingvalue for the ViewManager</span>
            builder.OpenComponent&lt;CascadingValue&lt;RouteViewManager&gt;&gt;(<span class="hljs-number">0</span>);
            builder.AddAttribute(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Value&quot;</span>, <span class="hljs-keyword">this</span>);
            <span class="hljs-comment">// Get the layout render fragment</span>
            builder.AddAttribute(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;ChildContent&quot;</span>, <span class="hljs-keyword">this</span>._layoutViewFragment);
            builder.CloseComponent();
        };

        <span class="hljs-keyword">private</span> RenderFragment _layoutViewFragment =&gt; builder =&gt;
        {
            Type _pageLayoutType = RouteData?.PageType.GetCustomAttribute&lt;LayoutAttribute&gt;()?.LayoutType
                ?? DefaultLayout;

            builder.OpenComponent&lt;LayoutView&gt;(<span class="hljs-number">0</span>);
            builder.AddAttribute(<span class="hljs-number">1</span>, <span class="hljs-keyword">nameof</span>(LayoutView.Layout), _pageLayoutType);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.EditStateService.IsDirty &amp;&amp; <span class="hljs-keyword">this</span>.EditStateService.DoFormReload <span class="hljs-keyword">is</span> not <span class="hljs-literal">true</span>)
                builder.AddAttribute(<span class="hljs-number">2</span>, <span class="hljs-keyword">nameof</span>(LayoutView.ChildContent), _dirtyExitFragment);
            <span class="hljs-keyword">else</span>
            {
                <span class="hljs-keyword">this</span>.EditStateService.DoFormReload = <span class="hljs-literal">false</span>;
                builder.AddAttribute(<span class="hljs-number">3</span>, <span class="hljs-keyword">nameof</span>(LayoutView.ChildContent), _renderComponentWithParameters);
            }
            builder.CloseComponent();
        };

        <span class="hljs-keyword">private</span> RenderFragment _dirtyExitFragment =&gt; builder =&gt;
        {
            builder.OpenElement(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;div&quot;</span>);
            builder.AddAttribute(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;dirty-exit&quot;</span>);
            {
                builder.OpenElement(<span class="hljs-number">2</span>, <span class="hljs-string">&quot;div&quot;</span>);
                builder.AddAttribute(<span class="hljs-number">3</span>, <span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;dirty-exit-message&quot;</span>);
                builder.AddContent(<span class="hljs-number">4</span>, <span class="hljs-string">&quot;You are existing a form with unsaved data&quot;</span>);
                builder.CloseElement();
            }
            {
                builder.OpenElement(<span class="hljs-number">5</span>, <span class="hljs-string">&quot;div&quot;</span>);
                builder.AddAttribute(<span class="hljs-number">6</span>, <span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;dirty-exit-message&quot;</span>);
                {
                    builder.OpenElement(<span class="hljs-number">7</span>, <span class="hljs-string">&quot;button&quot;</span>);
                    builder.AddAttribute(<span class="hljs-number">8</span>, <span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;dirty-exit-button&quot;</span>);
                    builder.AddAttribute(<span class="hljs-number">9</span>, <span class="hljs-string">&quot;onclick&quot;</span>, EventCallback.Factory.Create&lt;MouseEventArgs&gt;(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.DirtyExit));
                    builder.AddContent(<span class="hljs-number">10</span>, <span class="hljs-string">&quot;Exit and Clear Unsaved Data&quot;</span>);
                    builder.CloseElement();
                }
                {
                    builder.OpenElement(<span class="hljs-number">11</span>, <span class="hljs-string">&quot;button&quot;</span>);
                    builder.AddAttribute(<span class="hljs-number">12</span>, <span class="hljs-string">&quot;class&quot;</span>, <span class="hljs-string">&quot;load-dirty-form-button&quot;</span>);
                    builder.AddAttribute(<span class="hljs-number">13</span>, <span class="hljs-string">&quot;onclick&quot;</span>, EventCallback.Factory.Create&lt;MouseEventArgs&gt;(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.LoadDirtyForm));
                    builder.AddContent(<span class="hljs-number">14</span>, <span class="hljs-string">&quot;Reload Form&quot;</span>);
                    builder.CloseElement();
                }
                builder.CloseElement();
            }
            builder.CloseElement();
        };

        <span class="hljs-keyword">private</span> RenderFragment _renderComponentWithParameters =&gt; builder =&gt;
        {
            Type componentType = <span class="hljs-literal">null</span>;
            IReadOnlyDictionary&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">object</span>&gt; parameters = <span class="hljs-keyword">new</span> Dictionary&lt;<span class="hljs-keyword">string</span>, <span class="hljs-keyword">object</span>&gt;();

            <span class="hljs-keyword">if</span> (RouteData != <span class="hljs-literal">null</span>)
            {
                componentType = RouteData.PageType;
                parameters = RouteData.RouteValues;
            }

            <span class="hljs-keyword">if</span> (componentType != <span class="hljs-literal">null</span>)
            {
                builder.OpenComponent(<span class="hljs-number">0</span>, componentType);
                <span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> kvp <span class="hljs-keyword">in</span> parameters)
                {
                    builder.AddAttribute(<span class="hljs-number">1</span>, kvp.Key, kvp.Value);
                }
                builder.CloseComponent();
            }
            <span class="hljs-keyword">else</span>
            {
                builder.OpenElement(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;div&quot;</span>);
                builder.AddContent(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;No Route or View Configured to Display&quot;</span>);
                builder.CloseElement();
            }
        };

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">RenderAsync</span>(<span class="hljs-params"></span>)</span> =&gt; <span class="hljs-keyword">await</span> InvokeAsync(() =&gt;
        {
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._RenderEventQueued)
            {
                <span class="hljs-keyword">this</span>._RenderEventQueued = <span class="hljs-literal">true</span>;
                _renderHandle.Render(_renderDelegate);
            }
        }
        );

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Task <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params">Action workItem</span>)</span>
            =&gt; _renderHandle.Dispatcher.InvokeAsync(workItem);

        <span class="hljs-function"><span class="hljs-keyword">protected</span> Task <span class="hljs-title">InvokeAsync</span>(<span class="hljs-params">Func&lt;Task&gt; workItem</span>)</span>
            =&gt; _renderHandle.Dispatcher.InvokeAsync(workItem);

        <span class="hljs-function"><span class="hljs-keyword">private</span> Task <span class="hljs-title">DirtyExit</span>(<span class="hljs-params">MouseEventArgs d</span>)</span>
        {
            <span class="hljs-keyword">this</span>.EditStateService.ClearEditState();
            <span class="hljs-keyword">this</span>.SetPageExitCheck(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span> RenderAsync();
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">LoadDirtyForm</span>(<span class="hljs-params">MouseEventArgs e</span>)</span>
        {
            <span class="hljs-keyword">this</span>.EditStateService.DoFormReload = <span class="hljs-literal">true</span>;
            NavManager.NavigateTo(<span class="hljs-keyword">this</span>.EditStateService.EditFormUrl);
        }

        <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">SetPageExitCheck</span>(<span class="hljs-params"><span class="hljs-keyword">bool</span> action</span>)</span>
            =&gt; _js.InvokeAsync&lt;<span class="hljs-keyword">bool</span>&gt;(<span class="hljs-string">&quot;cecblazor_setEditorExitCheck&quot;</span>, action);
    }
}
</div></code></pre>
<p>The component has two button event handlers to handle the two dirty form options:</p>
<ol>
<li><code>DirtyExit</code></li>
<li><code>LoadDirtyForm</code></li>
</ol>
<p>and <code>SetPageExitCheck</code> to set the browser page exit event.</p>
<p>The RenderFragement code builds out the layout which adds either <code>_dirtyExitFragment</code> to build the Dirty Exit View or <code>_renderComponentWithParameters</code> to build out the route/view component.</p>
<h3 id="adding-the-css">Adding the Css</h3>
<p>Add the following Css to one of the referenced Css files.  In the solution it's in a standalone <em>site.css</em> in the library project.</p>
<pre><code class="language-css"><div><span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.dirty-exit</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">400px</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">10px</span> auto <span class="hljs-number">10px</span> auto;
}

<span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.dirty-exit-message</span> {
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1.5rem</span>;
    <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">600</span>;
    <span class="hljs-attribute">font-variant</span>: small-caps;
}

<span class="hljs-selector-tag">div</span><span class="hljs-selector-class">.dirty-exit</span> <span class="hljs-selector-tag">button</span> {
    <span class="hljs-attribute">display</span>: inline-block;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">400</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">vertical-align</span>: middle;
    <span class="hljs-attribute">padding</span>: .<span class="hljs-number">4rem</span> .<span class="hljs-number">75rem</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">1rem</span>;
    <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">border-style</span>: none;
}

<span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.dirty-exit-button</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#e74a3b</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#e74a3b</span>;
}

<span class="hljs-selector-tag">button</span><span class="hljs-selector-class">.load-dirty-form-button</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#1cc88a</span>;
    <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#1cc88a</span>;
}
</div></code></pre>
<h2 id="implementing-a-solution">Implementing a Solution</h2>
<h3 id="solution">Solution</h3>
<p>Create a Blazor solution from the Server Template.</p>
<ul>
<li>Solution Name: <em>Blazr.EditForms</em></li>
<li>Project Name: <em>Blazr.EditForms.Server</em></li>
</ul>
<p>Add a Razor Library Template project - <em>Blazr.EditForms</em>.  Copy all the code from my Repo.</p>
<h3 id="blazreditformsserver">Blazr.EditForms.Server</h3>
<p>Update <code>Startup</code></p>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ConfigureServices</span>(<span class="hljs-params">IServiceCollection services</span>)</span>
{
    ....
    services.AddSingleton&lt;WeatherForecastService&gt;();
    <span class="hljs-comment">// Add the EditStateService</span>
    services.AddScoped&lt;EditStateService&gt;();
}
</div></code></pre>
<p>Update <code>WeatherForecastService</code></p>
<pre><code class="language-csharp"><div><span class="hljs-comment">// Add a method to get a dummy record</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Task&lt;WeatherForecast&gt; <span class="hljs-title">GetWeatherForecastAsync</span>(<span class="hljs-params">Guid Id</span>)</span>
{
    <span class="hljs-keyword">return</span> Task.FromResult(<span class="hljs-keyword">new</span> WeatherForecast
    {
        Date = DateTime.Now,
        TemperatureC = <span class="hljs-number">12</span>,
        Summary = <span class="hljs-string">&quot;Balmy&quot;</span>
    });
}
</div></code></pre>
<p>Update <code>_Hosts.cshtml</code></p>
<pre><code class="language-csharp"><div>&lt;head&gt;
    <span class="hljs-comment">// extra stylesheets</span>
    &lt;link href=<span class="hljs-string">&quot;/_content/Blazr.EditForms/site.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> /&gt;
    &lt;link href=<span class="hljs-string">&quot;/Blazr.EditForms.Server.styles.css&quot;</span> rel=<span class="hljs-string">&quot;stylesheet&quot;</span> /&gt;
&lt;/head&gt;
.....
    <span class="hljs-comment">// site Js</span>
    &lt;script src=<span class="hljs-string">&quot;/_content/Blazr.EditForms/site.js&quot;</span>&gt;&lt;/script&gt;
&lt;/body&gt;
</div></code></pre>
<p>Update <code>NavMenu</code></p>
<pre><code class="language-csharp"><div><span class="hljs-comment">// Add two more links</span>
&lt;li <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-item px-3&quot;</span>&gt;
    &lt;NavLink <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link&quot;</span> href=<span class="hljs-string">&quot;WeatherForecastEditor&quot;</span>&gt;
        &lt;span <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;oi oi-list-rich&quot;</span> aria-hidden=<span class="hljs-string">&quot;true&quot;</span>&gt;&lt;/span&gt; Editor
    &lt;/NavLink&gt;
&lt;/li&gt;
&lt;li <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-item px-3&quot;</span>&gt;
    &lt;NavLink <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;nav-link&quot;</span> href=<span class="hljs-string">&quot;InlineWeatherForecastEditor&quot;</span>&gt;
        &lt;span <span class="hljs-keyword">class</span>=<span class="hljs-string">&quot;oi oi-list-rich&quot;</span> aria-hidden=<span class="hljs-string">&quot;true&quot;</span>&gt;&lt;/span&gt; Inline Editor
    &lt;/NavLink&gt;
&lt;/li&gt;
</div></code></pre>
<p>Update <code>App.razor</code>, changing out <code>RouteView</code> for <code>RouteViewManager</code>.</p>
<pre><code class="language-html"><div>....
<span class="hljs-tag">&lt;<span class="hljs-name">Found</span> <span class="hljs-attr">Context</span>=<span class="hljs-string">&quot;routeData&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">RouteViewManager</span> <span class="hljs-attr">RouteData</span>=<span class="hljs-string">&quot;@routeData&quot;</span> <span class="hljs-attr">DefaultLayout</span>=<span class="hljs-string">&quot;@typeof(MainLayout)&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Found</span>&gt;</span>
....
</div></code></pre>
<h3 id="weatherforecasteditor">WeatherForecastEditor</h3>
<p>Our base editor form looks like this.  This will work as is, but there's not edit state and no exit/navigation control.</p>
<pre><code class="language-html"><div>@page &quot;/WeatherForecastEditor&quot;

@using Blazr.EditForms.Server.Data
@implements IDisposable

<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>Weather Forecast Editor<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">EditForm</span> <span class="hljs-attr">Model</span>=<span class="hljs-string">&quot;record&quot;</span> <span class="hljs-attr">OnValidSubmit</span>=<span class="hljs-string">&quot;SaveRecord&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;</span>Date<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">InputDate</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> @<span class="hljs-attr">bind-Value</span>=<span class="hljs-string">&quot;record.Date&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;valid-feedback&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ValidationMessage</span> <span class="hljs-attr">For</span>=<span class="hljs-string">&quot;() =&gt; record.Date&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;</span>Temperature<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">InputNumber</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> @<span class="hljs-attr">bind-Value</span>=<span class="hljs-string">&quot;record.TemperatureC&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;valid-feedback&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ValidationMessage</span> <span class="hljs-attr">For</span>=<span class="hljs-string">&quot;() =&gt; record.TemperatureC&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">label</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-label&quot;</span>&gt;</span>Summary<span class="hljs-tag">&lt;/<span class="hljs-name">label</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">InputText</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;form-control&quot;</span> @<span class="hljs-attr">bind-Value</span>=<span class="hljs-string">&quot;record.Summary&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;valid-feedback&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ValidationMessage</span> <span class="hljs-attr">For</span>=<span class="hljs-string">&quot;() =&gt; record.Summary&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;row mt-2&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12 text-right&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-success&quot;</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-dark&quot;</span> @<span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;Exit&quot;</span>&gt;</span>Exit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">EditForm</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</div></code></pre>
<pre><code class="language-csharp"><div>@code {
    [<span class="hljs-meta">Inject</span>] WeatherForecastService ForecastService { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }
    [<span class="hljs-meta">Inject</span>] NavigationManager NavManager { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-keyword">private</span> WeatherForecast <span class="hljs-keyword">record</span> = <span class="hljs-keyword">new</span> WeatherForecast();

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnInitializedAsync</span>(<span class="hljs-params"></span>)</span>
    {
        EditService.EditStateChanged += OnEditStateChanged;
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> Task <span class="hljs-title">SaveRecord</span>(<span class="hljs-params"></span>)</span>
    {
        <span class="hljs-keyword">return</span> Task.CompletedTask;
    }

    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Exit</span>(<span class="hljs-params"></span>)</span>
    {
        NavManager.NavigateTo(<span class="hljs-string">&quot;/&quot;</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"></span>)</span>
    =&gt;  EditService.EditStateChanged -= OnEditStateChanged;
}
</div></code></pre>
<h3 id="add-edit-state-control">Add Edit State Control</h3>
<p>Add the <code>EditFormState</code> control to the edit form.</p>
<pre><code class="language-html"><div>    <span class="hljs-tag">&lt;<span class="hljs-name">EditForm</span> <span class="hljs-attr">Model</span>=<span class="hljs-string">&quot;record&quot;</span> <span class="hljs-attr">OnValidSubmit</span>=<span class="hljs-string">&quot;SaveRecord&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">EditFormState</span> /&gt;</span>
        ....
</div></code></pre>
<p>Update the buttons, adding some state control to their display and enable status.</p>
<pre><code class="language-html"><div><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-12 text-right&quot;</span>&gt;</span>
    @if (_isDirty)
    {
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-danger&quot;</span> @<span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;Exit&quot;</span>&gt;</span>Exit without Saving<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    }
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-success&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&quot;@_isClean&quot;</span>&gt;</span>Submit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;btn btn-dark&quot;</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">&quot;@_isDirty&quot;</span> @<span class="hljs-attr">onclick</span>=<span class="hljs-string">&quot;Exit&quot;</span>&gt;</span>Exit<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</div></code></pre>
<p>Inject the <code>EditStateService</code> and add internal fields to hold the edit state</p>
<pre><code class="language-csharp"><div>    <span class="hljs-comment">// inject the EditStateService</span>
    [<span class="hljs-meta">Inject</span>] EditStateService EditService { <span class="hljs-keyword">get</span>; <span class="hljs-keyword">set</span>; }

    <span class="hljs-comment">// internal bool fields for state management</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> _isDirty;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">bool</span> _isClean =&gt; !_isDirty;
</div></code></pre>
<p>Add a <code>OnEditStateChanged</code> event handler and attach it to <code>EditService.EditStateChanged</code>.  It sets the internal state fields and calls <code>StateHasChanged</code> to initiate a render of the form.  Unregister the event handler in <code>Dispose</code>.</p>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">override</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">OnInitializedAsync</span>(<span class="hljs-params"></span>)</span>
{
    <span class="hljs-keyword">this</span>.record = <span class="hljs-keyword">await</span> ForecastService.GetWeatherForecastAsync(Guid.NewGuid());
    EditService.EditStateChanged += OnEditStateChanged;
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">OnEditStateChanged</span>(<span class="hljs-params"><span class="hljs-keyword">object</span> sender, EditStateEventArgs e</span>)</span>
{
    _isDirty = e.IsDirty;
    StateHasChanged();
}

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Dispose</span>(<span class="hljs-params"></span>)</span>
    =&gt;  EditService.EditStateChanged -= OnEditStateChanged;
</div></code></pre>
<p>Update <code>SaveRecord</code> and <code>Exit</code> to notify the service of the state change.</p>
<pre><code class="language-csharp"><div><span class="hljs-function"><span class="hljs-keyword">protected</span> Task <span class="hljs-title">SaveRecord</span>(<span class="hljs-params"></span>)</span>
{
    EditService.NotifyRecordSaved();
    <span class="hljs-keyword">return</span> Task.CompletedTask;
}

<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Exit</span>(<span class="hljs-params"></span>)</span>
{
    EditService.NotifyRecordExit();
    NavManager.NavigateTo(<span class="hljs-string">&quot;/&quot;</span>);
}
</div></code></pre>
<h2 id="using-the-inline-dialog">Using the Inline Dialog</h2>
<p>The inline dialog adds a little more control, blocking out all intra-application navigation except the browser back/forward buttons.  You can see the code in the Repo.  It's simple to use.</p>
<p>Add an <code>InlineWeatherForecastEditor</code> page and copy the contents of <code>WeatherForecastEditor</code>.</p>
<p>Add an <code>InLineDialog</code> control wrapper around the whole form, with the parameters set as shown.  <code>Lock</code> turns it off and on.</p>
<pre><code class="language-html"><div>@page &quot;/InlineWeatherForecastEditor&quot;
....
<span class="hljs-tag">&lt;<span class="hljs-name">InlineDialog</span> <span class="hljs-attr">Transparent</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">Lock</span>=<span class="hljs-string">&quot;_isDirty&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container p-2&quot;</span>&gt;</span>
        ....
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">InlineDialog</span>&gt;</span>
</div></code></pre>
<h2 id="the-solution-in-action">The Solution in Action</h2>
<p>Run the solution and go to <strong>Editor</strong>.  You will see:</p>
<p><img src="\articles\assets\Edit-Forms\Clean-Form-Editor.png" alt="Clean Editor"></p>
<p>Change a value, and you will see:</p>
<p><img src="\articles\assets\Edit-Forms\Dirty-Form-Editor.png" alt="Dirty Editor"></p>
<p>Click on a menu link, or hit the browser back button:</p>
<p><img src="\articles\assets\Edit-Forms\Dirty-Form-Exit.png" alt="Dirty Editor"></p>
<p>You now get the Dirty Exit Challenge from <code>RouteViewManager</code>.  Check what happens on each action.</p>
<p>Finally hit F5 to reload the page.</p>
<p><img src="\articles\assets\Edit-Forms\Dirty-App-Exit.png" alt="Dirty Editor"></p>
<p>This time you get the browser challenge - the text depends on the specific browser - they all implement the challenge slightly differently.</p>
<p>Check out the <strong>Inline Editor</strong></p>
<p><img src="\articles\assets\Edit-Forms\Dirty-Form-Inline-Dialog.png" alt="Dirty Editor"></p>

    

            </div>
        </div>
    </div>
</div>
<!-- end of Article Container -->


                </div>
                <!-- End of Main Content -->
            </div>
            <!-- Footer -->
            
<!-- Copyright -->
<footer class="sticky-footer bg-white">
    <div class="container my-auto">
        <div class="copyright text-center my-auto">
            
<span>Copyright &copy; Cold Elm Coders - 2021</span>

        </div>
    </div>
</footer>
<!-- end of copyright -->


            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
        
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>


    </div>
    <!-- End of Page Wrapper -->
    <!-- Scripts -->
    
<!-- Scripts -->
<!-- Bootstrap core JavaScript-->
<script src="/assets/vendor/jquery/jquery.min.js"></script>
<script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

<!-- Core plugin JavaScript-->
<script src="/assets/vendor/jquery-easing/jquery.easing.min.js"></script>

<!-- Custom scripts for all pages-->
<script src="/assets/js/sb-admin-2.min.js"></script>


</body>
</html>
