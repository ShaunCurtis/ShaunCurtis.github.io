<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<base href="/">

	

	

	
	<link href="/resources/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

	
	<link href="/resources/css/sb-admin-2.css" rel="stylesheet" type="text/css">
	<link href="/resources/css/site.css" rel="stylesheet" type="text/css">

	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
	<link rel="stylesheet" href="/resources/css/article.css" type="text/css">

	
	<link rel="icon" href="/assets/favicon.png">

	<title>Managing Form Edit State in Blazor</title>
        <meta property="author" content="Shaun Curtis" />
        <meta property="description" content="How to build Blazor Edit Forms that manage state." />
    <meta property="og:site_name" content="Cold Elm Coders" />
        <meta property="og:site" content="https://shauncurtis.github.io/" />
        <meta property="og:title" content="Managing Form Edit State in Blazor" />
        <meta property="og:description" content="How to build Blazor Edit Forms that manage state." /></head>
<body><header class="navbar bg-dark p-2 text-large text-light"><section class="navbar-section  text-light"><a href="/" class="navbar-brand mr-2 text-large text-light p-2">Cold Elm Coders</a>
			<a href="/Posts" class="btn btn-link text-light">Posts</a>
			<a href="/Rants" class="btn btn-link text-light">Rants</a>
			<a href="/Articles" class="btn btn-link text-light">Articles</a>
			<a href="/Stories" class="btn btn-link text-light">Stories</a>
			<a href="/about.html" class="btn btn-link text-light">About</a></section></header>

	<div class="container-fluid"><div class="row"><div class="col-12 col-sm-3 col-lg-2 bg-light pt-2"><div class="article-info p-2"><div class="mb-2">Published: 08-Feb-2021</div>
                <div class="mb-2">Updated: 08-Feb-2021</div>
                <div class="mb-2">Author: Shaun Curtis</div></div>
    <h4 class="p-2">Table of Contents</h4>
<ul class="TOC" >
<li class="TOC-item TOC-item-0" >
<a class="TOC-link" href="#">Top</a>
<ul class="TOC TOC-0" >
<li class="TOC-item TOC-item-1" >
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#tldr">TL;DR</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#discussion">Discussion</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#code-repository-and-demo-site">Code Repository and Demo Site</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#form-exits">Form Exits</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#blazor-and-navigation">Blazor and Navigation</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#the-options">The Options</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#form-edit-state">Form Edit State</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#the-navigation-lock-code">The Navigation Lock Code</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#the-infratructure-code">The Infratructure Code</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#mainlayout.razor">MainLayout.razor</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#using-blazrrouter">Using BlazrRouter</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
			
			<div class="col-12 col-sm-9 col-lg-10 p-2"><div class="pt-2 pb-2 border-bottom mb-4 text-primary"><h1>Managing Form Edit State in Blazor</h1>
            <div><small>How to build Blazor Edit Forms that manage state.</small></div></div>
    <h2 id="tldr">TL;DR</h2>
<p>This article is the culmination of 18 months effort to find a simple straighforward solution to the Dirty Form problem in Blazor.  There have been many dead end roads and half baked solutions along the way.</p>
<p>To cut to the chase, there is no silver bullet single solution.  This article shows how to combine a custom Navigation Manager with a rebuilt Blazor Router to handle in application navigation, and the browser <code>window.beforeunload</code> to handle external application navigation.</p>
<h2 id="discussion">Discussion</h2>
<p>The context of this article: there have been many discussions, articles and proposals since Blazor was first released on how to handle edit forms. Specifically how to stop, or at least warn, the user when leaving a dirty form. The problem is not specific to Blazor: all Single Page Applications and Web Sites face the same challenges.</p>
<p>In a classic web form, every navigation is a <code>get</code> or a <code>post</code> back to the server. We can use the Browser <code>window.beforeunload</code> event to warn a user that they have unsaved data on the page. Not great, but at least something - we'll be using it later. This technique falls flat in SPAs. What looks like a navigation event isn't. The NavigationManager intercepts any navigation attempt from the page, triggers its own LocationChanged event and sinks the request. The Router, wired into this event, does its wizardry, and loads the new component set into the page. No real browser navigation takes place, so there's nothing for the browser's beforeunload event to catch.</p>
<p>It's up to the programmer to write code that stops a user moving away from a dirty form. That's easier said than done when your application depends on the URL navigation pretext. Toolbars, navigation side bars and many buttons submit URLs to navigate around the application. Think of the out-of-the-box Blazor template. There's all the links in the left navigation, about in the top bar.</p>
<p>Personally, I have a serious issue with the whole routing charade: an SPA is an application, not a website, but I appear to be a minority of one! This article is for the majority.</p>
<p>All Blazor edit state solutions I've come across were cludges in one way or another, I've created more that one myself. What the community hoped for were changes in NetCore 5, specifically some extra functionality in NavigationManager to cancel or block navigation requests. That didn't happen: I don't think there was team concensus on the right solution, so we're back to square one.</p>
<p>What I cover in this article is my latest approach to the problem. It's not perfect, but I don't think we will ever get a near perfect solution until we get some new browser standards allowing a switch to SPA mode and control over toolbar navigation.</p>
<p>Our goal is to prevent navigation where possible i.e. lock the page, and where that fails hit the user with an exit option message.  No side doors!</p>
<p><img src="./assets/Edit-Forms/Dirty-App-Exit.png" alt="Dirty Editor" /></p>
<h2 id="code-repository-and-demo-site">Code Repository and Demo Site</h2>
<p>The repository for the article is <a href="https://github.com/ShaunCurtis/Blazr.Demo.EditForm">here</a>.</p>
<p>You can see the code in this article in action on my Blazr Database demo site is here - <a href="https://blazr-demo.azurewebsites.net/">Blazr.Demo Azure Site</a></p>
<h2 id="form-exits">Form Exits</h2>
<p>There are three (controlled) ways a user can exit a form:</p>
<ol>
<li><strong>Intra Form Navigation</strong> - Click on an Exit or other button in the form.</li>
<li><strong>Intra Application Navigation</strong> - Click on a link in a navigation bar outside the form, click on the forward or back buttons on the browser.</li>
<li><strong>Extra Application Navigation</strong> - entering a new Url in the address bar, clicking on a favourite, closing the browser Tab or application.</li>
</ol>
<p>We have no control over killing the browser - a reboot or system crash - so don't consider those here.</p>
<h2 id="blazor-and-navigation">Blazor and Navigation</h2>
<p>Blazor's Client side Javascript code registers event handlers for the various navigation events within the page and from the back/forward buttons.</p>
<p>In Blazor Web Assembly, these events surface in DotNetCore code in JsInterop code:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
[JSInvokable(nameof(NotifyLocationChanged))]
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> <span style="color:#569CD6;">void</span> NotifyLocationChanged(<span style="color:#569CD6;">string</span> uri, <span style="color:#569CD6;">bool</span> isInterceptedLink)
{
    WebAssemblyNavigationManager.Instance.SetLocation(uri, isInterceptedLink);
}
</pre></div>
<p>In Server the events get passed through the SignalR connection and surface:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">async</span> ValueTask OnLocationChanged(<span style="color:#569CD6;">string</span> uri, <span style="color:#569CD6;">bool</span> intercepted)
{
    <span style="color:#569CD6;">var</span> circuitHost = <span style="color:#569CD6;">await</span> GetActiveCircuitAsync();
    <span style="color:#569CD6;">if</span> (circuitHost == <span style="color:#569CD6;">null</span>)
        <span style="color:#569CD6;">return</span>;

    _ = circuitHost.OnLocationChangedAsync(uri, intercepted);
}
</pre></div>
<p>This calls the <code>CircuitHost</code> method:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">async</span> Task OnLocationChangedAsync(<span style="color:#569CD6;">string</span> uri, <span style="color:#569CD6;">bool</span> intercepted)
{
    <span style="color:#569CD6;">await</span> Renderer.Dispatcher.InvokeAsync(() =&gt;
    {
        <span style="color:#569CD6;">var</span> navigationManager = (RemoteNavigationManager)Services.GetRequiredService&lt;NavigationManager&gt;();
        navigationManager.NotifyLocationChanged(uri, intercepted);
    });
 }
<span style="color:#57A64A;">//lots of code missing to only show the relevant lines</span>
</pre></div><h2 id="the-options">The Options</h2>
<h3 id="the-javascript-option">The Javascript Option</h3>
<p>One possible approach to intercept and cancel the events that drive the Blazor code.</p>
<p>The code block below shows one possibility.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
let blazr_PreventNavigation = <span style="color:#569CD6;">false</span>;  <span style="color:#57A64A;">// main control bool to stop/allow navigation</span>
let idCounter = 0;
let lastHistoryItemId = 0; <span style="color:#57A64A;">//needed to detect back/forward, in popstate event handler</span>

window.blazr_setPageLock = <span style="color:#569CD6;">function</span> (lock) {
    blazr_PreventNavigation = lock;
}

window.history.pushState = (<span style="color:#569CD6;">function</span> (basePushState) {
    <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">function</span> (...args) {
        <span style="color:#569CD6;">if</span> (blazr_PreventNavigation) {
            <span style="color:#569CD6;">return</span>;
        }
        basePushState.apply(<span style="color:#569CD6;">this</span>, args);
    }
})(window.history.pushState);

window.addEventListener(<span style="color:#D69D85;">&#39;beforeunload&#39;</span>, e =&gt; {
    <span style="color:#569CD6;">if</span> (blazr_PreventNavigation) {
        e.returnValue = <span style="color:#D69D85;">&#39;There are unsaved changes&#39;</span>
    }
});

window.addEventListener(<span style="color:#D69D85;">&#39;load&#39;</span>, () =&gt; {
    let resetUrlRun = <span style="color:#569CD6;">false</span>;
    <span style="color:#569CD6;">function</span> popStateListener(e) {
        <span style="color:#569CD6;">if</span> (blazr_PreventNavigation) {
            let lockNavigation = <span style="color:#569CD6;">false</span>;

            <span style="color:#57A64A;">//popstate can be triggered twice, but we want to show confirm dialog only once</span>
            lockNavigation = blazr_PreventNavigation &amp;&amp; !resetUrlRun;

            <span style="color:#569CD6;">if</span> (lockNavigation) {
                <span style="color:#57A64A;">//this will nearly always cancel Blazor navigation, but the url is already changed</span>
                e.stopImmediatePropagation();
                e.preventDefault();
                e.returnValue = <span style="color:#569CD6;">false</span>;
            }

            <span style="color:#569CD6;">if</span> (resetUrlRun) {
                <span style="color:#57A64A;">//Resets resetUrlRun on second run</span>
                resetUrlRun = <span style="color:#569CD6;">false</span>;
            }

            <span style="color:#57A64A;">// Only runs on the first pass through    </span>
            <span style="color:#569CD6;">if</span> (lockNavigation) {
                <span style="color:#57A64A;">//detect back vs forward </span>
                <span style="color:#569CD6;">const</span> currentId = e.state &amp;&amp; e.state.__incrementalId;
                <span style="color:#569CD6;">const</span> navigatingForward = currentId &gt; lastHistoryItemId;

                <span style="color:#57A64A;">//revert url</span>
                <span style="color:#569CD6;">if</span> (navigatingForward) {
                    history.back();
                }
                <span style="color:#569CD6;">else</span> {
                    history.forward();
                }
                resetUrlRun = <span style="color:#569CD6;">true</span>;
            }
        }
    }

    window.addEventListener(<span style="color:#D69D85;">&#39;popstate&#39;</span>, popStateListener, { capture: <span style="color:#569CD6;">true</span> });

    window.history.pushState = (<span style="color:#569CD6;">function</span> (basePushState) {
        <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">function</span> (...args) {
            <span style="color:#569CD6;">if</span> (blazr_PreventNavigation) {
                <span style="color:#569CD6;">return</span>;
            }
            <span style="color:#569CD6;">if</span> (!args[0]) {
                args[0] = {};
            }
            lastHistoryItemId = history.state &amp;&amp; history.state.__incrementalId;
            args[0].__incrementalId = ++idCounter; <span style="color:#57A64A;">//track order of history items            </span>
            basePushState.apply(<span style="color:#569CD6;">this</span>, args);
        }
    })(window.history.pushState);
});
</pre></div>
<p>This code works most of the time in Blazor Server, but not in Web Assembly mode.  Unfortunately, unless someone knows how to make it 100%, I've discounted it for now.  The code is available in Repo for you to test and work with.</p>
<h3 id="the-navigation-manager-option">The Navigation Manager Option</h3>
<p>In Blazor Web Assembly, <code>NotifyLocationChanged</code> uses the static <code>WebAssemblyNavigationManager.Instance</code> to get the currently registered singleton instance and calls the <code>SetLocation</code> method on that instance.  Specifically, it doesn't access the instance through the DI container.  This is Web Assembly, so Scoped and Singleton are the same thing, it uses the &quot;Singleton&quot; pattern to access the only instance of <code>WebAssemblyNavigationManager</code> running in the browser container.</p>
<p>We can exploit this in the WASM solution by &quot;unregistering&quot; <code>WebAssemblyNavigationManager</code> as the registered <code>NavigationManager</code> in the WASM DI container, and registering our own <code>BlazrNavigationManager</code> instead.  We re-register <code>WebAssemblyNavigationManager</code> as itself.</p>
<p>Now all DI container services that use <code>NavigationManager</code>, register for <code>LocationChanged</code> on our <code>BlazrNavigationManager</code>.  The JSInterop events still surface though <code>WebAssemblyNavigationManager</code>, but now only <code>BlazrNavigationManager</code> is registered for the <code>LocationChanged</code> event on the <code>WebAssemblyNavigationManager</code> instance.  We now have control over whether or not we pass the event on.  Specifically, we now control <code>Router</code>.</p>
<p>Unfortunately, Blazor server does things differently. <code>OnLocationChangedAsync</code> gets the registered service and expects it to be <code>RemoteNavigationManager</code> which is a sealed internal class.  No exploitable options here.  We have no way to get <code>Router</code> to register with our NavigationManager!</p>
<h3 id="the-router-option">The Router Option</h3>
<p>The third, and only bulletproof method, is a router that uses <code>BlazrNavigationManager</code>.  The code within the <em>Routing</em> directory and namespace does that.</p>
<p><code>BlazrRouter</code> is a very lightly modified standard Router implementation.  The modifications are:</p>
<ol>
<li>Inject <code>BlazrNavigationManager</code> instead of <code>NavigationManager</code>.  The router then registers with the <code>BlazrNavigationManager</code> <code>LocationChanged</code> event and thus only receives location changed events it passes through.</li>
<li>HotReload is disabled as the <code>HotReloadManager</code> is an internal class that can'r be access from outside it's parent assembly.</li>
</ol>
<p>You can review the code in the Repo.</p>
<h2 id="form-edit-state">Form Edit State</h2>
<p>The first step to controlling form exits is to manage the state of the form - is the data in the form different from the record?  There's nothing in out-of-the-box Blazor to do this: there's a very simplistic attempt in <code>EditContext</code>, but it's not fit-for-purpose.   We need an edit state manager.</p>
<p><code>EditStateContext</code> implements the functionality to track the state of the current edit form.</p>
<h3 id="editstatecontext">EditStateContext</h3>
<p><code>EditStateContext</code> loads content from the <code>EditContext</code> Model into a <code>EditFieldCollection</code> of <code>EditField</code> objects.  This collection is populated when the form loads.  Individual edits are passed in by calling <code>NotifyFieldChanged</code>, and the <code>EditedValue</code> property of the correct <code>EditField</code> is updated.  <code>EditFieldCollection</code> exposes a <code>IsDirty</code> property which is true if any <code>EditField</code> is dirty i.e. <code>Value</code> does not equal <code>EditedValue</code>.</p>
<p><code>EditStateContext</code> registers with <code>EditContext</code> for FieldChanges and calls <code>NotifyFieldChanged</code> whenever a field is updated.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> EditStateContext : IDisposable
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> IsDirty =&gt; EditFields.IsDirty;

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">event</span> EventHandler&lt;EditStateEventArgs&gt;? EditStateChanged;

    <span style="color:#569CD6;">private</span> EditFieldCollection EditFields = <span style="color:#569CD6;">new</span> EditFieldCollection();

    <span style="color:#569CD6;">protected</span> EditContext? EditContext { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">set</span>; }

    <span style="color:#569CD6;">public</span> EditStateContext(EditContext editContext)
        =&gt; <span style="color:#569CD6;">this</span>.Load(editContext);

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Load(EditContext editContext)
    {
        <span style="color:#569CD6;">this</span>.EditContext = editContext;
        <span style="color:#569CD6;">this</span>.LoadEditState();
        <span style="color:#569CD6;">this</span>.EditContext.OnFieldChanged += <span style="color:#569CD6;">this</span>.FieldChanged;
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> LoadEditState()
        =&gt; <span style="color:#569CD6;">this</span>.GetEditFields();

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> GetEditFields()
    {
        <span style="color:#569CD6;">var</span> model = <span style="color:#569CD6;">this</span>.EditContext!.Model;
        <span style="color:#569CD6;">this</span>.EditFields.Clear();
        <span style="color:#569CD6;">if</span> (model <span style="color:#569CD6;">is</span> not <span style="color:#569CD6;">null</span>)
        {
            <span style="color:#569CD6;">var</span> props = model.GetType().GetProperties();
            <span style="color:#569CD6;">foreach</span> (<span style="color:#569CD6;">var</span> prop <span style="color:#569CD6;">in</span> props)
            {
                <span style="color:#569CD6;">if</span> (prop.CanWrite)
                {
                    <span style="color:#569CD6;">var</span> value = prop.GetValue(model);
                    EditFields.AddField(model, prop.Name, value);
                }
            }
        }
    }
    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> FieldChanged(<span style="color:#569CD6;">object</span>? sender, FieldChangedEventArgs e)
        =&gt; <span style="color:#569CD6;">this</span>.NotifyFieldChanged(e);

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> NotifyFieldChanged(FieldChangedEventArgs e)
    {
        <span style="color:#569CD6;">var</span> wasDirty = EditFields.IsDirty;

        <span style="color:#57A64A;">// Get the PropertyInfo object for the model property</span>
        <span style="color:#57A64A;">// Uses reflection to get property and value</span>
        <span style="color:#569CD6;">var</span> prop = e.FieldIdentifier.Model.GetType().GetProperty(e.FieldIdentifier.FieldName);
        <span style="color:#569CD6;">if</span> (prop != <span style="color:#569CD6;">null</span>)
        {
            <span style="color:#57A64A;">// Get the value for the property</span>
            <span style="color:#569CD6;">var</span> value = prop.GetValue(e.FieldIdentifier.Model);

            <span style="color:#57A64A;">// Sets the edit value in the EditField</span>
            EditFields.SetField(e.FieldIdentifier.FieldName, value);

            <span style="color:#57A64A;">// Invokes EditStateChanged if changed</span>
            <span style="color:#569CD6;">var</span> isStateChange = (EditFields.IsDirty) != wasDirty;
            <span style="color:#569CD6;">if</span> (isStateChange)
                <span style="color:#569CD6;">this</span>.NotifyEditStateChanged();
        }
    }

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> NotifySaved()
    {
        <span style="color:#569CD6;">var</span> currentState = <span style="color:#569CD6;">this</span>.EditFields.IsDirty;
        <span style="color:#569CD6;">this</span>.LoadEditState();
        <span style="color:#569CD6;">if</span> (currentState)
            NotifyEditStateChanged();
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> NotifyEditStateChanged()
        =&gt; EditStateChanged?.Invoke(<span style="color:#569CD6;">this</span>, EditStateEventArgs.NewArgs(EditFields?.IsDirty ?? <span style="color:#569CD6;">false</span>));

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Dispose()
    {
        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">this</span>.EditContext <span style="color:#569CD6;">is</span> not <span style="color:#569CD6;">null</span>)
            <span style="color:#569CD6;">this</span>.EditContext.OnFieldChanged += <span style="color:#569CD6;">this</span>.FieldChanged;
    }
}
</pre></div><h4 id="editstateeventargs">EditStateEventArgs</h4>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">using</span> System;

<span style="color:#569CD6;">namespace</span> Blazr.EditForms
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> EditStateEventArgs : EventArgs
    {
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> IsDirty { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> EditStateEventArgs NewArgs(<span style="color:#569CD6;">bool</span> dirtyState)
            =&gt; <span style="color:#569CD6;">new</span> EditStateEventArgs { IsDirty = dirtyState };
    }
}
</pre></div><h4 id="editfield">EditField</h4>
<p><code>EditField</code> looks like this.  All but <code>EditedValue</code> are <code>init</code> record type properties.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> EditField
    {
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">string</span> FieldName { <span style="color:#569CD6;">get</span>; init; }
        <span style="color:#569CD6;">public</span> Guid GUID { <span style="color:#569CD6;">get</span>; init; }
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">object</span> Value { <span style="color:#569CD6;">get</span>; init; }
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">object</span> EditedValue { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">object</span> Model { <span style="color:#569CD6;">get</span>; init; }

        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> IsDirty
        {
            <span style="color:#569CD6;">get</span>
            {
                <span style="color:#569CD6;">if</span> (Value != <span style="color:#569CD6;">null</span> &amp;&amp; EditedValue != <span style="color:#569CD6;">null</span>) <span style="color:#569CD6;">return</span> !Value.Equals(EditedValue);
                <span style="color:#569CD6;">if</span> (Value <span style="color:#569CD6;">is</span> <span style="color:#569CD6;">null</span> &amp;&amp; EditedValue <span style="color:#569CD6;">is</span> <span style="color:#569CD6;">null</span>) <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">false</span>;
                <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">true</span>;
            }
        }

        <span style="color:#569CD6;">public</span> EditField(<span style="color:#569CD6;">object</span> model, <span style="color:#569CD6;">string</span> fieldName, <span style="color:#569CD6;">object</span> value)
        {
            <span style="color:#569CD6;">this</span>.Model = model;
            <span style="color:#569CD6;">this</span>.FieldName = fieldName;
            <span style="color:#569CD6;">this</span>.Value = value;
            <span style="color:#569CD6;">this</span>.EditedValue = value;
            <span style="color:#569CD6;">this</span>.GUID = Guid.NewGuid();
        }

        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Reset()
            =&gt; <span style="color:#569CD6;">this</span>.EditedValue = <span style="color:#569CD6;">this</span>.Value;
    }
</pre></div><h4 id="editfieldcollection">EditFieldCollection</h4>
<p><code>EditFieldCollection</code> implements <code>IEnumerable</code>.  It provides:</p>
<ol>
<li>An <code>IsDirty</code> property which checks the state of all the <code>EditFields</code> in the collection.</li>
<li>A set of getters and setters for adding and setting the edit state.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> EditFieldCollection : IEnumerable
    {
        <span style="color:#569CD6;">private</span> List&lt;EditField&gt; _items = <span style="color:#569CD6;">new</span> List&lt;EditField&gt;();
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">int</span> Count =&gt; _items.Count;
        <span style="color:#569CD6;">public</span> Action&lt;<span style="color:#569CD6;">bool</span>&gt; FieldValueChanged;
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> IsDirty =&gt; _items.Any(item =&gt; item.IsDirty);

        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Clear()
            =&gt; _items.Clear();

        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> ResetValues()
            =&gt; _items.ForEach(item =&gt; item.Reset());
..... lots of getters and setters and IEnumerator implementation code
</pre></div><h2 id="the-navigation-lock-code">The Navigation Lock Code</h2>
<h3 id="the-navigationlock-component">The NavigationLock Component</h3>
<p>Page locking is implemented in the UI through  the <code>NavigationLock</code> component.  It looks like this:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> NavigationLock : ComponentBase, IDisposable
{
    [Inject] <span style="color:#569CD6;">private</span> IJSRuntime? _js { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

    [Inject] <span style="color:#569CD6;">private</span> BlazrNavigationManager? blazrNavigationManager { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }    
    
    [Parameter] <span style="color:#569CD6;">public</span> RenderFragment? ChildContent { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">bool</span> locked;

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">void</span> OnInitialized()
        =&gt; blazrNavigationManager!.BeforeLocationChange += OnBeforeLocationChange;

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> Task OnAfterRenderAsync(<span style="color:#569CD6;">bool</span> firstRender)
    {
        <span style="color:#569CD6;">if</span> (firstRender)
            SetPageLock();
        <span style="color:#569CD6;">return</span> Task.CompletedTask;
    }

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> SetLock(<span style="color:#569CD6;">bool</span> locked)
    {
        <span style="color:#569CD6;">this</span>.locked = locked;
        <span style="color:#569CD6;">this</span>.SetPageLock();
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> OnBeforeLocationChange(<span style="color:#569CD6;">object</span>? sender, NavigationData e)
        =&gt; e.IsCanceled = <span style="color:#569CD6;">this</span>.locked;

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> SetPageLock()
        =&gt; _js!.InvokeAsync&lt;<span style="color:#569CD6;">bool</span>&gt;(<span style="color:#D69D85;">&quot;blazr_setPageLock&quot;</span>, locked);

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">void</span> BuildRenderTree(RenderTreeBuilder builder)
    {
        builder.OpenComponent&lt;CascadingValue&lt;NavigationLock&gt;&gt;(<span style="color:#B5CEA8;">0</span>);
        builder.AddAttribute(<span style="color:#B5CEA8;">1</span>, <span style="color:#D69D85;">&quot;Value&quot;</span>, <span style="color:#569CD6;">this</span>);
        builder.AddAttribute(<span style="color:#B5CEA8;">2</span>, <span style="color:#D69D85;">&quot;ChildContent&quot;</span>, <span style="color:#569CD6;">this</span>.ChildContent);
        builder.CloseComponent();
    }

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Dispose()
        =&gt; blazrNavigationManager!.BeforeLocationChange -= OnBeforeLocationChange;
}
</pre></div>
<p>It's default first load condition is unlocked.  It has a single public method <code>SetLock</code>.  This sets an internal state global variable and calls the Javascript <code>blazr_setPageLock</code> passing true/false to set or unset page locking.</p>
<p>It injects the new <code>BlazrNavigationManager</code> and registers for the <code>OnBeforeLocationChange</code> event.  It sets <code>IsCancelled</code> on the <code>NavigationData</code> object it is passed to the lock state.  We'll see <code>BlazrNavigationManager</code> in a minute.</p>
<p>The Component UI wraps the child content in a cascade of the component.</p>
<h3 id="site.js">site.js</h3>
<p>The client side guts of the solution.  In essence we add listeners into the various browser navigation events and either allow or prevent event propogation.  The code is shown in full below.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
let blazr_PreventNavigation = <span style="color:#569CD6;">false</span>;  <span style="color:#57A64A;">// main control bool to stop/allow navigation</span>

window.blazr_setPageLock = <span style="color:#569CD6;">function</span> (lock) {
    blazr_PreventNavigation = lock;
}

window.addEventListener(<span style="color:#D69D85;">&#39;beforeunload&#39;</span>, e =&gt; {
    <span style="color:#569CD6;">if</span> (blazr_PreventNavigation) {
        e.returnValue = <span style="color:#D69D85;">&#39;There are unsaved changes in your form!&#39;</span>
    }
});
</pre></div><h3 id="blazrnavigationmanager">BlazrNavigationManager</h3>
<p><code>BlazrNavigationManager</code> replaces the normal Navigation Manager.</p>
<p>It injects the standard Navigation Manager through Dependancy Injection as it's UnderlyingNavigationManager.  It registers on the <code>OnUnderlyingNavigationManager.LocationChanged</code> event.  The event handler invokes all registered delegates on it's <code>BeforeLocationChange</code> event.  If <code>NavigationData.IsCanceled</code> is true it sinks the event.  If not, it invokes it's own base class <code>LocationChanged</code> event though <code>NotifyLocationChanged</code>.</p>
<p>If navigation is cancelled, it instigates a second Navigation event on the standard Navigation Manager to reset the Uri.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> BlazrNavigationManager : NavigationManager
{
    <span style="color:#569CD6;">private</span> NavigationManager _UnderlyingNavigationManager;
    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">bool</span> _isBlindNavigation = <span style="color:#569CD6;">false</span>;

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">event</span> EventHandler&lt;NavigationData&gt;? BeforeLocationChange;

    <span style="color:#569CD6;">public</span> BlazrNavigationManager(NavigationManager? underlyingNavigationManager)
    {
        _UnderlyingNavigationManager = underlyingNavigationManager!;
        <span style="color:#569CD6;">base</span>.Initialize(underlyingNavigationManager!.BaseUri, underlyingNavigationManager.Uri);
        _UnderlyingNavigationManager.LocationChanged += OnUnderlyingNavigationManagerLocationChanged;
    }

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">void</span> EnsureInitialized()
    {
        <span style="color:#569CD6;">base</span>.Initialize(_UnderlyingNavigationManager.BaseUri, _UnderlyingNavigationManager.Uri);
    }

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">void</span> NavigateToCore(<span style="color:#569CD6;">string</span> uri, <span style="color:#569CD6;">bool</span> forceLoad)
    {
        <span style="color:#57A64A;">// Call the underlying navigation manager.</span>
        _UnderlyingNavigationManager.NavigateTo(uri, forceLoad);
    }

    <span style="color:#569CD6;">private</span> NavigationData NotifyBeforeLocationChange(LocationChangedEventArgs e)
    {
        <span style="color:#569CD6;">var</span> navigation = <span style="color:#569CD6;">new</span> NavigationData()
        {
            CurrentLocation = <span style="color:#569CD6;">this</span>.Uri,
            NewLocation = e.Location,
            IsNavigationIntercepted = e.IsNavigationIntercepted,
            IsCanceled = <span style="color:#569CD6;">false</span>
        };
        BeforeLocationChange?.Invoke(<span style="color:#569CD6;">this</span>, navigation);
        <span style="color:#569CD6;">return</span> navigation;
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> OnUnderlyingNavigationManagerLocationChanged(<span style="color:#569CD6;">object</span>? sender, LocationChangedEventArgs e)
    {
        <span style="color:#569CD6;">var</span> navigation = NotifyBeforeLocationChange(e);
        <span style="color:#57A64A;">// Check our blind navigation flag.  If we are blind navigating</span>
        <span style="color:#57A64A;">// we just set the flag back to false and exit</span>
        <span style="color:#569CD6;">if</span> (_isBlindNavigation)
        {
            _isBlindNavigation = <span style="color:#569CD6;">false</span>;
            <span style="color:#569CD6;">return</span>;
        }

        <span style="color:#57A64A;">// Navigation is cancelled</span>
        <span style="color:#57A64A;">// we set the flag so we don&#39;t create a loop with the dummy run</span>
        <span style="color:#569CD6;">if</span> (navigation.IsCanceled)
        {
            <span style="color:#57A64A;">// prevents a NavigateTo loop</span>
            _isBlindNavigation = <span style="color:#569CD6;">true</span>;
            <span style="color:#57A64A;">// Puts the link back - else it will change, but the page will not navigate.</span>
            _UnderlyingNavigationManager.NavigateTo(<span style="color:#569CD6;">this</span>.Uri, <span style="color:#569CD6;">false</span>);
            <span style="color:#569CD6;">return</span>;
        }

        <span style="color:#57A64A;">// Normal Navigation path</span>
        <span style="color:#57A64A;">// NOTE: We set the Uri before calling notify location changed, as it will use this uri property in its args.</span>
        <span style="color:#569CD6;">this</span>.Uri = e.Location;
        <span style="color:#57A64A;">// Trigger the Location Changed event for all listeners including the Router</span>
        <span style="color:#569CD6;">this</span>.NotifyLocationChanged(e.IsNavigationIntercepted);
        <span style="color:#57A64A;">// Belt and braces to ensure false </span>
        _isBlindNavigation = <span style="color:#569CD6;">false</span>;
    }
}
</pre></div><h3 id="weatherforecasteditorform">WeatherForecastEditorForm</h3>
<p>Our base editor form looks like this.  It's all UI controls which you can investigate in the Repo code.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UILoader</span> <span style="color:#FF0000;">State</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;this.LoadState&quot;</span><span style="color:#569CD6;">&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">FormViewTitle</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">h2</span><span style="color:#569CD6;">&gt;</span>Weather Forecast Editor<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">h2</span><span style="color:#569CD6;">&gt;</span>
    <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">FormViewTitle</span><span style="color:#569CD6;">&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">EditForm</span> <span style="color:#FF0000;">EditContext</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;this.editContent&quot;</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIContainer</span> <span style="color:#FF0000;">Size</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">BootstrapSize.Fluid</span><span style="color:#569CD6;">&gt;</span>
            <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIFormRow</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIColumn</span> <span style="color:#FF0000;">Columns</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">12</span> <span style="color:#FF0000;">MediumColumns</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">6</span><span style="color:#569CD6;">&gt;</span>
                    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">FormEditControl</span> <span style="color:#FF0000;">Label</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;Date&quot;</span> <span style="color:#FF0000;">ShowLabel</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot; @bind-Value=&quot;this.viewService.EditModel.Date&quot;</span> <span style="color:#FF0000;">ControlType</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;typeof(InputDate&lt;DateTime&gt;)&quot;</span> <span style="color:#FF0000;">IsRequired</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot;</span> <span style="color:#FF0000;">ShowValidation</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot;</span> <span style="color:#FF0000;">HelperText</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;Enter the Forecast Date&quot;</span><span style="color:#569CD6;">&gt;</span><span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">FormEditControl</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIColumn</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIColumn</span> <span style="color:#FF0000;">Columns</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">12</span> <span style="color:#FF0000;">MediumColumns</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">6</span><span style="color:#569CD6;">&gt;</span>
                    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">FormEditControl</span> <span style="color:#FF0000;">Label</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;Temperature &amp;deg;C&quot;</span> <span style="color:#FF0000;">ShowLabel</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot; @bind-Value=&quot;this.viewService.EditModel.TemperatureC&quot;</span> <span style="color:#FF0000;">ControlType</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;typeof(InputNumber&lt;int&gt;)&quot;</span> <span style="color:#FF0000;">IsRequired</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot;</span> <span style="color:#FF0000;">ShowValidation</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot;</span> <span style="color:#FF0000;">HelperText</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;Enter the Temperature&quot;</span><span style="color:#569CD6;">&gt;</span><span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">FormEditControl</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIColumn</span><span style="color:#569CD6;">&gt;</span>
            <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIFormRow</span><span style="color:#569CD6;">&gt;</span>
            <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIFormRow</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIColumn</span> <span style="color:#FF0000;">Columns</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">12</span><span style="color:#569CD6;">&gt;</span>
                    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">FormEditControl</span> <span style="color:#FF0000;">Label</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;Summary&quot;</span> <span style="color:#FF0000;">ShowLabel</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot; @bind-Value=&quot;this.viewService.EditModel.Summary&quot;</span> <span style="color:#FF0000;">IsRequired</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot;</span> <span style="color:#FF0000;">ShowValidation</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;true&quot;</span> <span style="color:#FF0000;">HelperText</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;Summarise the Weather&quot;</span><span style="color:#569CD6;">&gt;</span><span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">FormEditControl</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIColumn</span><span style="color:#569CD6;">&gt;</span>
            <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIFormRow</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIContainer</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIContainer</span> <span style="color:#FF0000;">Size</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">BootstrapSize.Fluid</span><span style="color:#569CD6;">&gt;</span>
            <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIFormRow</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIColumn</span> <span style="color:#FF0000;">Columns</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">12</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;text-end&quot;</span><span style="color:#569CD6;">&gt;</span>
                    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIButton</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn-success&quot;</span> <span style="color:#FF0000;">Disabled</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;!this.isDirty&quot;</span> <span style="color:#FF0000;">ClickEvent</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;this.SaveRecord&quot;</span><span style="color:#569CD6;">&gt;</span>Save<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIButton</span><span style="color:#569CD6;">&gt;</span>
                    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIButton</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn-dark&quot;</span> <span style="color:#FF0000;">Show</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;!this.isDirty&quot;</span> <span style="color:#FF0000;">ClickEvent</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;this.Exit&quot;</span><span style="color:#569CD6;">&gt;</span>Exit<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIButton</span><span style="color:#569CD6;">&gt;</span>
                    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">UIButton</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn-danger&quot;</span> <span style="color:#FF0000;">Show</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;this.isDirty&quot;</span> <span style="color:#FF0000;">ClickEvent</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;this.ExitWithoutSaving&quot;</span><span style="color:#569CD6;">&gt;</span>Exit Without Saving<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIButton</span><span style="color:#569CD6;">&gt;</span>
                <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIColumn</span><span style="color:#569CD6;">&gt;</span>
            <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIFormRow</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UIContainer</span><span style="color:#569CD6;">&gt;</span>
    <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">EditForm</span><span style="color:#569CD6;">&gt;</span>
<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">UILoader</span><span style="color:#569CD6;">&gt;</span>
</pre></div>
<p>And the code behind.</p>
<p>Most of the code is in a <code>BaseEditForm</code>.</p>
<p>The relevant section is in <code>OnInitializedAsync</code> where the <code>EditStateContext</code> is set up.  <code>OnEditStateChanged</code> importantly sets the lock on the Cascaded <code>NavigationLock</code>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">partial</span> <span style="color:#569CD6;">class</span> WeatherForecastEditForm : BaseEditForm, IDisposable
{
    [Inject] <span style="color:#569CD6;">private</span> WeatherForecastViewService? ViewService { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

    <span style="color:#569CD6;">private</span> WeatherForecastViewService viewService =&gt; <span style="color:#569CD6;">this</span>.ViewService!;

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">async</span> <span style="color:#569CD6;">override</span> Task OnInitializedAsync()
    {
        <span style="color:#569CD6;">base</span>.LoadState = ComponentState.Loading;
        <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.viewService.GetForecastAsync(Id);
        <span style="color:#569CD6;">base</span>.editContent = <span style="color:#569CD6;">new</span> EditContext(<span style="color:#569CD6;">this</span>.viewService.EditModel);
        <span style="color:#569CD6;">base</span>.editStateContext = <span style="color:#569CD6;">new</span> EditStateContext(<span style="color:#569CD6;">base</span>.editContent);
        <span style="color:#569CD6;">base</span>.editStateContext.EditStateChanged += <span style="color:#569CD6;">base</span>.OnEditStateChanged;
        <span style="color:#569CD6;">base</span>.LoadState = ComponentState.Loaded;
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">async</span> Task SaveRecord()
    {
        <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.viewService.UpdateRecordAsync();
        <span style="color:#569CD6;">base</span>.editStateContext?.NotifySaved();
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">async</span> Task AddRecord()
    =&gt; <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.viewService.AddRecordAsync(
        <span style="color:#569CD6;">new</span> DcoWeatherForecast
        {
            Date = DateTime.Now,
            Id = Guid.NewGuid(),
            Summary = <span style="color:#D69D85;">&quot;Balmy&quot;</span>,
            TemperatureC = <span style="color:#B5CEA8;">14</span>
        });

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">void</span> BaseExit()
    =&gt; <span style="color:#569CD6;">this</span>.NavManager?.NavigateTo(<span style="color:#D69D85;">&quot;/weatherforecast&quot;</span>);

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Dispose()
    {
        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">base</span>.editStateContext <span style="color:#569CD6;">is</span> not <span style="color:#569CD6;">null</span>)
            <span style="color:#569CD6;">base</span>.editStateContext.EditStateChanged -= <span style="color:#569CD6;">base</span>.OnEditStateChanged;
    }
}
</pre></div><h2 id="the-infratructure-code">The Infratructure Code</h2>
<h2 id="mainlayout.razor">MainLayout.razor</h2>
<p>The most common approach is to use the component in Layouts.  Here's the modified <code>MainLayout</code>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
&lt;div <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;page&quot;</span>&gt;
    &lt;div <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;sidebar&quot;</span>&gt;
        &lt;NavMenu /&gt;
    &lt;/div&gt;

    &lt;main&gt;
        &lt;div <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;top-row px-4&quot;</span>&gt;
            &lt;a href=<span style="color:#D69D85;">&quot;https://docs.microsoft.com/aspnet/&quot;</span> target=<span style="color:#D69D85;">&quot;_blank&quot;</span>&gt;About&lt;/a&gt;
        &lt;/div&gt;

        &lt;article <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;content px-4&quot;</span>&gt;
            &lt;NavigationLock&gt;
                @Body
            &lt;/NavigationLock&gt;
        &lt;/article&gt;
    &lt;/main&gt;
&lt;/div&gt;
</pre></div>
<p>The <code>Body</code> content is wrapped in the component, and the component cascaded, so is available to all pages/components that use the layout.</p>
<h3 id="layout.cshtmlindex.html">_Layout.cshtml/index.html</h3>
<p>Add the js script as the last script to load in either Layout.cshtml or index.html.</p>
<p>Server</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">script</span> <span style="color:#FF0000;">src</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;_framework/blazor.server.js&quot;</span><span style="color:#569CD6;">&gt;</span><span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">script</span><span style="color:#569CD6;">&gt;</span>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">script</span> <span style="color:#FF0000;">src</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;_content/Blazr.NavigationLocker/site.js&quot;</span><span style="color:#569CD6;">&gt;</span><span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">script</span><span style="color:#569CD6;">&gt;</span>
</pre></div>
<p>WASM</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">script</span> <span style="color:#FF0000;">src</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;_framework/blazor.webassembly.js&quot;</span><span style="color:#569CD6;">&gt;</span><span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">script</span><span style="color:#569CD6;">&gt;</span>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">script</span> <span style="color:#FF0000;">src</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;_content/Blazr.NavigationLocker/site.js&quot;</span><span style="color:#569CD6;">&gt;</span><span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">script</span><span style="color:#569CD6;">&gt;</span>
</pre></div><h3 id="services">Services</h3>
<p>Add the required services.</p>
<p>Server</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    services.AddBlazrNavigationLockerServerServices();
</pre></div>
<p>WASM</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    services.AddBlazrNavigationLockerWASMServices();
</pre></div><h2 id="using-blazrrouter">Using BlazrRouter</h2>
<p>To use <code>BlazrRouter</code> simply replace the standard router in <code>App.razor</code>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">BlazrRouter</span> <span style="color:#92CAF4;">AppAssembly</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">@typeof(App).Assembly</span><span style="color:#569CD6;">&quot;</span><span style="color:#808080;">&gt;</span>
    <span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">Found</span> <span style="color:#92CAF4;">Context</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">routeData</span><span style="color:#569CD6;">&quot;</span><span style="color:#808080;">&gt;</span>
        <span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">RouteView</span> <span style="color:#92CAF4;">RouteData</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">@routeData</span><span style="color:#569CD6;">&quot;</span> <span style="color:#92CAF4;">DefaultLayout</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">@typeof(MainLayout)</span><span style="color:#569CD6;">&quot;</span> <span style="color:#808080;">/&gt;</span>
        <span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">FocusOnNavigate</span> <span style="color:#92CAF4;">RouteData</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">@routeData</span><span style="color:#569CD6;">&quot;</span> <span style="color:#92CAF4;">Selector</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">h1</span><span style="color:#569CD6;">&quot;</span> <span style="color:#808080;">/&gt;</span>
    <span style="color:#808080;">&lt;/</span><span style="color:#E6E6E6;">Found</span><span style="color:#808080;">&gt;</span>
    <span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">NotFound</span><span style="color:#808080;">&gt;</span>
        <span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">PageTitle</span><span style="color:#808080;">&gt;</span>Not found<span style="color:#808080;">&lt;/</span><span style="color:#E6E6E6;">PageTitle</span><span style="color:#808080;">&gt;</span>
        <span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">LayoutView</span> <span style="color:#92CAF4;">Layout</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">@typeof(MainLayout)</span><span style="color:#569CD6;">&quot;</span><span style="color:#808080;">&gt;</span>
            <span style="color:#808080;">&lt;</span><span style="color:#E6E6E6;">p</span> <span style="color:#92CAF4;">role</span><span style="color:#808080;">=</span><span style="color:#569CD6;">&quot;</span><span style="color:#569CD6;">alert</span><span style="color:#569CD6;">&quot;</span><span style="color:#808080;">&gt;</span>Sorry, there&#39;s nothing at this address.<span style="color:#808080;">&lt;/</span><span style="color:#E6E6E6;">p</span><span style="color:#808080;">&gt;</span>
        <span style="color:#808080;">&lt;/</span><span style="color:#E6E6E6;">LayoutView</span><span style="color:#808080;">&gt;</span>
    <span style="color:#808080;">&lt;/</span><span style="color:#E6E6E6;">NotFound</span><span style="color:#808080;">&gt;</span>
<span style="color:#808080;">&lt;/</span><span style="color:#E6E6E6;">BlazrRouter</span><span style="color:#808080;">&gt;</span>
</pre></div>
<p>You will need to register the services as above.</p>
</div></div></div></body></html>





