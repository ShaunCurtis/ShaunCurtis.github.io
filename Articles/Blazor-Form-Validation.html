<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<base href="/">

	

	

	
	<link href="/resources/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

	
	<link href="/resources/css/sb-admin-2.css" rel="stylesheet" type="text/css">
	<link href="/resources/css/site.css" rel="stylesheet" type="text/css">

	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
	<link rel="stylesheet" href="/resources/css/article.css" type="text/css">

	
	<link rel="icon" href="/assets/favicon.png">

	<title>Blazor Form Validation</title>
        <meta property="author" content="Shaun Curtis" />
        <meta property="description" content="A Blazor validation control to manage and monitor validation state in a form." />
    <meta property="og:site_name" content="Cold Elm Coders" />
        <meta property="og:site" content="https://shauncurtis.github.io/" />
        <meta property="og:title" content="Blazor Form Validation" />
        <meta property="og:description" content="A Blazor validation control to manage and monitor validation state in a form." /></head>
<body><header class="navbar bg-dark p-2 text-large text-light"><section class="navbar-section  text-light"><a href="/" class="navbar-brand mr-2 text-large text-light p-2">Cold Elm Coders</a>
			<a href="/Posts" class="btn btn-link text-light">Posts</a>
			<a href="/Rants" class="btn btn-link text-light">Rants</a>
			<a href="/Articles" class="btn btn-link text-light">Articles</a>
			<a href="/Stories" class="btn btn-link text-light">Stories</a>
			<a href="/about.html" class="btn btn-link text-light">About</a></section></header>

	<div class="container-fluid"><div class="row"><div class="col-12 col-sm-3 col-lg-2 bg-light pt-2"><div class="article-info p-2"><div class="mb-2">Published: 11-Mar-2021</div>
                <div class="mb-2">Updated: 16-Mar-2021</div>
                <div class="mb-2">Author: Shaun Curtis</div></div>
    <h4 class="p-2">Table of Contents</h4>
<ul class="TOC" >
<li class="TOC-item TOC-item-0" >
<a class="TOC-link" href="#">Top</a>
<ul class="TOC TOC-0" >
<li class="TOC-item TOC-item-1" >
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#overview">Overview</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#code-and-examples">Code and Examples</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#related-articles">Related Articles</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#the-blazor-edit-setting">The Blazor Edit Setting</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#validator">Validator</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#validationformstate-control">ValidationFormState Control</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#a-simple-implementation">A Simple Implementation</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#wrap-up">Wrap Up</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
			
			<div class="col-12 col-sm-9 col-lg-10 p-2"><div class="pt-2 pb-2 border-bottom mb-4 text-primary"><h1>Blazor Form Validation</h1>
            <div><small>A Blazor validation control to manage and monitor validation state in a form.</small></div></div>
    <h2 id="overview">Overview</h2>
<p>This is the second in a series of articles describing a set of useful Blazor Edit controls that solve some of the current shortcomings in the out-of-the-box edit experience without the need to buy expensive toolkits.</p>
<p>This article covers how form validation works and shows how to build a relatively simple but fully featured validation system from scratch. Once the basic structure and classes are defined, it's easy to write additional validation chain methods for any new validation requirement or validator for a custom class.</p>
<p><img src="https://shauncurtis.github.io/articles/assets/Editor-Controls/ValidationFormState.png" alt="EditForm" /></p>
<h2 id="code-and-examples">Code and Examples</h2>
<p>The repository contains a project that implements the controls for all the articles in this series.  You can find it <a href="https://github.com/ShaunCurtis/Blazor.Database">here</a>.</p>
<p>The example site is here <a href="https://cec-blazor-database.azurewebsites.net/">https://cec-blazor-database.azurewebsites.net/</a>.</p>
<p>The example form described at this end of this article can be seen at <a href="https://cec-blazor-database.azurewebsites.net//validationeditor">https://cec-blazor-database.azurewebsites.net//validationeditor</a>.</p>
<blockquote>
<p>The Repo is a Work In Progress for future articles so will change and develop.</p>
</blockquote>
<h2 id="related-articles">Related Articles</h2>
<p>The three articles are:</p>
<ul>
<li><a href="https://shauncurtis.github.io/articles/EditFormState.html">Managing Edit form State</a></li>
<li><a href="https://shauncurtis.github.io/articles/ValidationFormState.html">Managing Validation State</a></li>
<li><a href="https://shauncurtis.github.io/articles/Inline-Dialog.html">The Inline Dialog Control</a></li>
</ul>
<p>There's also an article on building a Modal Dialog Editor <a href="https://shauncurtis.github.io/articles/Modal-Editor.html">here</a>.</p>
<h2 id="the-blazor-edit-setting">The Blazor Edit Setting</h2>
<p>To begin lets look at the out-of-the-box form controls and how validation works.  A classic form looks something like this:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">EditForm</span> <span style="color:#FF0000;">Model</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@exampleModel&quot;</span> <span style="color:#FF0000;">OnValidSubmit</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@HandleValidSubmit&quot;</span><span style="color:#569CD6;">&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">DataAnnotationsValidator</span> <span style="color:#569CD6;">/&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">ValidationSummary</span> <span style="color:#569CD6;">/&gt;</span>

    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">InputText</span> <span style="color:#FF0000;">id</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;name&quot; @bind-Value=&quot;exampleModel.Name&quot;</span> <span style="color:#569CD6;">/&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">ValidationMessage</span> <span style="color:#FF0000;">For</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@(() =&gt; exampleModel.Name)&quot;</span> <span style="color:#569CD6;">/&gt;</span>

    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">button</span> <span style="color:#FF0000;">type</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;submit&quot;</span><span style="color:#569CD6;">&gt;</span>Submit<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">button</span><span style="color:#569CD6;">&gt;</span>
<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">EditForm</span><span style="color:#569CD6;">&gt;</span>
</pre></div>
<p>The first article describes the basic interacts of <code>EditForm</code> and <code>EditContext</code> so we'll skip that and concentrate on the validation process.</p>
<p>When the user clicks on the <em>Submit</em> button, <code>EditForm</code> either:</p>
<ol>
<li>If a delegate is registered with <code>OnSubmit</code>, it triggers it and ignores validation.</li>
<li>If there's no <code>OnSubmit</code> delegate, it calls <code>EditContext.Validate</code>.  Depending on the result either triggers <code>OnValidSubmit</code> or <code>OnInvalidSubmit</code>.</li>
</ol>
<p><code>EditContext.Validate</code> checks if there's a delagate registered for <code>OnValidationRequested</code> and if so runs it synchronously.  Once complete it checks if there are any messages in the <code>ValidationMessageStore</code>.  If it's empty, the form passes validation and <code>OnValidSubmit</code> is invoked, otherwise <code>OnInvalidSubmit</code> is invoked.</p>
<p>A Validator is a form component with no emitted markup.  It's placed within <code>EditForm</code> and captures the cascaded <code>EditContext</code>.  On initialization it registers an event handler with <code>EditContext.OnValidationRequested</code> to trigger validation.  On validation, the validator does whatever it's coded to do, logs validation failure messages to the <code>EditContext</code> <code>ValidationMessageStore</code> and finally calls <code>EditContext.NotifyValidationStateChanged</code> which triggers <code>EditContext.OnValidationStateChanged</code>.</p>
<h4 id="validation-controls">Validation Controls</h4>
<p>Controls such as <code>ValidationMessage</code> and <code>ValidationSummary</code> capture the cascaded <code>EditContext</code> and register event handlers on <code>EditContext.OnValidationStateChanged</code>.  When triggered they check for any relevant messages and display them.</p>
<p>In the form shown above <code>&lt;DataAnnotationsValidator /&gt;</code> adds the <code>DataAnnotationsValidator</code> control to the form.  This hooks in as described above, and uses the custom attribute annotations on the model class to validate values.</p>
<h2 id="validator">Validator</h2>
<p><code>Validator</code> is the base validator class.  It's declared abstract and uses generics.  Validators work on a chaining principle.  The base class contains all the common boilerplate code.</p>
<ol>
<li>The first call is on an extension method defined for the object type to be validated.  Each object type needs it's own extension method to call it's specific validator.  This extension method returns the appropriate validator for the object type.</li>
<li>Once you have the validator instance you can chain as many validation methods as you wish together.  Each is coded to run it's validation test, log any specific messages to the validator, trigger the trip if necessary, and return the validator instance.</li>
<li>Validation finishes by calling <code>Validate</code>, which trips the passed tripwire if necessary, and log all the validation messages to the <code>ValidationMessageStore</code>.</li>
</ol>
<p>The <code>Validator</code> Properties/Fields are:</p>
<pre><code>public bool IsValid =&gt; !Trip;
public List&lt;string&gt; Messages { get; } = new List&lt;string&gt;();
protected bool Trip { get; set; } = false;
protected string FieldName { get; set; }
protected T Value { get; set; }
protected string DefaultMessage { get; set; } = &quot;The value failed validation&quot;;
protected ValidationMessageStore ValidationMessageStore { get; set; }
protected object Model { get; set; }
</code></pre>
<p>The constructor populates the validator</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> Validator(T value, <span style="color:#569CD6;">string</span> fieldName, <span style="color:#569CD6;">object</span> model, ValidationMessageStore validationMessageStore, <span style="color:#569CD6;">string</span> message)
{
    <span style="color:#569CD6;">this</span>.FieldName = fieldName;
    <span style="color:#569CD6;">this</span>.Value = value;
    <span style="color:#569CD6;">this</span>.Model = model;
    <span style="color:#569CD6;">this</span>.ValidationMessageStore = validationMessageStore;
    <span style="color:#569CD6;">this</span>.DefaultMessage = <span style="color:#569CD6;">string</span>.IsNullOrWhiteSpace(message) ? <span style="color:#569CD6;">this</span>.DefaultMessage : message;
}
</pre></div>
<p>There are two <code>Validate</code> methods: a public method for external usage and a protected one for specific validators to override.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>

<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">virtual</span> <span style="color:#569CD6;">bool</span> Validate(<span style="color:#569CD6;">ref</span> <span style="color:#569CD6;">bool</span> tripwire, <span style="color:#569CD6;">string</span> fieldname, <span style="color:#569CD6;">string</span> message = <span style="color:#569CD6;">null</span>)
{
    <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">string</span>.IsNullOrEmpty(fieldname) || <span style="color:#569CD6;">this</span>.FieldName.Equals(fieldname))
    {
        <span style="color:#569CD6;">this</span>.Validate(message);
        <span style="color:#569CD6;">if</span> (!<span style="color:#569CD6;">this</span>.IsValid)
            tripwire = <span style="color:#569CD6;">true</span>;
    }
    <span style="color:#569CD6;">else</span> <span style="color:#569CD6;">this</span>.Trip = <span style="color:#569CD6;">false</span>;
    <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">this</span>.IsValid;
}
</pre></div><div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">virtual</span> <span style="color:#569CD6;">bool</span> Validate(<span style="color:#569CD6;">string</span> message = <span style="color:#569CD6;">null</span>)
{
    <span style="color:#569CD6;">if</span> (!<span style="color:#569CD6;">this</span>.IsValid)
    {
        message ??= <span style="color:#569CD6;">this</span>.DefaultMessage;
        <span style="color:#57A64A;">// Check if we&#39;ve logged specific messages.  If not add the default message</span>
        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">this</span>.Messages.Count == <span style="color:#B5CEA8;">0</span>) Messages.Add(message);
        <span style="color:#57A64A;">//set up a FieldIdentifier and add the message to the Edit Context ValidationMessageStore</span>
        <span style="color:#569CD6;">var</span> fi = <span style="color:#569CD6;">new</span> FieldIdentifier(<span style="color:#569CD6;">this</span>.Model, <span style="color:#569CD6;">this</span>.FieldName);
        <span style="color:#569CD6;">this</span>.ValidationMessageStore.Add(fi, <span style="color:#569CD6;">this</span>.Messages);
    }
    <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">this</span>.IsValid;
}

<span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">void</span> LogMessage(<span style="color:#569CD6;">string</span> message)
{
    <span style="color:#569CD6;">if</span> (!<span style="color:#569CD6;">string</span>.IsNullOrWhiteSpace(message)) Messages.Add(message);
}
</pre></div><h4 id="stringvalidator">StringValidator</h4>
<p>Let's look at <code>StringValidator</code> as an example implementation of a validator.  The full set of validators is in the Repo.  There are two classes:</p>
<ol>
<li><code>StringValidatorExtensions</code> is a static class declaring as an extension method to <code>string</code>.</li>
<li><code>StringValidator</code> is a implementation of <code>Validator</code> specifically for strings.</li>
</ol>
<p><code>StringValidatorExtensions</code> declares a single static extension method <code>Validation</code> for <code>string</code>.  It returns a <code>StringValidator</code> instance.  Call <code>StringValidator</code> on any string to initialise a validation chain.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> <span style="color:#569CD6;">class</span> StringValidatorExtensions
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> StringValidator Validation(<span style="color:#569CD6;">this</span> <span style="color:#569CD6;">string</span> value, <span style="color:#569CD6;">string</span> fieldName, <span style="color:#569CD6;">object</span> model, ValidationMessageStore validationMessageStore, <span style="color:#569CD6;">string</span> message = <span style="color:#569CD6;">null</span>)
    {
        <span style="color:#569CD6;">var</span> validation = <span style="color:#569CD6;">new</span> StringValidator(value, fieldName, model, validationMessageStore, message);
        <span style="color:#569CD6;">return</span> validation;
    }
}
</pre></div>
<p><code>StringValidator</code> inherits from <code>Validator</code> and declares the specific validation chain methods for strings.  Each runs it's test.  If validation fails it logs any provided message to the message store and trips the tripwire.  Finally it returns <code>this</code>.  For strings, we have two length methods and a RegEx method to cover most circumstances.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> StringValidator : Validator&lt;<span style="color:#569CD6;">string</span>&gt;
{
    <span style="color:#569CD6;">public</span> StringValidator(<span style="color:#569CD6;">string</span> value, <span style="color:#569CD6;">string</span> fieldName, <span style="color:#569CD6;">object</span> model, ValidationMessageStore validationMessageStore, <span style="color:#569CD6;">string</span> message) : <span style="color:#569CD6;">base</span>(value, fieldName, model, validationMessageStore, message) { }

    <span style="color:#608B4E;">///</span><span style="color:#608B4E;"> Check of the string is longer than test</span>
    <span style="color:#569CD6;">public</span> StringValidator LongerThan(<span style="color:#569CD6;">int</span> test, <span style="color:#569CD6;">string</span> message = <span style="color:#569CD6;">null</span>)
    {
        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">string</span>.IsNullOrEmpty(<span style="color:#569CD6;">this</span>.Value) || !(<span style="color:#569CD6;">this</span>.Value.Length &gt; test))
        {
            Trip = <span style="color:#569CD6;">true</span>;
            LogMessage(message);
        }
        <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">this</span>;
    }

    <span style="color:#608B4E;">///</span><span style="color:#608B4E;"> Check if the string is shorter than</span>
    <span style="color:#569CD6;">public</span> StringValidator ShorterThan(<span style="color:#569CD6;">int</span> test, <span style="color:#569CD6;">string</span> message = <span style="color:#569CD6;">null</span>)
    {
            
        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">string</span>.IsNullOrEmpty(<span style="color:#569CD6;">this</span>.Value) || !(<span style="color:#569CD6;">this</span>.Value.Length &lt; test))
        {
            Trip = <span style="color:#569CD6;">true</span>;
            LogMessage(message);
        }
        <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">this</span>;
    }

    <span style="color:#608B4E;">///</span><span style="color:#608B4E;"> Check if the string is matches a RegEx pattern</span>
    <span style="color:#569CD6;">public</span> StringValidator Matches(<span style="color:#569CD6;">string</span> pattern, <span style="color:#569CD6;">string</span> message = <span style="color:#569CD6;">null</span>)
    {
        <span style="color:#569CD6;">if</span> (!<span style="color:#569CD6;">string</span>.IsNullOrWhiteSpace(<span style="color:#569CD6;">this</span>.Value))
        {
            <span style="color:#569CD6;">var</span> match = Regex.Match(<span style="color:#569CD6;">this</span>.Value, pattern);
            <span style="color:#569CD6;">if</span> (match.Success &amp;&amp; match.Value.Equals(<span style="color:#569CD6;">this</span>.Value)) <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">this</span>;
        }
        <span style="color:#569CD6;">this</span>.Trip = <span style="color:#569CD6;">true</span>;
        LogMessage(message);
        <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">this</span>;
    }
}
</pre></div><h4 id="ivalidation">IValidation</h4>
<p>The  <code>IValidation</code> interface looks like this.  It simply defines a <code>Validate</code> method.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">interface</span> IValidation
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> Validate(ValidationMessageStore validationMessageStore, <span style="color:#569CD6;">string</span> fieldname, <span style="color:#569CD6;">object</span> model = <span style="color:#569CD6;">null</span>);
}
</pre></div><h3 id="weatherforecast">WeatherForecast</h3>
<p><code>WeatherForecast</code> is a typical data class.</p>
<ol>
<li>It implements <code>IValidation</code> so the control can run validation.</li>
<li>Each field is declared as a property with default values.</li>
<li>It implements <code>IValidation.Validate</code> which calls three validations.</li>
</ol>
<p>Each validation:</p>
<ol>
<li>Calls the <code>Validation</code> extension method on the type.</li>
<li>Calls one or more validation chain methods.</li>
<li>Calls <code>Validate</code> to log any validation messages to the <code>ValidationMessageStore</code> on <code>EditContext</code> and if necessary trip the tripwire.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> WeatherForecast : IValidation
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">int</span> ID { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = -<span style="color:#B5CEA8;">1</span>;
    <span style="color:#569CD6;">public</span> DateTime Date { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = DateTime.Now;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">int</span> TemperatureC { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#B5CEA8;">0</span>;
    [NotMapped] <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">int</span> TemperatureF =&gt; <span style="color:#B5CEA8;">32</span> + (<span style="color:#569CD6;">int</span>)(TemperatureC / <span style="color:#B5CEA8;">0</span>.<span style="color:#B5CEA8;">5556</span>);
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">string</span> Summary { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">string</span>.Empty;

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> Validate(ValidationMessageStore validationMessageStore, <span style="color:#569CD6;">string</span> fieldname, <span style="color:#569CD6;">object</span> model = <span style="color:#569CD6;">null</span>)
    {
        model = model ?? <span style="color:#569CD6;">this</span>;
        <span style="color:#569CD6;">bool</span> trip = <span style="color:#569CD6;">false</span>;

        <span style="color:#569CD6;">this</span>.Summary.Validation(<span style="color:#D69D85;">&quot;Summary&quot;</span>, model, validationMessageStore)
            .LongerThan(<span style="color:#B5CEA8;">2</span>, <span style="color:#D69D85;">&quot;Your description needs to be a little longer! 3 letters minimum&quot;</span>)
            .Validate(<span style="color:#569CD6;">ref</span> trip, fieldname);

        <span style="color:#569CD6;">this</span>.Date.Validation(<span style="color:#D69D85;">&quot;Date&quot;</span>, model, validationMessageStore)
            .NotDefault(<span style="color:#D69D85;">&quot;You must select a date&quot;</span>)
            .LessThan(DateTime.Now.AddMonths(<span style="color:#B5CEA8;">1</span>), <span style="color:#569CD6;">true</span>, <span style="color:#D69D85;">&quot;Date can only be up to 1 month ahead&quot;</span>)
            .Validate(<span style="color:#569CD6;">ref</span> trip, fieldname);

        <span style="color:#569CD6;">this</span>.TemperatureC.Validation(<span style="color:#D69D85;">&quot;TemperatureC&quot;</span>, model, validationMessageStore)
            .LessThan(<span style="color:#B5CEA8;">70</span>, <span style="color:#D69D85;">&quot;The temperature must be less than 70C&quot;</span>)
            .GreaterThan(-<span style="color:#B5CEA8;">60</span>, <span style="color:#D69D85;">&quot;The temperature must be greater than -60C&quot;</span>)
            .Validate(<span style="color:#569CD6;">ref</span> trip, fieldname);

        <span style="color:#569CD6;">return</span> !trip;
    }

}
</pre></div><h2 id="validationformstate-control">ValidationFormState Control</h2>
<p>The <code>ValidationFormState</code> control replaces the basic Validator provided with Blazor.</p>
<ol>
<li>It captures the cascaded <code>EditContext</code>.</li>
<li><code>DoValidationOnFieldChange</code> controls field level validation. if true it validates a field when a user exits the field.  if false it only responds to form level validation requests through <code>EditContext</code>.</li>
<li><code>ValidStateChanged</code> is a callback for the parent to attach an event handler if required.</li>
<li><code>IsValid</code> is a public readonly property exposing the current validation state.  It checks if <code>EditContext</code> has any validation messages.</li>
<li><code>ValidationMessageStore</code> is the <code>EditContext</code>'s <code>ValidationMessageStore</code>.</li>
<li><code>validating</code> is a boolean field to ensure we don't stack validations.</li>
<li><code>disposedValue</code> is part of the <code>IDisposable</code> implementation.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    [CascadingParameter] <span style="color:#569CD6;">public</span> EditContext EditContext { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    [Parameter] <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> DoValidationOnFieldChange { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">true</span>;
    [Parameter] <span style="color:#569CD6;">public</span> EventCallback&lt;<span style="color:#569CD6;">bool</span>&gt; ValidStateChanged { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> IsValid =&gt; !EditContext?.GetValidationMessages().Any() ?? <span style="color:#569CD6;">true</span>;

    <span style="color:#569CD6;">private</span> ValidationMessageStore validationMessageStore;
    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">bool</span> validating = <span style="color:#569CD6;">false</span>;
    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">bool</span> disposedValue;
</pre></div>
<p>When the component initializes it gets the <code>ValidationMessageStore</code> from <code>EditContext</code>.  It checks if it's running field level validation, and if so registers <code>FieldChanged</code> with <code>EditContext.OnFieldChanged</code> event. Finally it registers <code>ValidationRequested</code> with <code>EditContext.OnValidationRequested</code>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> Task OnInitializedAsync()
    {
        Debug.Assert(<span style="color:#569CD6;">this</span>.EditContext != <span style="color:#569CD6;">null</span>);

        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">this</span>.EditContext != <span style="color:#569CD6;">null</span>)
        {
            <span style="color:#57A64A;">// Get the Validation Message Store from the EditContext</span>
            <span style="color:#569CD6;">this</span>.validationMessageStore = <span style="color:#569CD6;">new</span> ValidationMessageStore(<span style="color:#569CD6;">this</span>.EditContext);
            <span style="color:#57A64A;">// Wires up to the EditContext OnFieldChanged event</span>
            <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">this</span>.DoValidationOnFieldChange)
                <span style="color:#569CD6;">this</span>.EditContext.OnFieldChanged += FieldChanged;
            <span style="color:#57A64A;">// Wires up to the Editcontext OnValidationRequested event</span>
            <span style="color:#569CD6;">this</span>.EditContext.OnValidationRequested += ValidationRequested;
        }
        <span style="color:#569CD6;">return</span> Task.CompletedTask;
    }
</pre></div>
<p>The two event handlers call <code>Validate</code>, one with and one without the field name.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> FieldChanged(<span style="color:#569CD6;">object</span> sender, FieldChangedEventArgs e)
    =&gt; <span style="color:#569CD6;">this</span>.Validate(e.FieldIdentifier.FieldName);

<span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> ValidationRequested(<span style="color:#569CD6;">object</span> sender, ValidationRequestedEventArgs e)
    =&gt; <span style="color:#569CD6;">this</span>.Validate();
</pre></div>
<p>The comments within <code>Validate</code> explain what it's doing.  It casts the <code>Model</code> as an IValidator and check if it's valid.  if so it calls the <code>Validate</code> method on the interface. We've seen <em>model</em>.<code>Validate</code> in the <code>WesatherForecast</code> data class.  When it passes a <code>fieldname</code> to <code>Validate</code> it only clears any validation messages for that specific <code>fieldname</code>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> Validate(<span style="color:#569CD6;">string</span> fieldname = <span style="color:#569CD6;">null</span>)
{
    <span style="color:#57A64A;">// Checks to see if the Model implements IValidation</span>
    <span style="color:#569CD6;">var</span> validator = <span style="color:#569CD6;">this</span>.EditContext.Model <span style="color:#569CD6;">as</span> IValidation;
    <span style="color:#569CD6;">if</span> (validator != <span style="color:#569CD6;">null</span> || !<span style="color:#569CD6;">this</span>.validating)
    {
        <span style="color:#569CD6;">this</span>.validating = <span style="color:#569CD6;">true</span>;
        <span style="color:#57A64A;">// Check if we are doing a field level or form level validation</span>
        <span style="color:#57A64A;">// Form level - clear all validation messages</span>
        <span style="color:#57A64A;">// Field level - clear any field specific validation messages</span>
        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">string</span>.IsNullOrEmpty(fieldname))
            <span style="color:#569CD6;">this</span>.validationMessageStore.Clear();
        <span style="color:#569CD6;">else</span>
            validationMessageStore.Clear(<span style="color:#569CD6;">new</span> FieldIdentifier(<span style="color:#569CD6;">this</span>.EditContext.Model, fieldname));
        <span style="color:#57A64A;">// Run the IValidation interface Validate method</span>
        validator.Validate(validationMessageStore, fieldname, <span style="color:#569CD6;">this</span>.EditContext.Model);
        <span style="color:#57A64A;">// Notify the EditContext that the Validation State has changed - </span>
        <span style="color:#57A64A;">// This precipitates a OnValidationStateChanged event which the validation message controls are all plugged into</span>
        <span style="color:#569CD6;">this</span>.EditContext.NotifyValidationStateChanged();
        <span style="color:#57A64A;">// Invoke ValidationStateChanged</span>
        <span style="color:#569CD6;">this</span>.ValidStateChanged.InvokeAsync(<span style="color:#569CD6;">this</span>.IsValid);
        <span style="color:#569CD6;">this</span>.validating = <span style="color:#569CD6;">false</span>;
    }
}
</pre></div>
<p>The rest of the code consists of utility methods and <code>IDisposable</code> implementation.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>

        <span style="color:#608B4E;">///</span> <span style="color:#608B4E;">&lt;summary&gt;</span>
        <span style="color:#608B4E;">///</span><span style="color:#608B4E;"> Method to clear the Validation and Edit State </span>
        <span style="color:#608B4E;">///</span> <span style="color:#608B4E;">&lt;/summary&gt;</span>
        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Clear()
            =&gt; <span style="color:#569CD6;">this</span>.validationMessageStore.Clear();

        <span style="color:#57A64A;">// IDisposable Implementation</span>
        <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">virtual</span> <span style="color:#569CD6;">void</span> Dispose(<span style="color:#569CD6;">bool</span> disposing)
        {
            <span style="color:#569CD6;">if</span> (!disposedValue)
            {
                <span style="color:#569CD6;">if</span> (disposing)
                {
                    <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">this</span>.EditContext != <span style="color:#569CD6;">null</span>)
                    {
                        <span style="color:#569CD6;">this</span>.EditContext.OnFieldChanged -= <span style="color:#569CD6;">this</span>.FieldChanged;
                        <span style="color:#569CD6;">this</span>.EditContext.OnValidationRequested -= <span style="color:#569CD6;">this</span>.ValidationRequested;
                    }
                }
                disposedValue = <span style="color:#569CD6;">true</span>;
            }
        }

        <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Dispose()
        {
            <span style="color:#57A64A;">// Do not change this code. Put cleanup code in &#39;Dispose(bool disposing)&#39; method</span>
            Dispose(disposing: <span style="color:#569CD6;">true</span>);
            GC.SuppressFinalize(<span style="color:#569CD6;">this</span>);
        }
</pre></div><h2 id="a-simple-implementation">A Simple Implementation</h2>
<p><img src="https://shauncurtis.github.io/articles/assets/Editor-Controls/ValidationFormState.png" alt="EditForm" /></p>
<p>To test the component, here's a simple test page.</p>
<p>Change the temperature up and down and you should see the buttons change colour and Text, and enabled/disabled state.  Change the Temperature to 200 to get a validation message.</p>
<p>You can see this at <a href="https://cec-blazor-database.azurewebsites.net//validationeditor">https://cec-blazor-database.azurewebsites.net//validationeditor</a>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
@using Blazor.Database.Data
@page &quot;/validationeditor&quot;

<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">EditForm</span> <span style="color:#FF0000;">Model</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@Model&quot;</span> <span style="color:#FF0000;">OnValidSubmit</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@HandleValidSubmit&quot;</span><span style="color:#569CD6;">&gt;</span>
    &lt;EditFormState @ref=&quot;editFormState&quot; EditStateChanged=&quot;this.EditStateChanged&quot;&gt;<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">EditFormState</span><span style="color:#569CD6;">&gt;</span>
    &lt;ValidationFormState @ref=&quot;validationFormState&quot;&gt;<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">ValidationFormState</span><span style="color:#569CD6;">&gt;</span>

    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">label</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-label&quot;</span><span style="color:#569CD6;">&gt;</span>ID:<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">label</span><span style="color:#569CD6;">&gt;</span> <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">InputNumber</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-control&quot; @bind-Value=&quot;Model.ID&quot;</span> <span style="color:#569CD6;">/&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">label</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-label&quot;</span><span style="color:#569CD6;">&gt;</span>Date:<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">label</span><span style="color:#569CD6;">&gt;</span> <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">InputDate</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-control&quot; @bind-Value=&quot;Model.Date&quot;</span> <span style="color:#569CD6;">/&gt;</span><span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">ValidationMessage</span> <span style="color:#FF0000;">For</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@(() =&gt; Model.Date)&quot;</span> <span style="color:#569CD6;">/&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">label</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-label&quot;</span><span style="color:#569CD6;">&gt;</span>Temp C:<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">label</span><span style="color:#569CD6;">&gt;</span> <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">InputNumber</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-control&quot; @bind-Value=&quot;Model.TemperatureC&quot;</span> <span style="color:#569CD6;">/&gt;</span><span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">ValidationMessage</span> <span style="color:#FF0000;">For</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@(() =&gt; Model.TemperatureC)&quot;</span> <span style="color:#569CD6;">/&gt;</span>
    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">label</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-label&quot;</span><span style="color:#569CD6;">&gt;</span>Summary:<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">label</span><span style="color:#569CD6;">&gt;</span> <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">InputText</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;form-control&quot; @bind-Value=&quot;Model.Summary&quot;</span> <span style="color:#569CD6;">/&gt;</span><span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">ValidationMessage</span> <span style="color:#FF0000;">For</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@(() =&gt; Model.Summary)&quot;</span> <span style="color:#569CD6;">/&gt;</span>

    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">div</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;mt-2&quot;</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">div</span><span style="color:#569CD6;">&gt;</span>Validation Messages:<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">div</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">ValidationSummary</span> <span style="color:#569CD6;">/&gt;</span>
    <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">div</span><span style="color:#569CD6;">&gt;</span>

    <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">div</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;text-right mt-2&quot;</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">button</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn @btnStateColour&quot;</span> <span style="color:#FF0000;">disabled</span><span style="color:#569CD6;">&gt;</span>@btnStateText<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">button</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">button</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn @btnValidColour&quot;</span> <span style="color:#FF0000;">disabled</span><span style="color:#569CD6;">&gt;</span>@btnValidText<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">button</span><span style="color:#569CD6;">&gt;</span>
        <span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">button</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn btn-primary&quot;</span> <span style="color:#FF0000;">type</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;submit&quot;</span> <span style="color:#FF0000;">disabled</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;@_btnSubmitDisabled&quot;</span><span style="color:#569CD6;">&gt;</span>Submit<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">button</span><span style="color:#569CD6;">&gt;</span>
    <span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">div</span><span style="color:#569CD6;">&gt;</span>

<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">EditForm</span><span style="color:#569CD6;">&gt;</span>
</pre></div><div style="color:#DADADA;background-color:#1E1E1E;"><pre>
@code {
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">bool</span> _isDirty = <span style="color:#569CD6;">false</span>;
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">bool</span> _isValid =&gt; validationFormState?.IsValid ?? <span style="color:#569CD6;">true</span>;
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">string</span> btnStateColour =&gt; _isDirty ? <span style="color:#D69D85;">&quot;btn-danger&quot;</span> : <span style="color:#D69D85;">&quot;btn-success&quot;</span>;
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">string</span> btnStateText =&gt; _isDirty ? <span style="color:#D69D85;">&quot;Dirty&quot;</span> : <span style="color:#D69D85;">&quot;Clean&quot;</span>;
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">string</span> btnValidColour =&gt; !_isValid ? <span style="color:#D69D85;">&quot;btn-danger&quot;</span> : <span style="color:#D69D85;">&quot;btn-success&quot;</span>;
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">string</span> btnValidText =&gt; !_isValid ? <span style="color:#D69D85;">&quot;Invalid&quot;</span> : <span style="color:#D69D85;">&quot;Valid&quot;</span>;
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">bool</span> _btnSubmitDisabled =&gt; !(_isValid &amp;&amp; _isDirty);

    <span style="color:#569CD6;">protected</span> EditFormState editFormState { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    <span style="color:#569CD6;">protected</span> ValidationFormState validationFormState { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

    <span style="color:#569CD6;">private</span> WeatherForecast Model = <span style="color:#569CD6;">new</span> WeatherForecast()
    {
        ID = <span style="color:#B5CEA8;">1</span>,
        Date = DateTime.Now,
        TemperatureC = <span style="color:#B5CEA8;">22</span>,
        Summary = <span style="color:#D69D85;">&quot;Balmy&quot;</span>
    };

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> HandleValidSubmit()
        =&gt; <span style="color:#569CD6;">this</span>.editFormState.UpdateState();

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">void</span> EditStateChanged(<span style="color:#569CD6;">bool</span> editstate)
        =&gt; <span style="color:#569CD6;">this</span>._isDirty = editstate;
}
</pre></div><h2 id="wrap-up">Wrap Up</h2>
<p>Hopefully I've explained how validation works and how to build a simple, but comprehensive and extensible validation system.</p>
<p>The most common problem with validation is <code>ValidationMessage</code> controls not showing messages.  There are normally two reasons for this:</p>
<ol>
<li>The UI hasn't updated.  Step through the code to check what's happening when.</li>
<li>The <code>FieldIdentifier</code> generated from the <code>For</code> property of <code>ValidationMessage</code> doesn't match the <code>FieldIdentifier</code> in the validation store.  Check the <code>FieldIdentifier</code> you're generating and logging to the validation store.</li>
</ol>
<p>The next article shows how to lock out the form and prevent navigation when the form is dirty.</p>
<p>If you've found this article well into the future, the latest version will be available <a href="https://shauncurtis.github.io/articles/ValidationFormState.html">here</a></p>
</div></div></div></body></html>





