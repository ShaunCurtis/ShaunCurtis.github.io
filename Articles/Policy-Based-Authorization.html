<!DOCTYPE html>
<html lang="en"><head><meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<base href="/">

	

	

	
	<link href="/resources/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
	<link href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">

	
	<link href="/resources/css/sb-admin-2.css" rel="stylesheet" type="text/css">
	<link href="/resources/css/site.css" rel="stylesheet" type="text/css">

	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
	<link rel="stylesheet" href="/resources/css/article.css" type="text/css">

	
	<link rel="icon" href="/assets/favicon.png">

	<title>Policy Base Authorization in Blazor</title>
        <meta property="author" content="Shaun Curtis" />
        <meta property="description" content="This article describes how to implement policy based authentication in blazor Applications." />
    <meta property="og:site_name" content="Cold Elm Coders" />
        <meta property="og:site" content="https://shauncurtis.github.io/" />
        <meta property="og:title" content="Policy Base Authorization in Blazor" />
        <meta property="og:description" content="This article describes how to implement policy based authentication in blazor Applications." /></head>
<body><header class="navbar bg-dark p-2 text-large text-light"><section class="navbar-section  text-light"><a href="/" class="navbar-brand mr-2 text-large text-light p-2">Cold Elm Coders</a>
			<a href="/Posts" class="btn btn-link text-light">Posts</a>
			<a href="/Rants" class="btn btn-link text-light">Rants</a>
			<a href="/Articles" class="btn btn-link text-light">Articles</a>
			<a href="/Stories" class="btn btn-link text-light">Stories</a>
			<a href="/about.html" class="btn btn-link text-light">About</a></section></header>

	<div class="container-fluid"><div class="row"><div class="col-12 col-sm-3 col-lg-2 bg-light pt-2"><div class="article-info p-2"><div class="mb-2">Published: 26-Feb-2021</div>
                <div class="mb-2">Updated: 26-Feb-2021</div>
                <div class="mb-2">Author: Shaun Curtis</div></div>
    <h4 class="p-2">Table of Contents</h4>
<ul class="TOC" >
<li class="TOC-item TOC-item-0" >
<a class="TOC-link" href="#">Top</a>
<ul class="TOC TOC-0" >
<li class="TOC-item TOC-item-1" >
<a class="TOC-link" href="#introduction">Introduction</a>
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#repository-and-demonstrator">Repository and Demonstrator</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authentication-and-ownership">Authentication and Ownership</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authorization">Authorization</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authorization-button">Authorization Button</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#service-based-authorization">Service based Authorization</a>
</li>
</ul>
</li>
<li class="TOC-item TOC-item-1" >
<a class="TOC-link" href="#appendix">Appendix</a>
<ul class="TOC TOC-1" >
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#authentication">Authentication</a>
</li>
<li class="TOC-item TOC-item-2" >
<a class="TOC-link" href="#weather-forecast-ownership">Weather Forecast Ownership</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
			
			<div class="col-12 col-sm-9 col-lg-10 p-2"><div class="pt-2 pb-2 border-bottom mb-4 text-primary"><h1>Policy Base Authorization in Blazor</h1>
            <div><small>This article describes how to implement policy based authentication in blazor Applications.</small></div></div>
    <h1 id="introduction">Introduction</h1>
<p>Many applications require more granular and complex authorization that the canned examples in many demos.  This article shows:</p>
<ol>
<li>How use and manage policy based authorization in an application.</li>
<li>How to build and manage policies in static classes.</li>
<li>How to build complex resource based policy classes to authorize an identity against.</li>
</ol>
<h2 id="repository-and-demonstrator">Repository and Demonstrator</h2>
<p>The project associated with this article is available <a href="https://github.com/ShaunCurtis/Blazr.Demo.Authorization">here on Github</a>.  The project is based on my <a href="https://github.com/ShaunCurtis/Blazr.Demo">Blazr.Demo</a> project template that implements basic clean design principles.</p>
<h2 id="authentication-and-ownership">Authentication and Ownership</h2>
<p>Discussing Authorization is a little like putting the cart before the horse.  To authorize we need an authenticated identity.</p>
<p>For this article we use a very simple authenticator.</p>
<ol>
<li><code>VerySimpleAuthenticationProvider</code> returns a standard <code>IndentityPrincipal</code> instance with a Guid security Id and a role.</li>
<li><code>UserDisplay</code> is the equivalent to a log in page.  It's a simple select in the top <code>NavBar</code> that makes changing identity simple and quick.</li>
</ol>
<p>The record set we use is the classic weather forecast.  I've added an <code>OwnerId</code> to the record so we can allow record owners to edit and delete their own records.</p>
<p>The code for the authenticator, component and weather forecast record is in the bottom of this article.</p>
<p>The image below shows the Identity select and the <code>FetchData</code> page for the user &quot;Visitor-2&quot;.</p>
<p><img src="./assets/Policy-Based-Authentication/App-View.png" alt="App View" /></p>
<h2 id="authorization">Authorization</h2>
<p>Before delving into the detail, let's look at the end result.</p>
<ol>
<li>An anonymous user can view the list, but that's all.</li>
</ol>
<p><img src="./assets/Policy-Based-Authentication/Anonymous.png" alt="App View" /></p>
<ol start="2">
<li>Users can edit or view any record, but not delete one.</li>
</ol>
<p><img src="./assets/Policy-Based-Authentication/User.png" alt="App View" /></p>
<ol start="3">
<li>Admins you can Edit/View/Delete all records.</li>
</ol>
<p><img src="./assets/Policy-Based-Authentication/Admin.png" alt="App View" /></p>
<ol start="4">
<li>Visitors can view all the records, but only Edit/Delete your own.</li>
</ol>
<p><img src="./assets/Policy-Based-Authentication/Visitor.png" alt="App View" /></p>
<ol start="5">
<li>Applying authorization to a backend service.  We may show the &quot;Add Record&quot; to the identity, but the service applies a <code>User/Admin</code> only policy. So a visitor can click the &quot;Add Record&quot; button , but the backend refuses to add the record.  In the demo I show a simple message.</li>
</ol>
<p><img src="./assets/Policy-Based-Authentication/Visitor-Add.png" alt="App View" /></p>
<h2 id="authorization-button">Authorization Button</h2>
<p>In the UI we normally click buttons to do things.  I've built an <code>AuthorizeButton</code> component to encapsulate this.  There are two versions:</p>
<ol>
<li><code>AuthorizeButton</code> requires a policy.  This is the Add button at the top of the page.  We're just encapsulating specific <code>AuthorizeView</code> code into the button context.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">AuthorizeButton</span> <span style="color:#FF0000;">Policy</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">@AppPolicies.IsVisitor</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn btn-success&quot; @onclick=&quot;AddRecord&quot;</span><span style="color:#569CD6;">&gt;</span>Add Record<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">AuthorizeButton</span><span style="color:#569CD6;">&gt;</span>
</pre></div>
<ol start="2">
<li><code>AuthorizeRecordButton</code> requires a policy and an <code>AppAuthFields</code> object built from a specific record.  This is the Edit button that appears in each row and uses the row record to populate the <code>AppAuthFields</code> instance.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">&lt;</span><span style="color:#A31515;">AuthorizeRecordButton</span> <span style="color:#FF0000;">Policy</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">@AppPolicies.IsEditorPolicy</span> <span style="color:#FF0000;">AuthFields</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;this.GetAuthFields(forecast)&quot;</span> <span style="color:#FF0000;">type</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;button&quot;</span> <span style="color:#FF0000;">class</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;btn-sm btn-primary&quot;</span> <span style="color:#FF0000;">ClickEvent</span><span style="color:#569CD6;">=</span><span style="color:#569CD6;">&quot;() =&gt; this.EditRecord(forecast.Id)&quot;</span><span style="color:#569CD6;">&gt;</span>Edit<span style="color:#569CD6;">&lt;/</span><span style="color:#A31515;">AuthorizeRecordButton</span><span style="color:#569CD6;">&gt;</span>
</pre></div>
<p><code>AppAuthFields</code> provides a generic method to pass specific information into the authorization process.  We can add more fields to it as required.  We'll see how it works later.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> record AppAuthFields
{
    <span style="color:#569CD6;">public</span> Guid OwnerId { <span style="color:#569CD6;">get</span>; init; }
}
</pre></div>
<p><code>AuthorizeButton</code> looks like this.  Much of the code is pretty standard component fare, so I'll concentrate on just the authorization bit.</p>
<p><code>OnInitialized</code> checks to ensure we have a <code>AuthTask</code> cascade i.e. we have the upstream authentication and authorization configured.  If not then it throws an exception.</p>
<p><code>BuildRenderTree</code> calls <code>CheckPolicy()</code> to check if it should render the button.</p>
<p><code>CheckPolicy</code> gets the authentication state and then calls <code>AuthorizeAsync</code> on the injected <code>IAuthorizationService</code>, passing in the <code>IdentityPrincipal</code> of the logging in identity, a null for the resource object (we'll come to resource objects shortly), and the policy name to apply.  If the result is <code>success</code>, it displays the button.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> AuthorizeButton : ComponentBase
{
    [Parameter] <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> Show { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">true</span>;
    [Parameter] <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">bool</span> Disabled { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">false</span>;
    [Parameter] <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">string</span> Policy { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = String.Empty;
    [Parameter] <span style="color:#569CD6;">public</span> RenderFragment? ChildContent { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    [Parameter] <span style="color:#569CD6;">public</span> EventCallback&lt;MouseEventArgs&gt; ClickEvent { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    [Parameter(CaptureUnmatchedValues = <span style="color:#569CD6;">true</span>)] <span style="color:#569CD6;">public</span> IDictionary&lt;<span style="color:#569CD6;">string</span>, <span style="color:#569CD6;">object</span>&gt; SplatterAttributes { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">new</span> Dictionary&lt;<span style="color:#569CD6;">string</span>, <span style="color:#569CD6;">object</span>&gt;();
    [CascadingParameter] <span style="color:#569CD6;">public</span> Task&lt;AuthenticationState&gt;? AuthTask { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

    [Inject] <span style="color:#569CD6;">protected</span> IAuthorizationService? _authorizationService { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    <span style="color:#569CD6;">protected</span> IAuthorizationService AuthorizationService =&gt; _authorizationService!;

    <span style="color:#569CD6;">protected</span> CSSBuilder CssClass = <span style="color:#569CD6;">new</span> CSSBuilder(<span style="color:#D69D85;">&quot;btn me-1&quot;</span>);

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">void</span> OnInitialized()
    {
        <span style="color:#569CD6;">if</span> (AuthTask <span style="color:#569CD6;">is</span> <span style="color:#569CD6;">null</span>)
            <span style="color:#569CD6;">throw</span> <span style="color:#569CD6;">new</span> Exception($<span style="color:#D69D85;">&quot;{this.GetType().FullName} must have access to cascading Paramater {nameof(AuthTask)}&quot;</span>);
    }

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">async</span> <span style="color:#569CD6;">void</span> BuildRenderTree(RenderTreeBuilder builder)
    {
        <span style="color:#569CD6;">if</span> (<span style="color:#569CD6;">this</span>.Show &amp;&amp; <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.CheckPolicy())
        {
            CssClass.AddClassFromAttributes(SplatterAttributes);
            builder.OpenElement(<span style="color:#B5CEA8;">0</span>, <span style="color:#D69D85;">&quot;button&quot;</span>);
            builder.AddMultipleAttributes(<span style="color:#B5CEA8;">1</span>, <span style="color:#569CD6;">this</span>.SplatterAttributes);
            builder.AddAttribute(<span style="color:#B5CEA8;">1</span>, <span style="color:#D69D85;">&quot;class&quot;</span>, CssClass.Build());

            <span style="color:#569CD6;">if</span> (Disabled)
                builder.AddAttribute(<span style="color:#B5CEA8;">4</span>, <span style="color:#D69D85;">&quot;disabled&quot;</span>);

            <span style="color:#569CD6;">if</span> (ClickEvent.HasDelegate)
                builder.AddAttribute(<span style="color:#B5CEA8;">5</span>, <span style="color:#D69D85;">&quot;onclick&quot;</span>, EventCallback.Factory.Create&lt;MouseEventArgs&gt;(<span style="color:#569CD6;">this</span>, ClickEvent));

            builder.AddContent(<span style="color:#B5CEA8;">6</span>, ChildContent);
            builder.CloseElement();
        }
    }

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">virtual</span> <span style="color:#569CD6;">async</span> Task&lt;<span style="color:#569CD6;">bool</span>&gt; CheckPolicy()
    {
        <span style="color:#569CD6;">var</span> state = <span style="color:#569CD6;">await</span> AuthTask!;
        <span style="color:#569CD6;">var</span> result = <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.AuthorizationService.AuthorizeAsync(state.User, <span style="color:#569CD6;">null</span>, Policy);
        <span style="color:#569CD6;">return</span> result.Succeeded;
    }
}

</pre></div>
<p><code>AuthorizeRecordButton</code> extends <code>AuthorizeButton</code>.  It passes an <code>AppAuthFields</code> obect to <code>AuthorizeAsync</code> as the resource object.  We'll see how the <code>AuthorizationService</code> uses this shortly.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> AuthorizeRecordButton : AuthorizeButton
{
    [Parameter] <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">object</span>? AuthFields { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> <span style="color:#569CD6;">async</span> Task&lt;<span style="color:#569CD6;">bool</span>&gt; CheckPolicy()
    {
        <span style="color:#569CD6;">var</span> state = <span style="color:#569CD6;">await</span> AuthTask!;
        <span style="color:#569CD6;">var</span> result = <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.AuthorizationService.AuthorizeAsync(state.User, AuthFields, Policy);
        <span style="color:#569CD6;">return</span> result.Succeeded;
    }
}
</pre></div><h3 id="policies">Policies</h3>
<p>It's important to understand the difference between a policy name and a policy object.  The Authorization service holds a map of policy names to policy objects.  When we provide a &quot;policy&quot; to an authorization component or call <code>AuthorizeAsync</code> on the <code>IAuthorizationService</code> we are providing the policy name.  It maps and uses the policy object associated with the policy name. The map is defined when the authorization services are set up in the application services collection in <code>Program</code>/<code>StartUp</code>.</p>
<p>Policy objects are defined as instances of the <code>AuthorizationPolicy</code> class and built using an <code>AuthorizationPolicyBuilder</code> instance.</p>
<p>The application defines a static <code>AppPolicies</code> class to hold and manage all the policy code.</p>
<ol>
<li>Defines a set of nomenclature constants for role and policy string names.</li>
<li>Builds out a set of policy objects using the <code>AuthorizationPolicyBuilder</code>.</li>
<li>Defines a dictionary of policy names to policy objects to load into <code>AuthorizationService</code>.</li>
<li>Defines an <code>IServiceCollection</code> extension method to add all the <code>IAuthorizationHandlers</code> required by the policies.</li>
</ol>
<p>The constants:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> <span style="color:#569CD6;">class</span> StandardPolicies
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> AdminRole = <span style="color:#D69D85;">&quot;AdminRole&quot;</span>;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> UserRole = <span style="color:#D69D85;">&quot;UserRole&quot;</span>;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> VisitorRole = <span style="color:#D69D85;">&quot;VisitorRole&quot;</span>;

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> IsEditorPolicy = <span style="color:#D69D85;">&quot;IsEditorPolicy&quot;</span>;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> IsViewerPolicy = <span style="color:#D69D85;">&quot;IsViewerPolicy&quot;</span>;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> IsManagerPolicy = <span style="color:#D69D85;">&quot;IsManagerPolicy&quot;</span>;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> IsAdminPolicy = <span style="color:#D69D85;">&quot;IsAdminPolicy&quot;</span>;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> IsUserPolicy = <span style="color:#D69D85;">&quot;IsUserPolicy&quot;</span>;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> IsVisitor = <span style="color:#D69D85;">&quot;IsVisitor&quot;</span>;
</pre></div>
<p>The basic Admin/User/Visitor site basded policy objects that check an identity is logged in and in one or more roles.</p>
<p>Note that for user to pass a policy they must satisfy all the requirements (an AND in logic terms).</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> AuthorizationPolicy IsAdminAuthorizationPolicy
        =&gt; <span style="color:#569CD6;">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .RequireRole(AdminRole)
        .Build();

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> AuthorizationPolicy IsUserAuthorizationPolicy
        =&gt; <span style="color:#569CD6;">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .RequireRole(AdminRole, UserRole)
        .Build();

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> AuthorizationPolicy IsVisitorAuthorizationPolicy
        =&gt; <span style="color:#569CD6;">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .RequireRole(AdminRole, UserRole, VisitorRole)
        .Build();

</pre></div>
<p>The record based policies.  These use requirements, defined in an <code>IAuthorizationRequirement</code> list.  We'll look at  <code>RecordEditorAuthorizationRequirement</code> and <code>RecordManagerAuthorizationRequirement</code> shortly.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> AuthorizationPolicy IsEditorAuthorizationPolicy
        =&gt; <span style="color:#569CD6;">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .AddRequirements(<span style="color:#569CD6;">new</span> RecordEditorAuthorizationRequirement())
        .Build();
    
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> AuthorizationPolicy IsManagerAuthorizationPolicy
        =&gt; <span style="color:#569CD6;">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .AddRequirements(<span style="color:#569CD6;">new</span> RecordManagerAuthorizationRequirement())
        .Build();

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> AuthorizationPolicy IsViewerAuthorizationPolicy
        =&gt; <span style="color:#569CD6;">new</span> AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .Build();
</pre></div>
<p>The <code>Policies</code> dictionary provides a convenient mechanism for defining and managing the application policies  <code>AuthorizationService</code> uses.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> Dictionary&lt;<span style="color:#569CD6;">string</span>, AuthorizationPolicy&gt; Policies
    {
        <span style="color:#569CD6;">get</span>
        {
            <span style="color:#569CD6;">var</span> policies = <span style="color:#569CD6;">new</span> Dictionary&lt;<span style="color:#569CD6;">string</span>, AuthorizationPolicy&gt;();

            policies.Add(IsAdminPolicy, IsAdminAuthorizationPolicy);
            policies.Add(IsUserPolicy, IsUserAuthorizationPolicy);
            policies.Add(IsVisitor, IsVisitorAuthorizationPolicy);

            policies.Add(IsManagerPolicy, IsManagerAuthorizationPolicy);
            policies.Add(IsEditorPolicy, IsEditorAuthorizationPolicy);
            policies.Add(IsViewerPolicy, IsViewerAuthorizationPolicy);
            <span style="color:#569CD6;">return</span> policies;
        }
    }
</pre></div>
<p>Finally an <code>IServiceCollection</code> extension to add the policy handler services.  More on these below.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> <span style="color:#569CD6;">void</span> AddAppPolicyServices(<span style="color:#569CD6;">this</span> IServiceCollection services)
    {
        services.AddSingleton&lt;IAuthorizationHandler, RecordOwnerEditorAuthorizationHandler&gt;();
        services.AddSingleton&lt;IAuthorizationHandler, RecordEditorAuthorizationHandler&gt;();
        services.AddSingleton&lt;IAuthorizationHandler, RecordManagerAuthorizationHandler&gt;();
        services.AddSingleton&lt;IAuthorizationHandler, RecordOwnerManagerAuthorizationHandler&gt;();
    }
</pre></div>
<p>Using the <code>AppPolicies</code> class, we can now define our services in <code>Program</code> or an application <code>IServiceCollection</code> extension method like this:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
services.AddScoped&lt;AuthenticationStateProvider, VerySimpleAuthenticationStateProvider&gt;();
services.AddAppPolicyServices();
services.AddAuthorization(config =&gt;
{
    <span style="color:#569CD6;">foreach</span> (<span style="color:#569CD6;">var</span> policy <span style="color:#569CD6;">in</span> AppPolicies.Policies)
    {
        config.AddPolicy(policy.Key, policy.Value);
    }
});
</pre></div><h3 id="authorization-requrements">Authorization Requrements</h3>
<p>Our policy object requirements are defined as classes implementing <code>IAuthorizationRequirement</code>.  <code>IAuthorizationRequirement</code> classes are empty reference classes.  We define two:</p>
<ol>
<li><code>RecordEditorAuthorizationRequirement</code> defines a record editor.</li>
<li><code>RecordManagerAuthorizationRequirement</code> defines a record manager.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> RecordEditorAuthorizationRequirement : IAuthorizationRequirement { }
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> RecordManagerAuthorizationRequirement : IAuthorizationRequirement { }
</pre></div>
<p>They are used by <code>IAuthorizationHandler</code> classes.</p>
<p>Requirements are assessed by the Policy on a OR logic basis.  An entity only needs satisfy one requirement of a collection to pass authorization.</p>
<h3 id="authorization-handlers">Authorization Handlers</h3>
<p>Authorization Handlers implement <code>IAuthorizationHandlers</code> and inherit from the  <code>AuthorizationHandler</code> base class.  The base class defines two generics:</p>
<ol>
<li><code>TRequirement</code> - The <code>AuthorizationRequirement</code> class that this <code>AuthorizationHandler</code> applies to.</li>
<li><code>TResource</code>, the resource type for the resource we will provide.  This is the <code>resource</code> object passed in <code>AuthorizationService.AuthorizeAsync</code>.  We pass <code>AppAuthFields</code> instances which we populate from a record.</li>
</ol>
<p>There are two mapped to each requirement.  The editor authorization handlers are shown below.</p>
<ol>
<li><code>TRequirement</code> is <code>RecordEditorAuthorizationRequirement</code></li>
<li><code>TResource</code> is <code>AppAuthFields</code>.</li>
<li><code>HandleRequirementAsync</code> is the method called to do the authorization.</li>
</ol>
<p><code>RecordOwnerEditorAuthorizationHandler</code>:</p>
<ol>
<li>Gets the user's Id from the <code>AuthorizationHandlerContext</code>.</li>
<li>Checks the Id against the <code>OwnerId</code> provided in the <code>AppAuthFields</code> instance</li>
<li>Sets success on the provided <code>AuthorizationHandlerContext</code> instance if the Ids match.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> RecordOwnerEditorAuthorizationHandler : AuthorizationHandler&lt;RecordEditorAuthorizationRequirement, AppAuthFields&gt;
{
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> Task HandleRequirementAsync(AuthorizationHandlerContext context, RecordEditorAuthorizationRequirement requirement, AppAuthFields data)
    {
        <span style="color:#569CD6;">var</span> entityId = context.User.GetIdentityId();
        <span style="color:#569CD6;">if</span> (entityId != Guid.Empty &amp;&amp; entityId == data.OwnerId)
            context.Succeed(requirement);

        <span style="color:#569CD6;">return</span> Task.CompletedTask;
    }
}
</pre></div>
<p><code>RecordEditorAuthorizationHandler</code> simply checks if the identity has the correct role.  We apply this check as an Authorization handler because it needs to be an OR.  The identity can be either the owner and/or have a User Role.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> RecordEditorAuthorizationHandler : AuthorizationHandler&lt;RecordEditorAuthorizationRequirement, AppAuthFields&gt;
{
    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">override</span> Task HandleRequirementAsync(AuthorizationHandlerContext context, RecordEditorAuthorizationRequirement requirement, AppAuthFields data)
    {
        <span style="color:#569CD6;">if</span> (context.User.IsInRole(AppPolicies.UserRole) || context.User.IsInRole(AppPolicies.AdminRole))
            context.Succeed(requirement);

        <span style="color:#569CD6;">return</span> Task.CompletedTask;
    }
}
</pre></div>
<p><code>GetIdentityId</code> is an extension method on <code>ClaimsPrincipal</code></p>
<pre><code>public static Guid GetIdentityId(this ClaimsPrincipal principal)
{
    if (principal is not null)
    {
        var claim = principal.Claims.FirstOrDefault(claim =&gt; claim.Type == ClaimTypes.Sid);
        if (claim is not null &amp;&amp; Guid.TryParse(claim.Value, out Guid id))
            return id;
    }
    return Guid.Empty;
}
</code></pre>
<h3 id="so-how-does-a-policy-work">So how does a policy work?</h3>
<p>The services container defines a set of IAuthorizationHandlers.  Each is &quot;mapped&quot; by it's <code>TRequirement</code> to a specific requirement class.  A policy defines one or more requirements, and is mapped to a name in the <code>AuthorizationService</code>.</p>
<p>So when we do this:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">var</span> result = <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.AuthorizationService.AuthorizeAsync(state.User, AuthFields, Policy);
</pre></div>
<p>We are telling the authorization service to check the user against the policy with the following <code>AuthFields</code> instance.  The service maps the policy name to an actual policy and calls the policy.  It gets a list of all the <code>IAuthorizationHandler</code> instances in the services container that handle the defined requirement class.  It runs <code>HandleRequirementsAsync</code> on each: the order doesn't matter it's an OR.  It returns on the first success.</p>
<h2 id="service-based-authorization">Service based Authorization</h2>
<p>In the application we use a <code>WeatherForecastViewService</code> to provide the data operations to <code>FetchData</code>.  You can see the full code in the project code.</p>
<p>To apply authorization we need to inject <code>AuthenticationStateProvider</code> and <code>AuthorizationService</code>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">private</span> AuthenticationStateProvider AuthenticationStateProvider { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

<span style="color:#569CD6;">private</span> IAuthorizationService AuthorizationService { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }

<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">string</span> Message { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">string</span>.Empty;

<span style="color:#569CD6;">public</span> WeatherForecastViewService(IWeatherForecastDataBroker weatherForecastDataBroker, AuthenticationStateProvider authenticationState, IAuthorizationService authorizationService)
{ 
    <span style="color:#569CD6;">this</span>.weatherForecastDataBroker = weatherForecastDataBroker;
    <span style="color:#569CD6;">this</span>.AuthenticationStateProvider = authenticationState;
    <span style="color:#569CD6;">this</span>.AuthorizationService = authorizationService;
}
</pre></div>
<p>And then use these in our CRUD methods:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">async</span> ValueTask AddRecord(WeatherForecast record)
{
    <span style="color:#569CD6;">this</span>.Message = <span style="color:#569CD6;">string</span>.Empty;
    <span style="color:#569CD6;">var</span> authstate = <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.AuthenticationStateProvider.GetAuthenticationStateAsync();
    <span style="color:#569CD6;">var</span> result = <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.AuthorizationService.AuthorizeAsync(authstate.User, <span style="color:#569CD6;">null</span>, AppPolicies.IsUserPolicy);
    <span style="color:#569CD6;">if</span> (result.Succeeded)
    {
        <span style="color:#569CD6;">await</span> weatherForecastDataBroker!.AddForecastAsync(record);
        <span style="color:#569CD6;">await</span> GetForecastsAsync();
    }
    <span style="color:#569CD6;">else</span>
        <span style="color:#569CD6;">this</span>.Message = <span style="color:#D69D85;">&quot;That Ain&#39;t Allowed!&quot;</span>;
}
</pre></div><h1 id="appendix">Appendix</h1>
<h2 id="authentication">Authentication</h2>
<p>This article uses a very simple authentication provider that allows quick switching of the authentication context.  There's no passwords involved!</p>
<h3 id="test-identities">Test Identities</h3>
<p>Step one is to provide some test identities.</p>
<p>First a class for our identities:</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> record TestIdentity
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">string</span> Name { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">string</span>.Empty;
    <span style="color:#569CD6;">public</span> Guid Id { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = Guid.Empty;
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">string</span> Role { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; } = <span style="color:#569CD6;">string</span>.Empty;

    <span style="color:#569CD6;">public</span> Claim[] Claims
        =&gt; <span style="color:#569CD6;">new</span>[]{
            <span style="color:#569CD6;">new</span> Claim(ClaimTypes.Sid, <span style="color:#569CD6;">this</span>.Id.ToString()),
            <span style="color:#569CD6;">new</span> Claim(ClaimTypes.Name, <span style="color:#569CD6;">this</span>.Name),
            <span style="color:#569CD6;">new</span> Claim(ClaimTypes.Role, <span style="color:#569CD6;">this</span>.Role)
    };
}
</pre></div>
<p>The identities are held in a static class used throughout the application.</p>
<ol>
<li>The primary method is <code>GetIdentity</code>.  Pass in a user name and get back a <code>ClaimsIdentity</code> object.</li>
<li>The Guids used are simple made up ones: easy to reproduce in test weather records.</li>
<li>A role is set for each identity.</li>
</ol>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> <span style="color:#569CD6;">class</span> TestIdentities
{
    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">const</span> <span style="color:#569CD6;">string</span> Provider = <span style="color:#D69D85;">&quot;Dumb Provider&quot;</span>;

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> ClaimsIdentity GetIdentity(<span style="color:#569CD6;">string</span> userName)
    {
        <span style="color:#569CD6;">var</span> identity = identities.FirstOrDefault(item =&gt; item.Name.Equals(userName, StringComparison.OrdinalIgnoreCase));
        <span style="color:#569CD6;">if</span> (identity == <span style="color:#569CD6;">null</span>)
            <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">new</span> ClaimsIdentity();

        <span style="color:#569CD6;">return</span> <span style="color:#569CD6;">new</span> ClaimsIdentity(identity.Claims, Provider);
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">static</span> List&lt;TestIdentity&gt; identities = <span style="color:#569CD6;">new</span> List&lt;TestIdentity&gt;()
        {
            Visitor1Identity, 
            Visitor2Identity, 
            User1Identity, 
            User2Identity, 
            Admin1Identity, 
            Admin2Identity
        };

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> List&lt;<span style="color:#569CD6;">string</span>&gt; GetTestIdentities()
    {
        <span style="color:#569CD6;">var</span> list = <span style="color:#569CD6;">new</span> List&lt;<span style="color:#569CD6;">string</span>&gt; { <span style="color:#D69D85;">&quot;None&quot;</span> };
        list.AddRange(identities.Select(identity =&gt; identity.Name!).ToList());
        <span style="color:#569CD6;">return</span> list;
    }

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> Dictionary&lt;Guid, <span style="color:#569CD6;">string</span>&gt; TestIdentitiesDictionary()
    {
        <span style="color:#569CD6;">var</span> list = <span style="color:#569CD6;">new</span> Dictionary&lt;Guid, <span style="color:#569CD6;">string</span>&gt;();
        identities.ForEach(identity =&gt; list.Add(identity.Id, identity.Name));
        <span style="color:#569CD6;">return</span> list;
    }

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> TestIdentity User1Identity
        =&gt; <span style="color:#569CD6;">new</span> TestIdentity
        {
            Id = <span style="color:#569CD6;">new</span> Guid(<span style="color:#D69D85;">&quot;10000000-0000-0000-0000-100000000001&quot;</span>),
            Name = <span style="color:#D69D85;">&quot;User-1&quot;</span>,
            Role = <span style="color:#D69D85;">&quot;UserRole&quot;</span>
        };

\\ .... more identities

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> TestIdentity Admin2Identity
        =&gt; <span style="color:#569CD6;">new</span> TestIdentity
        {
            Id = <span style="color:#569CD6;">new</span> Guid(<span style="color:#D69D85;">&quot;10000000-0000-0000-0000-300000000002&quot;</span>),
            Name = <span style="color:#D69D85;">&quot;Admin-2&quot;</span>,
            Role = <span style="color:#D69D85;">&quot;AdminRole&quot;</span>
        };
}
</pre></div>
<p>The <code>AuthenticationStateProvider</code> looks like this.  <code>ChangeIdentityAsync</code> switches users based on the provided user name.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">class</span> VerySimpleAuthenticationStateProvider : AuthenticationStateProvider
{
    ClaimsPrincipal? _user;

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">override</span> Task&lt;AuthenticationState&gt; GetAuthenticationStateAsync()
        =&gt; Task.FromResult(<span style="color:#569CD6;">new</span> AuthenticationState(_user ?? <span style="color:#569CD6;">new</span> ClaimsPrincipal()));

    <span style="color:#569CD6;">public</span> Task&lt;AuthenticationState&gt; ChangeIdentityAsync(<span style="color:#569CD6;">string</span> username)
    {
        _user = <span style="color:#569CD6;">new</span> ClaimsPrincipal(TestIdentities.GetIdentity(username));
        <span style="color:#569CD6;">var</span> task = <span style="color:#569CD6;">this</span>.GetAuthenticationStateAsync();
        <span style="color:#569CD6;">this</span>.NotifyAuthenticationStateChanged(task);
        <span style="color:#569CD6;">return</span> task;
    }
}
</pre></div>
<p>Finally the &quot;Log In Page&quot;.  In this case it's a simple select component in the top bar.  The select pulls the list of users from <code>TestIdentities</code> and calls <code>ChangeIdentityAsync</code> on the Authentication State Provider to switch users.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
@implements IDisposable
@<span style="color:#569CD6;">namespace</span> Blazr.Demo.Authorization.UI

&lt;span <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;me-2&quot;</span>&gt;Change User:&lt;/span&gt;
&lt;div <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;w-25&quot;</span>&gt;
    &lt;<span style="color:#569CD6;">select</span> id=<span style="color:#D69D85;">&quot;userselect&quot;</span> <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;form-control&quot;</span> @onchange=<span style="color:#D69D85;">&quot;ChangeUser&quot;</span>&gt;
        @<span style="color:#569CD6;">foreach</span> (<span style="color:#569CD6;">var</span> value <span style="color:#569CD6;">in</span> TestIdentities.GetTestIdentities())
        {
            @<span style="color:#569CD6;">if</span> (value == _currentUserName)
            {
                 &lt;option value=<span style="color:#D69D85;">&quot;@value&quot;</span> selected&gt;@value&lt;/option&gt;
            }
            <span style="color:#569CD6;">else</span>
            {
                &lt;option value=<span style="color:#D69D85;">&quot;@value&quot;</span>&gt;@value&lt;/option&gt;
            }
        }
    &lt;/<span style="color:#569CD6;">select</span>&gt;
&lt;/div&gt;
&lt;span <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;text-nowrap ms-3&quot;</span>&gt;
    &lt;AuthorizeView&gt;
        &lt;Authorized&gt;
            Hello, @(<span style="color:#569CD6;">this</span>.user.Identity?.Name ?? <span style="color:#569CD6;">string</span>.Empty)
        &lt;/Authorized&gt;
        &lt;NotAuthorized&gt;
            Not Logged In
        &lt;/NotAuthorized&gt;
    &lt;/AuthorizeView&gt;
&lt;/span&gt;

@code {
    [CascadingParameter] <span style="color:#569CD6;">private</span> Task&lt;AuthenticationState&gt;? authTask { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    <span style="color:#569CD6;">private</span> Task&lt;AuthenticationState&gt; AuthTask =&gt; authTask!;

    [Inject] <span style="color:#569CD6;">private</span> AuthenticationStateProvider? authState { <span style="color:#569CD6;">get</span>; <span style="color:#569CD6;">set</span>; }
    <span style="color:#569CD6;">private</span> VerySimpleAuthenticationStateProvider AuthState =&gt; (VerySimpleAuthenticationStateProvider)authState!;

    <span style="color:#569CD6;">private</span> ClaimsPrincipal user = <span style="color:#569CD6;">new</span> ClaimsPrincipal();
    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">string</span> _currentUserName = <span style="color:#D69D85;">&quot;None&quot;</span>;

    <span style="color:#569CD6;">protected</span> <span style="color:#569CD6;">async</span> <span style="color:#569CD6;">override</span> Task OnInitializedAsync()
    {
        <span style="color:#569CD6;">var</span> authState = <span style="color:#569CD6;">await</span> AuthTask;
        <span style="color:#569CD6;">this</span>.user = authState.User;
        AuthState.AuthenticationStateChanged += <span style="color:#569CD6;">this</span>.OnUserChanged;
    }

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">async</span> Task ChangeUser(ChangeEventArgs e)
        =&gt;  <span style="color:#569CD6;">await</span> AuthState.ChangeIdentityAsync(e.Value?.ToString() ?? <span style="color:#569CD6;">string</span>.Empty);

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">async</span> <span style="color:#569CD6;">void</span> OnUserChanged(Task&lt;AuthenticationState&gt; state)
        =&gt; <span style="color:#569CD6;">await</span> <span style="color:#569CD6;">this</span>.GetUser(state);

    <span style="color:#569CD6;">private</span> <span style="color:#569CD6;">async</span> Task GetUser(Task&lt;AuthenticationState&gt; state)
    {
        <span style="color:#569CD6;">var</span> authState = <span style="color:#569CD6;">await</span> state;
        <span style="color:#569CD6;">this</span>.user = authState.User;
    }

    <span style="color:#569CD6;">public</span> <span style="color:#569CD6;">void</span> Dispose()
        =&gt; AuthState.AuthenticationStateChanged -= <span style="color:#569CD6;">this</span>.OnUserChanged;
    }
</pre></div>
<p>The component is used in <code>MainLayout</code>.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
@<span style="color:#569CD6;">namespace</span> Blazr.Demo.Authorization.UI
@inherits LayoutComponentBase

&lt;PageTitle&gt;Blazr.Demo&lt;/PageTitle&gt;

&lt;div <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;page&quot;</span>&gt;
    &lt;div <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;sidebar&quot;</span>&gt;
        &lt;NavMenu /&gt;
    &lt;/div&gt;

    &lt;main&gt;
        &lt;div <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;top-row px-4&quot;</span>&gt;
            &lt;UserBar /&gt;
            &lt;a href=<span style="color:#D69D85;">&quot;https://docs.microsoft.com/aspnet/&quot;</span> target=<span style="color:#D69D85;">&quot;_blank&quot;</span>&gt;About&lt;/a&gt;
        &lt;/div&gt;

        &lt;article <span style="color:#569CD6;">class</span>=<span style="color:#D69D85;">&quot;content px-4&quot;</span>&gt;
            @Body
        &lt;/article&gt;
    &lt;/main&gt;
&lt;/div&gt;
</pre></div>
<p>The control in action.</p>
<p><img src="./assets/Policy-Based-Authentication/User-Select.png" alt="User Select" /></p>
<h2 id="weather-forecast-ownership">Weather Forecast Ownership</h2>
<p>The <code>OwnerID</code> field is added to<code>WeatherForecast</code> and populated with either the <code>Visitor-1</code> or <code>Visitor-2</code> Guid.</p>
<div style="color:#DADADA;background-color:#1E1E1E;"><pre>
<span style="color:#569CD6;">public</span> <span style="color:#569CD6;">static</span> List&lt;WeatherForecast&gt; CreateTestForecasts(<span style="color:#569CD6;">int</span> count)
{
    <span style="color:#569CD6;">var</span> list = <span style="color:#569CD6;">new</span> List&lt;WeatherForecast&gt;();
    <span style="color:#569CD6;">var</span> rng = <span style="color:#569CD6;">new</span> Random();
    <span style="color:#569CD6;">for</span> (<span style="color:#569CD6;">var</span> i = <span style="color:#B5CEA8;">1</span>; i &lt;= count; i++)
    {
        <span style="color:#569CD6;">var</span> c = rng.Next(<span style="color:#B5CEA8;">1</span>, <span style="color:#B5CEA8;">3</span>);
        list.Add(<span style="color:#569CD6;">new</span> WeatherForecast
        {
            Id = Guid.NewGuid(),
            OwnerId = <span style="color:#569CD6;">new</span> Guid($<span style="color:#D69D85;">&quot;10000000-0000-0000-0000-20000000000{c}&quot;</span>),
            Date = DateTime.Now.AddDays(i),
            TemperatureC = rng.Next(-<span style="color:#B5CEA8;">20</span>, <span style="color:#B5CEA8;">55</span>),
            Summary = Summaries[rng.Next(Summaries.Length)]
        });
    }
    <span style="color:#569CD6;">return</span> list;
}
</pre></div></div></div></div></body></html>





